<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="凌迟" />



<meta name="description" content="了解了Mach-O的文件格式，肯定需要了解Mach-O的加载流程，既然要研究OSX，这就是必不可少的一步，那么通过阅读源码可以比较清晰的认识这一流程用户态在加载新的可执行文件时会有一种方式是通过exec*系列函数，所以我们先从exec*说起，由于exec*是都只是对系统调用execve()库的封装，所以我们先从一张流程图来看起">
<meta property="og:type" content="article">
<meta property="og:title" content="Mach-O加载流程">
<meta property="og:url" content="http://Hello-Sherlock.github.io/2017/01/04/six-Blog/index.html">
<meta property="og:site_name" content="凌迟">
<meta property="og:description" content="了解了Mach-O的文件格式，肯定需要了解Mach-O的加载流程，既然要研究OSX，这就是必不可少的一步，那么通过阅读源码可以比较清晰的认识这一流程用户态在加载新的可执行文件时会有一种方式是通过exec*系列函数，所以我们先从exec*说起，由于exec*是都只是对系统调用execve()库的封装，所以我们先从一张流程图来看起">
<meta property="og:image" content="http://oh5mz2415.bkt.clouddn.com/QQ20170304-185855@2x.jpg">
<meta property="og:updated_time" content="2017-03-04T11:22:36.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Mach-O加载流程">
<meta name="twitter:description" content="了解了Mach-O的文件格式，肯定需要了解Mach-O的加载流程，既然要研究OSX，这就是必不可少的一步，那么通过阅读源码可以比较清晰的认识这一流程用户态在加载新的可执行文件时会有一种方式是通过exec*系列函数，所以我们先从exec*说起，由于exec*是都只是对系统调用execve()库的封装，所以我们先从一张流程图来看起">
<meta name="twitter:image" content="http://oh5mz2415.bkt.clouddn.com/QQ20170304-185855@2x.jpg">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="凌迟" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="../../../../css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>Mach-O加载流程 | 凌迟</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>





    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?8f74892ee564e6b6c58c707f544c5d1c";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>


</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">凌迟</a></h1>
        </hgroup>

        
        <p class="header-subtitle">做好你自己</p>
        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="../../../../index.html">主页</a></li>
                        
                            <li><a href="../../../../archives/">所有文章</a></li>
                        
                            <li><a href="../../../../tags/">标签云</a></li>
                        
                            <li><a href="../../../../about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:hisherlock@icloud.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="https://github.com/Hello-Sherlock" title="GitHub"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/IPC/">IPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Mach/">Mach</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Mach-O/">Mach-O</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/OSX/">OSX</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/dyld/">dyld</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/iOS/">iOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/ptrace/">ptrace</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/tools/">tools</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/随笔/">随笔</a></li></ul>
                    </div>
                </section>
                
                
                

                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">好久不见,SherlockHolmes</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">凌迟</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">凌迟</a></h1>
            </hgroup>
            
            <p class="header-subtitle">做好你自己</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="../../../../index.html">主页</a></li>
                
                    <li><a href="../../../../archives/">所有文章</a></li>
                
                    <li><a href="../../../../tags/">标签云</a></li>
                
                    <li><a href="../../../../about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:hisherlock@icloud.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/Hello-Sherlock" title="GitHub"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap"><article id="post-six-Blog" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="" class="article-date">
      <time datetime="2017-01-04T11:06:49.000Z" itemprop="datePublished">2017-01-04</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Mach-O加载流程
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../../tags/Mach-O/">Mach-O</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../../tags/OSX/">OSX</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../../tags/dyld/">dyld</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>了解了<a href="https://hello-sherlock.github.io/2016/12/06/three-Blog/">Mach-O的文件格式</a>，肯定需要了解Mach-O的加载流程，既然要研究OSX，这就是必不可少的一步，那么通过阅读源码可以比较清晰的认识这一流程<br>用户态在加载新的可执行文件时会有一种方式是通过<code>exec*</code>系列函数，所以我们先从<code>exec*</code>说起，由于exec*是都只是对系统调用execve()库的封装，所以我们先从一张流程图来看起</p>
</blockquote>
<a id="more"></a>
<p><img src="http://oh5mz2415.bkt.clouddn.com/QQ20170304-185855@2x.jpg" alt="QQ20170304-185855@2x.jpg"></p>
<h3 id="1-1-mac-execve"><a href="#1-1-mac-execve" class="headerlink" title="1.1__mac_execve()"></a>1.1<code>__mac_execve()</code></h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span></div><div class="line">__mac_execve(proc_t p, <span class="class"><span class="keyword">struct</span> <span class="title">__mac_execve_args</span></span> *uap, int32_t *retval)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">char</span> *bufp = NULL; </div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">image_params</span></span> *imgp;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">	context.vc_thread = current_thread();</div><div class="line">	context.vc_ucred = kauth_cred_proc_ref(p);	<span class="comment">/* XXX must NOT be kauth_cred_get() */</span></div><div class="line"></div><div class="line">	<span class="comment">/* Allocate a big chunk for locals instead of using stack since these  </span></div><div class="line">	 * structures a pretty big.</div><div class="line">	 */</div><div class="line">	 <span class="comment">//申请一块内存用来存放imgp,vap,origavp的数据结构</span></div><div class="line">	MALLOC(bufp, <span class="keyword">char</span> *, (<span class="keyword">sizeof</span>(*imgp) + <span class="keyword">sizeof</span>(*vap) + <span class="keyword">sizeof</span>(*origvap)), M_TEMP, M_WAITOK | M_ZERO);</div><div class="line">	imgp = (<span class="class"><span class="keyword">struct</span> <span class="title">image_params</span></span> *) bufp;</div><div class="line">	<span class="keyword">if</span> (bufp == NULL) &#123;</div><div class="line">		error = ENOMEM;</div><div class="line">		goto exit_with_error;</div><div class="line">	&#125;</div><div class="line">	vap = (<span class="class"><span class="keyword">struct</span> <span class="title">vnode_attr</span></span> *) (bufp + <span class="keyword">sizeof</span>(*imgp));</div><div class="line">	origvap = (<span class="class"><span class="keyword">struct</span> <span class="title">vnode_attr</span></span> *) (bufp + <span class="keyword">sizeof</span>(*imgp) + <span class="keyword">sizeof</span>(*vap));</div><div class="line">	<span class="comment">//初始化imgp</span></div><div class="line">	<span class="comment">/* Initialize the common data in the image_params structure */</span></div><div class="line">	imgp-&gt;ip_user_fname = uap-&gt;fname;</div><div class="line">	imgp-&gt;ip_user_argv = uap-&gt;argp;</div><div class="line">	imgp-&gt;ip_user_envv = uap-&gt;envp;</div><div class="line">	imgp-&gt;ip_vattr = vap;</div><div class="line">	imgp-&gt;ip_origvattr = origvap;</div><div class="line">	imgp-&gt;ip_vfs_context = &amp;context;</div><div class="line">	imgp-&gt;ip_flags = (is_64 ? IMGPF_WAS_64BIT : IMGPF_NONE) | ((p-&gt;p_flag &amp; P_DISABLE_ASLR) ? IMGPF_DISABLE_ASLR : IMGPF_NONE);</div><div class="line">	imgp-&gt;ip_seg = (is_64 ? UIO_USERSPACE64 : UIO_USERSPACE32);</div><div class="line">	imgp-&gt;ip_mac_return = <span class="number">0</span>;</div><div class="line"></div><div class="line">	uthread = get_bsdthread_info(current_thread());</div><div class="line">	<span class="keyword">if</span> (uthread-&gt;uu_flag &amp; UT_VFORK) &#123;</div><div class="line">		imgp-&gt;ip_flags |= IMGPF_VFORK_EXEC;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">#<span class="keyword">if</span> CONFIG_MACF</div><div class="line">	<span class="keyword">if</span> (uap-&gt;mac_p != USER_ADDR_NULL) &#123;</div><div class="line">		error = mac_execve_enter(uap-&gt;mac_p, imgp);</div><div class="line">		<span class="keyword">if</span> (error) &#123;</div><div class="line">			kauth_cred_unref(&amp;context.vc_ucred);</div><div class="line">			goto exit_with_error;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">#endif</div><div class="line"><span class="comment">//执行image函数</span></div><div class="line">	error = exec_activate_image(imgp);</div><div class="line">	</div><div class="line"><span class="comment">//释放资源</span></div><div class="line">	kauth_cred_unref(&amp;context.vc_ucred);</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">	<span class="keyword">return</span>(error);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>主要加载镜像进行数据的初始化以及资源的相关操作，具体的家在流程在<code>exec_activate_image())</code>中</li>
</ul>
<h3 id="1-2exec-activate-image"><a href="#1-2exec-activate-image" class="headerlink" title="1.2exec_activate_image()"></a>1.2<code>exec_activate_image()</code></h3><figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">int</span></div><div class="line">exec_activate_image(struct image_params *imgp)</div><div class="line">&#123;</div><div class="line">	struct nameidata *ndp = <span class="keyword">NULL</span>;</div><div class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *excpath;</div><div class="line">	<span class="keyword">int</span> error;</div><div class="line">	<span class="keyword">int</span> resid;</div><div class="line">	<span class="keyword">int</span> once = <span class="number">1</span>;	<span class="comment">/* save SGUID-ness for interpreted files */</span></div><div class="line">	<span class="keyword">int</span> i;</div><div class="line">	<span class="keyword">int</span> itercount = <span class="number">0</span>;</div><div class="line">	proc_t p = vfs_context_proc(imgp-&gt;ip_vfs_context);</div><div class="line"></div><div class="line">	error = execargs_alloc(imgp);</div><div class="line">	<span class="keyword">if</span> (error)</div><div class="line">		<span class="keyword">goto</span> bad_notrans;</div><div class="line">	<span class="comment">//保存程序路径</span></div><div class="line">	error = exec_save_path(imgp, imgp-&gt;ip_user_fname, imgp-&gt;ip_seg, &amp;excpath);</div><div class="line">	<span class="keyword">if</span> (error) &#123;</div><div class="line">		<span class="keyword">goto</span> bad_notrans;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/* Use excpath, which contains the copyin-ed exec path */</span></div><div class="line">	DTRACE_PROC1(exec, uintptr_t, excpath);</div><div class="line"></div><div class="line">	MALLOC(ndp, struct nameidata *, sizeof(*ndp), M_TEMP, M_WAITOK | M_ZERO);</div><div class="line">	<span class="keyword">if</span> (ndp == <span class="keyword">NULL</span>) &#123;</div><div class="line">		error = ENOMEM;</div><div class="line">		<span class="keyword">goto</span> bad_notrans;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	NDINIT(ndp, LOOKUP, OP_LOOKUP, FOLLOW | LOCKLEAF | AUDITVNPATH1,</div><div class="line">		   UIO_SYSSPACE, CAST_USER_ADDR_T(excpath), imgp-&gt;ip_vfs_context);</div><div class="line"></div><div class="line">again:</div><div class="line">	error = namei(ndp);</div><div class="line">	<span class="keyword">if</span> (error)</div><div class="line">		<span class="keyword">goto</span> bad_notrans;</div><div class="line">	imgp-&gt;ip_ndp = ndp;	<span class="comment">/* successful namei(); call nameidone() later */</span></div><div class="line">	imgp-&gt;ip_vp = ndp-&gt;ni_vp;	<span class="comment">/* if set, need to vnode_put() at some point */</span></div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Before we start the transition from binary A to binary B, make</div><div class="line">	 * sure another thread hasn't started exiting the process.  We grab</div><div class="line">	 * the proc lock to check p_lflag initially, and the transition</div><div class="line">	 * mechanism ensures that the value doesn't change after we release</div><div class="line">	 * the lock.</div><div class="line">	 */</div><div class="line">	proc_lock(p);</div><div class="line">	<span class="keyword">if</span> (p-&gt;p_lflag &amp; P_LEXIT) &#123;</div><div class="line">		error = EDEADLK;</div><div class="line">		proc_unlock(p);</div><div class="line">		<span class="keyword">goto</span> bad_notrans;</div><div class="line">	&#125;</div><div class="line">	error = proc_transstart(p, <span class="number">1</span>, <span class="number">0</span>);</div><div class="line">	proc_unlock(p);</div><div class="line">	<span class="keyword">if</span> (error)</div><div class="line">		<span class="keyword">goto</span> bad_notrans;</div><div class="line"></div><div class="line">	error = exec_check_permissions(imgp);</div><div class="line">	<span class="keyword">if</span> (error)</div><div class="line">		<span class="keyword">goto</span> bad;</div><div class="line"></div><div class="line">	<span class="comment">/* Copy; avoid invocation of an interpreter overwriting the original */</span></div><div class="line">	<span class="keyword">if</span> (once) &#123;</div><div class="line">		once = <span class="number">0</span>;</div><div class="line">		*imgp-&gt;ip_origvattr = *imgp-&gt;ip_vattr;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	error = vn_rdwr(UIO_READ, imgp-&gt;ip_vp, imgp-&gt;ip_vdata, PAGE_SIZE, <span class="number">0</span>,</div><div class="line">			UIO_SYSSPACE, IO_NODELOCKED,</div><div class="line">			vfs_context_ucred(imgp-&gt;ip_vfs_context),</div><div class="line">			&amp;resid, vfs_context_proc(imgp-&gt;ip_vfs_context));</div><div class="line">	<span class="keyword">if</span> (error)</div><div class="line">		<span class="keyword">goto</span> bad;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (resid) &#123;</div><div class="line">		memset(imgp-&gt;ip_vdata + (PAGE_SIZE - resid), <span class="number">0x0</span>, resid);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">encapsulated_binary:</div><div class="line">	<span class="comment">/* Limit the number of iterations we will attempt on each binary */</span></div><div class="line">	<span class="keyword">if</span> (++itercount &gt; EAI_ITERLIMIT) &#123;</div><div class="line">	    	error = EBADEXEC;</div><div class="line">		<span class="keyword">goto</span> bad;</div><div class="line">	&#125;</div><div class="line">	error = <span class="number">-1</span>;</div><div class="line"><span class="comment">//遍历execsw来确定不同的加载函数</span></div><div class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; error == <span class="number">-1</span> &amp;&amp; execsw[i].ex_imgact != <span class="keyword">NULL</span>; i++) &#123;</div><div class="line"></div><div class="line">		error = (*execsw[i].ex_imgact)(imgp);</div><div class="line"></div><div class="line">		<span class="keyword">switch</span> (error) &#123;</div><div class="line">		<span class="comment">/* case -1: not claimed: continue */</span></div><div class="line">		<span class="keyword">case</span> <span class="number">-2</span>:		<span class="comment">/* Encapsulated binary, imgp-&gt;ip_XXX set for next iteration */</span></div><div class="line">			<span class="keyword">goto</span> encapsulated_binary;</div><div class="line">                   		<span class="keyword">case</span> <span class="number">-3</span>:		<span class="comment">/* Interpreter */</span></div><div class="line"><span class="comment">#if CONFIG_MACF</span></div><div class="line">			<span class="comment">/*</span></div><div class="line">			 * Copy the script label for later use. Note that</div><div class="line">			 * the label can be different when the script is</div><div class="line">			 * actually read by the interpreter.</div><div class="line">			 */</div><div class="line">			<span class="keyword">if</span> (imgp-&gt;ip_scriptlabelp)</div><div class="line">				mac_vnode_label_free(imgp-&gt;ip_scriptlabelp);</div><div class="line">			imgp-&gt;ip_scriptlabelp = mac_vnode_label_alloc();</div><div class="line">			<span class="keyword">if</span> (imgp-&gt;ip_scriptlabelp == <span class="keyword">NULL</span>) &#123;</div><div class="line">				error = ENOMEM;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">			mac_vnode_label_copy(imgp-&gt;ip_vp-&gt;v_label,</div><div class="line">					     imgp-&gt;ip_scriptlabelp);</div><div class="line"></div><div class="line">			<span class="comment">/*</span></div><div class="line">			 * Take a ref of the script vnode for later use.</div><div class="line">			 */</div><div class="line">			<span class="keyword">if</span> (imgp-&gt;ip_scriptvp)</div><div class="line">				vnode_put(imgp-&gt;ip_scriptvp);</div><div class="line">			<span class="keyword">if</span> (vnode_getwithref(imgp-&gt;ip_vp) == <span class="number">0</span>)</div><div class="line">				imgp-&gt;ip_scriptvp = imgp-&gt;ip_vp;</div><div class="line"><span class="comment">#endif</span></div><div class="line"></div><div class="line">			nameidone(ndp);</div><div class="line"></div><div class="line">			vnode_put(imgp-&gt;ip_vp);</div><div class="line">			imgp-&gt;ip_vp = <span class="keyword">NULL</span>;	<span class="comment">/* already put */</span></div><div class="line">			imgp-&gt;ip_ndp = <span class="keyword">NULL</span>; <span class="comment">/* already nameidone */</span></div><div class="line"></div><div class="line">			<span class="comment">/* Use excpath, which exec_shell_imgact reset to the interpreter */</span></div><div class="line">			NDINIT(ndp, LOOKUP, OP_LOOKUP, FOLLOW | LOCKLEAF,</div><div class="line">				   UIO_SYSSPACE, CAST_USER_ADDR_T(excpath), imgp-&gt;ip_vfs_context);</div><div class="line"></div><div class="line">			proc_transend(p, <span class="number">0</span>);</div><div class="line">			<span class="keyword">goto</span> again;</div><div class="line"></div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Call out to allow 3rd party notification of exec. </div><div class="line">	 * Ignore result of kauth_authorize_fileop call.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> (error == <span class="number">0</span> &amp;&amp; kauth_authorize_fileop_has_listeners()) &#123;</div><div class="line">		kauth_authorize_fileop(vfs_context_ucred(imgp-&gt;ip_vfs_context),</div><div class="line">					KAUTH_FILEOP_EXEC,</div><div class="line">					(uintptr_t)ndp-&gt;ni_vp, <span class="number">0</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (error == <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">/*</span></div><div class="line">		 * Reset atm context from task</div><div class="line">		 */</div><div class="line">		task_atm_reset(p-&gt;task);</div><div class="line"></div><div class="line">		<span class="comment">/*</span></div><div class="line">		 * Reset old bank context from task</div><div class="line">		 */</div><div class="line">		task_bank_reset(p-&gt;task);</div><div class="line">	&#125;</div><div class="line">bad:</div><div class="line">	proc_transend(p, <span class="number">0</span>);</div><div class="line"></div><div class="line">bad_notrans:</div><div class="line">	<span class="keyword">if</span> (imgp-&gt;ip_strings)</div><div class="line">		execargs_free(imgp);</div><div class="line">	<span class="keyword">if</span> (imgp-&gt;ip_ndp)</div><div class="line">		nameidone(imgp-&gt;ip_ndp);</div><div class="line">	<span class="keyword">if</span> (ndp)</div><div class="line">		FREE(ndp, M_TEMP);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> (error);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>exec_activate_image()完成了镜像加载的所有工作，主要是寻找可执行文件并把他们拷贝在内存中，通过遍历execsw，根据可执行文件的不同类型来确定不同的加载函数，从<code>if(error)</code>可以看出这些加载过程如果不是被终止就是完成在整个流程的加载</li>
</ul>
<h3 id="1-3-exec-mach-imgact"><a href="#1-3-exec-mach-imgact" class="headerlink" title="1.3 exec_mach_imgact"></a>1.3 <code>exec_mach_imgact</code></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> execsw &#123;</div><div class="line">	<span class="keyword">int</span> (*ex_imgact)(<span class="keyword">struct</span> image_params *);</div><div class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *ex_name;</div><div class="line">&#125; execsw[] = &#123;</div><div class="line">	&#123; exec_mach_imgact,		<span class="string">"Mach-o Binary"</span> &#125;,</div><div class="line">	&#123; exec_fat_imgact,		<span class="string">"Fat Binary"</span> &#125;,</div><div class="line">	&#123; exec_shell_imgact,		<span class="string">"Interpreter Script"</span> &#125;,</div><div class="line">	&#123; <span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>可以看出，OSX有三种可执行文件:</li>
</ul>
<ol>
<li>Mach-o由exec_mach_imgact处理</li>
<li>Fat Binary由exec_fat_imgact处理</li>
<li>Interpreter Script由exec_shell_imgact处理</li>
</ol>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div></pre></td><td class="code"><pre><div class="line">static int</div><div class="line">exec_mach_imgact(struct image_params *imgp)</div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="title">struct</span> mach_header *mach_header = (struct mach_header *)imgp-&gt;</span>ip_vdata;</div><div class="line">	<span class="function"><span class="title">proc_t</span>			p = vfs_context_proc(imgp-&gt;</span>ip_vfs_context);</div><div class="line">	int			error = <span class="number">0</span>;</div><div class="line">	task_t			task;</div><div class="line">	task_t			new_task = NULL; <span class="comment">/* protected by vfexec */</span></div><div class="line">	thread_t		thread;</div><div class="line">	struct uthread		*uthread;</div><div class="line">	vm_map_t old_map = VM_MAP_NULL;</div><div class="line">	vm_map_t map;</div><div class="line">	load_return_t		lret;</div><div class="line">	load_result_t		load_result;</div><div class="line">	struct _posix_spawnattr *psa = NULL;</div><div class="line">	<span class="function"><span class="title">int</span>			spawn = (imgp-&gt;</span>ip_flags &amp; IMGPF_SPAWN);</div><div class="line">	<span class="function"><span class="title">int</span>			vfexec = (imgp-&gt;</span>ip_flags &amp; IMGPF_VFORK_EXEC);</div><div class="line">	int			p_name_len;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * make sure it's a Mach-O 1.0 or Mach-O 2.0 binary; the difference</div><div class="line">	 * is a reserved field on the end, so for the most part, we can</div><div class="line">	 * treat them as if they were identical. Reverse-endian Mach-O</div><div class="line">	 * binaries are recognized but not compatible.</div><div class="line"> 	 */</div><div class="line"><span class="comment">//检测header中的magic来确定是否符合Mach-O的条件</span></div><div class="line">	<span class="function"><span class="title">if</span> ((mach_header-&gt;</span>magic == MH_CIGAM) ||</div><div class="line">	    (<span class="function"><span class="title">mach_header</span>-&gt;</span>magic == MH_CIGAM_64)) &#123;</div><div class="line">		error = EBADARCH;</div><div class="line">		goto bad;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="title">if</span> ((mach_header-&gt;</span>magic != MH_MAGIC) &amp;&amp;</div><div class="line">	    (<span class="function"><span class="title">mach_header</span>-&gt;</span>magic != MH_MAGIC_64)) &#123;</div><div class="line">		error = -<span class="number">1</span>;</div><div class="line">		goto bad;</div><div class="line">	&#125;</div><div class="line"><span class="comment">//检测header中的文件类型且必须为可执行文件</span></div><div class="line">	<span class="function"><span class="title">if</span> (mach_header-&gt;</span>filetype != MH_EXECUTE) &#123;</div><div class="line">		error = -<span class="number">1</span>;</div><div class="line">		goto bad;</div><div class="line">	&#125;</div><div class="line"><span class="comment">//检测Mach-O文件的CPU种类与版本</span></div><div class="line">	<span class="function"><span class="title">if</span> (imgp-&gt;</span>ip_origcputype != <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">/* Fat header previously had an idea about this thin file */</span></div><div class="line">		<span class="function"><span class="title">if</span> (imgp-&gt;</span><span class="function"><span class="title">ip_origcputype</span> != mach_header-&gt;</span>cputype ||</div><div class="line">			<span class="function"><span class="title">imgp</span>-&gt;</span><span class="function"><span class="title">ip_origcpusubtype</span> != mach_header-&gt;</span>cpusubtype) &#123;</div><div class="line">			error = EBADARCH;</div><div class="line">			goto bad;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span><span class="function"><span class="title">ip_origcputype</span> = mach_header-&gt;</span>cputype;</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span><span class="function"><span class="title">ip_origcpusubtype</span> = mach_header-&gt;</span>cpusubtype;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	task = current_task();</div><div class="line">	thread = current_thread();</div><div class="line">	uthread = get_bsdthread_info(thread);</div><div class="line"></div><div class="line">	<span class="function"><span class="title">if</span> ((mach_header-&gt;</span>cputype &amp; CPU_ARCH_ABI64) == CPU_ARCH_ABI64)</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span>ip_flags |= IMGPF_IS_64BIT;</div><div class="line"></div><div class="line">	<span class="comment">/* If posix_spawn binprefs exist, respect those prefs. */</span></div><div class="line">	<span class="function"><span class="title">psa</span> = (struct _posix_spawnattr *) imgp-&gt;</span>ip_px_sa;</div><div class="line">	<span class="function"><span class="title">if</span> (psa != NULL &amp;&amp; psa-&gt;</span>psa_binprefs[<span class="number">0</span>] != <span class="number">0</span>) &#123;</div><div class="line">		int pr = <span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span> (pr = <span class="number">0</span>; pr &lt; NBINPREFS; pr++) &#123;</div><div class="line">			<span class="function"><span class="title">cpu_type_t</span> pref = psa-&gt;</span>psa_binprefs[pr];</div><div class="line">			<span class="keyword">if</span> (pref == <span class="number">0</span>) &#123;</div><div class="line">				<span class="comment">/* No suitable arch in the pref list */</span></div><div class="line">				error = EBADARCH;</div><div class="line">				goto bad;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (pref == CPU_TYPE_ANY) &#123;</div><div class="line">				<span class="comment">/* Jump to regular grading */</span></div><div class="line">				goto grade;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="function"><span class="title">if</span> (pref == imgp-&gt;</span>ip_origcputype) &#123;</div><div class="line">				<span class="comment">/* We have a match! */</span></div><div class="line">				goto grade;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		error = EBADARCH;</div><div class="line">		goto bad;</div><div class="line">	&#125;</div><div class="line">grade:</div><div class="line">	<span class="function"><span class="title">if</span> (!grade_binary(imgp-&gt;</span><span class="function"><span class="title">ip_origcputype</span>, imgp-&gt;</span>ip_origcpusubtype &amp; ~CPU_SUBTYPE_MASK)) &#123;</div><div class="line">		error = EBADARCH;</div><div class="line">		goto bad;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/* Copy in arguments/environment from the old process */</span></div><div class="line">	error = exec_extract_strings(imgp);</div><div class="line">	<span class="keyword">if</span> (error)</div><div class="line">		goto bad;</div><div class="line"></div><div class="line">	error = exec_add_apple_strings(imgp);</div><div class="line">	<span class="keyword">if</span> (error)</div><div class="line">		goto bad;</div><div class="line"></div><div class="line">	AUDIT_ARG(<span class="function"><span class="title">argv</span>, imgp-&gt;</span><span class="function"><span class="title">ip_startargv</span>, imgp-&gt;</span>ip_argc, </div><div class="line">	    <span class="function"><span class="title">imgp</span>-&gt;</span><span class="function"><span class="title">ip_endargv</span> - imgp-&gt;</span>ip_startargv);</div><div class="line">	AUDIT_ARG(<span class="function"><span class="title">envv</span>, imgp-&gt;</span><span class="function"><span class="title">ip_endargv</span>, imgp-&gt;</span>ip_envc,</div><div class="line">	    <span class="function"><span class="title">imgp</span>-&gt;</span><span class="function"><span class="title">ip_endenvv</span> - imgp-&gt;</span>ip_endargv);</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * We are being called to activate an image subsequent to a vfork()</div><div class="line">	 * operation; in this case, we know that our task, thread, and</div><div class="line">	 * uthread are actually those of our parent, and our proc, which we</div><div class="line">	 * obtained indirectly from the image_params vfs_context_t, is the</div><div class="line">	 * new child process.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> (vfexec || spawn) &#123;</div><div class="line">		<span class="keyword">if</span> (vfexec) &#123;</div><div class="line">			<span class="function"><span class="title">imgp</span>-&gt;</span><span class="function"><span class="title">ip_new_thread</span> = fork_create_child(task, NULL, p, FALSE, (imgp-&gt;</span>ip_flags &amp; IMGPF_IS_64BIT));</div><div class="line">			<span class="function"><span class="title">if</span> (imgp-&gt;</span>ip_new_thread == NULL) &#123;</div><div class="line">				error = ENOMEM;</div><div class="line">				goto bad;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">/* reset local idea of thread, uthread, task */</span></div><div class="line">		<span class="function"><span class="title">thread</span> = imgp-&gt;</span>ip_new_thread;</div><div class="line">		uthread = get_bsdthread_info(thread);</div><div class="line">		task = new_task = get_threadtask(thread);</div><div class="line">		map = get_task_map(task);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		map = VM_MAP_NULL;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * We set these flags here; this is OK, since if we fail after</div><div class="line">	 * this point, we have already destroyed the parent process anyway.</div><div class="line">	 */</div><div class="line">	task_set_dyld_info(task, MACH_VM_MIN_ADDRESS, <span class="number">0</span>);</div><div class="line">	<span class="function"><span class="title">if</span> (imgp-&gt;</span>ip_flags &amp; IMGPF_IS_64BIT) &#123;</div><div class="line">		task_set_64bit(task, TRUE);</div><div class="line">		OSB<span class="function"><span class="title">itOrAtomic</span>(P_LP64, &amp;p-&gt;</span>p_flag);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		task_set_64bit(task, FALSE);</div><div class="line">		OSB<span class="function"><span class="title">itAndAtomic</span>(~((uint32_t)P_LP64), &amp;p-&gt;</span>p_flag);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 *	Load the Mach-O file.</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">NOTE:</span> An error after this point  indicates we have potentially</div><div class="line">	 * destroyed or overwritten some process state while attempting an</div><div class="line">	 * execve() following a vfork(), which is an unrecoverable condition.</div><div class="line">	 * We send the new process an immediate SIGKILL to avoid it executing</div><div class="line">	 * any instructions in the mutated address space. For true spawns,</div><div class="line">	 * this is not the case, and "too late" is still not too late to</div><div class="line">	 * return an error code to the parent process.</div><div class="line">	 */</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Actually load the image file we previously decided to load.</div><div class="line">	 */</div><div class="line"><span class="comment">//把Mach-O文件映射到内存中并调用load_machfile函数</span></div><div class="line">	lret = load_machfile(imgp, mach_header, thread, &amp;map, &amp;load_result);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (lret != LOAD_SUCCESS) &#123;</div><div class="line">		error = load_return_to_errno(lret);</div><div class="line">		goto badtoolate;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	proc_lock(p);</div><div class="line">	<span class="function"><span class="title">p</span>-&gt;</span><span class="function"><span class="title">p_cputype</span> = imgp-&gt;</span>ip_origcputype;</div><div class="line">	<span class="function"><span class="title">p</span>-&gt;</span><span class="function"><span class="title">p_cpusubtype</span> = imgp-&gt;</span>ip_origcpusubtype;</div><div class="line">	proc_unlock(p);</div><div class="line"></div><div class="line">	<span class="function"><span class="title">vm_map_set_user_wire_limit</span>(map, p-&gt;</span>p_rlimit[RLIMIT_MEMLOCK].rlim_cur);</div><div class="line"></div><div class="line">	<span class="comment">/* </span></div><div class="line">	 * Set code-signing flags if this binary is signed, or if parent has</div><div class="line">	 * requested them on exec.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> (load_result.csflags &amp; CS_VALID) &#123;</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span>ip_csflags |= load_result.csflags &amp; </div><div class="line">			(CS_VALID|</div><div class="line">			 CS_HARD|CS_KILL|CS_RESTRICT|CS_ENFORCEMENT|CS_REQUIRE_LV|CS_DYLD_PLATFORM|</div><div class="line">			 CS_EXEC_SET_HARD|CS_EXEC_SET_KILL|CS_EXEC_SET_ENFORCEMENT);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span>ip_csflags &amp;= ~CS_VALID;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="title">if</span> (p-&gt;</span>p_csflags &amp; CS_EXEC_SET_HARD)</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span>ip_csflags |= CS_HARD;</div><div class="line">	<span class="function"><span class="title">if</span> (p-&gt;</span>p_csflags &amp; CS_EXEC_SET_KILL)</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span>ip_csflags |= CS_KILL;</div><div class="line">	<span class="function"><span class="title">if</span> (p-&gt;</span>p_csflags &amp; CS_EXEC_SET_ENFORCEMENT)</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span>ip_csflags |= CS_ENFORCEMENT;</div><div class="line">	<span class="function"><span class="title">if</span> (p-&gt;</span>p_csflags &amp; CS_EXEC_SET_INSTALLER)</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span>ip_csflags |= CS_INSTALLER;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Set up the system reserved areas in the new address space.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="title">vm_map_exec</span>(map, task, (void *)p-&gt;</span><span class="function"><span class="title">p_fd</span>-&gt;</span>fd_rdir, cpu_type());</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Close file descriptors which specify close-on-exec.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="title">fdexec</span>(p, psa != NULL ? psa-&gt;</span>psa_flags : <span class="number">0</span>);</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * deal with set[ug]id.</div><div class="line">	 */</div><div class="line">	error = exec_handle_sugid(imgp);</div><div class="line">	<span class="keyword">if</span> (error) &#123;</div><div class="line">		<span class="keyword">if</span> (spawn || !vfexec) &#123;</div><div class="line">			vm_map_deallocate(map);</div><div class="line">		&#125;</div><div class="line">		goto badtoolate;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Commit to new map.</div><div class="line">	 *</div><div class="line">	 * Swap the new map for the old, which consumes our new map reference but</div><div class="line">	 * each leaves us responsible for the old_map reference.  That lets us get</div><div class="line">	 * off the pmap associated with it, and then we can release it.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> (!vfexec) &#123;</div><div class="line">		old_map = swap_task_map(task, thread, map, !spawn);</div><div class="line">		vm_map_deallocate(old_map);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	lret = activate_thread_state(thread, &amp;load_result);</div><div class="line">	<span class="keyword">if</span> (lret != KERN_SUCCESS) &#123;</div><div class="line">		goto badtoolate;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * deal with voucher on exec-calling thread.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="title">if</span> (imgp-&gt;</span>ip_new_thread == NULL)</div><div class="line">		thread_set_mach_voucher(current_thread(), IPC_VOUCHER_NULL);</div><div class="line"></div><div class="line">	<span class="comment">/* Make sure we won't interrupt ourself signalling a partial process */</span></div><div class="line">	<span class="function"><span class="title">if</span> (!vfexec &amp;&amp; !spawn &amp;&amp; (p-&gt;</span>p_lflag &amp; P_LTRACED))</div><div class="line">		psignal(p, SIGTRAP);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (load_result.unixproc &amp;&amp;</div><div class="line">		create_unix_stack(get_task_map(task),</div><div class="line">				  &amp;load_result,</div><div class="line">				  p) != KERN_SUCCESS) &#123;</div><div class="line">		error = load_return_to_errno(LOAD_NOSPACE);</div><div class="line">		goto badtoolate;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (vfexec || spawn) &#123;</div><div class="line">		old_map = vm_map_switch(get_task_map(task));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (load_result.unixproc) &#123;</div><div class="line">		user_addr_t	ap;</div><div class="line"></div><div class="line">		<span class="comment">/*</span></div><div class="line">		 * Copy the strings area out into the new process address</div><div class="line">		 * space.</div><div class="line">		 */</div><div class="line">		<span class="function"><span class="title">ap</span> = p-&gt;</span>user_stack;</div><div class="line">		error = exec_copyout_strings(imgp, &amp;ap);</div><div class="line">		<span class="keyword">if</span> (error) &#123;</div><div class="line">			<span class="keyword">if</span> (vfexec || spawn)</div><div class="line">				vm_map_switch(old_map);</div><div class="line">			goto badtoolate;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">/* Set the stack */</span></div><div class="line">		thread_setuserstack(thread, ap);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (load_result.dynlinker) &#123;</div><div class="line">		uint64_t	ap;</div><div class="line">		<span class="function"><span class="title">int</span>			new_ptr_size = (imgp-&gt;</span>ip_flags &amp; IMGPF_IS_64BIT) ? <span class="number">8</span> : <span class="number">4</span>;</div><div class="line"></div><div class="line">		<span class="comment">/* Adjust the stack */</span></div><div class="line">		ap = thread_adjuserstack(thread, -new_ptr_size);</div><div class="line">		error = copyoutptr(load_result.mach_header, ap, new_ptr_size);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (error) &#123;</div><div class="line">			<span class="keyword">if</span> (vfexec || spawn)</div><div class="line">				vm_map_switch(old_map);</div><div class="line">			goto badtoolate;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//由dyld接手接下来的工作</span></div><div class="line">		task_set_dyld_info(task, load_result.all_image_info_addr,</div><div class="line">		    load_result.all_image_info_size);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/* Avoid immediate VM faults back into kernel */</span></div><div class="line">	exec_prefault_data(p, imgp, &amp;load_result);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (vfexec || spawn) &#123;</div><div class="line">		vm_map_switch(old_map);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/* Stop profiling */</span></div><div class="line">	stopprofclock(p);</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Reset signal state.</div><div class="line">	 */</div><div class="line">	execsigs(p, thread);</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * need to cancel async IO requests that can be cancelled and wait for those</div><div class="line">	 * already active.  MAY BLOCK!</div><div class="line">	 */</div><div class="line">	_aio_exec( p );</div><div class="line"></div><div class="line">#<span class="keyword">if</span> SYSV_SHM</div><div class="line">	<span class="comment">/* <span class="doctag">FIXME:</span> Till vmspace inherit is fixed: */</span></div><div class="line">	<span class="function"><span class="title">if</span> (!vfexec &amp;&amp; p-&gt;</span>vm_shm)</div><div class="line">		shmexec(p);</div><div class="line">#endif</div><div class="line">#<span class="keyword">if</span> SYSV_SEM</div><div class="line">	<span class="comment">/* Clean up the semaphores */</span></div><div class="line">	semexit(p);</div><div class="line">#endif</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Remember file name for accounting.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="title">p</span>-&gt;</span>p_acflag &amp;= ~AFORK;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Set p-&gt;p_comm and p-&gt;p_name to the name passed to exec</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="title">p_name_len</span> = sizeof(p-&gt;</span>p_name) - <span class="number">1</span>;</div><div class="line">	<span class="function"><span class="title">if</span>(imgp-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span>ni_cnd.cn_namelen &gt; p_name_len)</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span>ni_cnd.cn_namelen = p_name_len;</div><div class="line">	<span class="function"><span class="title">bcopy</span>((caddr_t)imgp-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span><span class="function"><span class="title">ni_cnd</span>.cn_nameptr, (caddr_t)p-&gt;</span>p_name,</div><div class="line">		(<span class="function"><span class="title">unsigned</span>)imgp-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span>ni_cnd.cn_namelen);</div><div class="line">	<span class="function"><span class="title">p</span>-&gt;</span><span class="function"><span class="title">p_name</span>[imgp-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span>ni_cnd.cn_namelen] = <span class="string">'\0'</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="title">if</span> (imgp-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span>ni_cnd.cn_namelen &gt; MAXCOMLEN)</div><div class="line">		<span class="function"><span class="title">imgp</span>-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span>ni_cnd.cn_namelen = MAXCOMLEN;</div><div class="line">	<span class="function"><span class="title">bcopy</span>((caddr_t)imgp-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span><span class="function"><span class="title">ni_cnd</span>.cn_nameptr, (caddr_t)p-&gt;</span>p_comm,</div><div class="line">		(<span class="function"><span class="title">unsigned</span>)imgp-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span>ni_cnd.cn_namelen);</div><div class="line">	<span class="function"><span class="title">p</span>-&gt;</span><span class="function"><span class="title">p_comm</span>[imgp-&gt;</span><span class="function"><span class="title">ip_ndp</span>-&gt;</span>ni_cnd.cn_namelen] = <span class="string">'\0'</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="title">pal_dbg_set_task_name</span>( p-&gt;</span>task );</div><div class="line"></div><div class="line">#<span class="keyword">if</span> DEVELOPMENT || DEBUG</div><div class="line">	<span class="comment">/* </span></div><div class="line">	 * Update the pid an proc name for importance base if any</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="title">task_importance_update_owner_info</span>(p-&gt;</span>task);</div><div class="line">#endif</div><div class="line"></div><div class="line">	<span class="function"><span class="title">memcpy</span>(&amp;p-&gt;</span><span class="function"><span class="title">p_uuid</span>[0], &amp;load_result.uuid[0], sizeof(p-&gt;</span>p_uuid));</div><div class="line"></div><div class="line"><span class="comment">// &lt;rdar://6598155&gt; dtrace code cleanup needed</span></div><div class="line">#<span class="keyword">if</span> CONFIG_DTRACE</div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Invalidate any predicate evaluation already cached for this thread by DTrace.</div><div class="line">	 * That's because we've just stored to p_comm and DTrace refers to that when it</div><div class="line">	 * evaluates the "execname" special variable. uid and gid may have changed as well.</div><div class="line">	 */</div><div class="line">	dtrace_set_thread_predcache(current_thread(), <span class="number">0</span>);</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Free any outstanding lazy dof entries. It is imperative we</div><div class="line">	 * always call dtrace_lazy_dofs_destroy, rather than null check</div><div class="line">	 * and call if !NULL. If we NULL test, during lazy dof faulting</div><div class="line">	 * we can race with the faulting code and proceed from here to</div><div class="line">	 * beyond the helpers cleanup. The lazy dof faulting will then</div><div class="line">	 * install new helpers which no longer belong to this process!</div><div class="line">	 */</div><div class="line">	dtrace_lazy_dofs_destroy(p);</div><div class="line"></div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">    	 * Clean up any DTrace helpers for the process.</div><div class="line">    	 */</div><div class="line">    	<span class="function"><span class="title">if</span> (p-&gt;</span>p_dtrace_helpers != NULL &amp;&amp; dtrace_helpers_cleanup) &#123;</div><div class="line">    		(*dtrace_helpers_cleanup)(p);</div><div class="line">    	&#125;</div><div class="line">	</div><div class="line">    	<span class="comment">/*</span></div><div class="line">    	 * Cleanup the DTrace provider associated with this process.</div><div class="line">    	 */</div><div class="line">	proc_lock(p);</div><div class="line">	<span class="function"><span class="title">if</span> (p-&gt;</span>p_dtrace_probes &amp;&amp; dtrace_fasttrap_exec_ptr) &#123;</div><div class="line">		(*dtrace_fasttrap_exec_ptr)(p);</div><div class="line">	&#125;</div><div class="line">	proc_unlock(p);</div><div class="line">#endif</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (kdebug_enable) &#123;</div><div class="line">		long dbg_arg1, dbg_arg2, dbg_arg3, dbg_arg4;</div><div class="line"></div><div class="line">		<span class="comment">/*</span></div><div class="line">		 * Collect the pathname for tracing</div><div class="line">		 */</div><div class="line">		kdbg_trace_string(p, &amp;dbg_arg1, &amp;dbg_arg2, &amp;dbg_arg3, &amp;dbg_arg4);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (vfexec || spawn) &#123;</div><div class="line">			KERNEL_DEBUG_CONSTANT1(TRACE_DATA_EXEC | DBG_FUNC_NONE,</div><div class="line">					<span class="function"><span class="title">p</span>-&gt;</span>p_pid ,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>, (uintptr_t)thread_tid(thread));</div><div class="line">			KERNEL_DEBUG_CONSTANT1(TRACE_STRING_EXEC | DBG_FUNC_NONE,</div><div class="line">					dbg_arg1, dbg_arg2, dbg_arg3, dbg_arg4, (uintptr_t)thread_tid(thread));</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			KERNEL_DEBUG_CONSTANT(TRACE_DATA_EXEC | DBG_FUNC_NONE,</div><div class="line">					<span class="function"><span class="title">p</span>-&gt;</span>p_pid ,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</div><div class="line">			KERNEL_DEBUG_CONSTANT(TRACE_STRING_EXEC | DBG_FUNC_NONE,</div><div class="line">					dbg_arg1, dbg_arg2, dbg_arg3, dbg_arg4, <span class="number">0</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * If posix_spawned with the START_SUSPENDED flag, stop the</div><div class="line">	 * process before it runs.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="title">if</span> (imgp-&gt;</span>ip_px_sa != NULL) &#123;</div><div class="line">		<span class="function"><span class="title">psa</span> = (struct _posix_spawnattr *) imgp-&gt;</span>ip_px_sa;</div><div class="line">		<span class="function"><span class="title">if</span> (psa-&gt;</span>psa_flags &amp; POSIX_SPAWN_START_SUSPENDED) &#123;</div><div class="line">			proc_lock(p);</div><div class="line">			<span class="function"><span class="title">p</span>-&gt;</span>p_stat = SSTOP;</div><div class="line">			proc_unlock(p);</div><div class="line">			(<span class="function"><span class="title">void</span>) task_suspend_internal(p-&gt;</span>task);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * mark as execed, wakeup the process that vforked (if any) and tell</div><div class="line">	 * it that it now has its own resources back</div><div class="line">	 */</div><div class="line">	OSB<span class="function"><span class="title">itOrAtomic</span>(P_EXEC, &amp;p-&gt;</span>p_flag);</div><div class="line">	proc_resetregister(p);</div><div class="line">	<span class="function"><span class="title">if</span> (p-&gt;</span><span class="function"><span class="title">p_pptr</span> &amp;&amp; (p-&gt;</span>p_lflag &amp; P_LPPWAIT)) &#123;</div><div class="line">		proc_lock(p);</div><div class="line">		<span class="function"><span class="title">p</span>-&gt;</span>p_lflag &amp;= ~P_LPPWAIT;</div><div class="line">		proc_unlock(p);</div><div class="line">		<span class="function"><span class="title">wakeup</span>((caddr_t)p-&gt;</span>p_pptr);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Pay for our earlier safety; deliver the delayed signals from</div><div class="line">	 * the incomplete vfexec process now that it's complete.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="title">if</span> (vfexec &amp;&amp; (p-&gt;</span>p_lflag &amp; P_LTRACED)) &#123;</div><div class="line">		psignal_vfork(p, new_task, thread, SIGTRAP);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	goto done;</div><div class="line"></div><div class="line">badtoolate:</div><div class="line">	<span class="comment">/* Don't allow child process to execute any instructions */</span></div><div class="line">	<span class="keyword">if</span> (!spawn) &#123;</div><div class="line">		<span class="keyword">if</span> (vfexec) &#123;</div><div class="line">			psignal_vfork(p, new_task, thread, SIGKILL);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			psignal(p, SIGKILL);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">/* We can't stop this system call at this point, so just pretend we succeeded */</span></div><div class="line">		error = <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">done:</div><div class="line">	<span class="keyword">if</span> (!spawn) &#123;</div><div class="line">		<span class="comment">/* notify only if it has not failed due to FP Key error */</span></div><div class="line">		<span class="function"><span class="title">if</span> ((p-&gt;</span>p_lflag &amp; P_LTERM_DECRYPTFAIL) == <span class="number">0</span>)</div><div class="line">			proc_knote(p, NOTE_EXEC);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/* Drop extra references for cases where we don't expect the caller to clean up */</span></div><div class="line">	<span class="keyword">if</span> (vfexec || (spawn &amp;&amp; error == <span class="number">0</span>)) &#123;</div><div class="line">		task_deallocate(new_task);</div><div class="line">		thread_deallocate(thread);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (load_result.threadstate) &#123;</div><div class="line">		kfree(load_result.threadstate, load_result.threadstate_sz);</div><div class="line">		load_result.threadstate = NULL;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">bad:</div><div class="line">	return(error);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>这里主要对可执行文件的一些基本信息作了检测，如header，CPU，imgp等，然后把Mach-O文件映射到内存中，调用load_machfile()函数，由dyld加载</li>
</ul>
<h3 id="1-4-load-machfile"><a href="#1-4-load-machfile" class="headerlink" title="1.4 load_machfile"></a>1.4 <code>load_machfile</code></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">load_return_t</span></div><div class="line">load_machfile(</div><div class="line">	<span class="keyword">struct</span> image_params	*imgp,</div><div class="line">	<span class="keyword">struct</span> mach_header	*header,</div><div class="line">	<span class="keyword">thread_t</span> 		thread,</div><div class="line">	<span class="keyword">vm_map_t</span> 		*mapp,</div><div class="line">	<span class="keyword">load_result_t</span>		*result</div><div class="line">)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">struct</span> vnode		*vp = imgp-&gt;ip_vp;</div><div class="line">	<span class="keyword">off_t</span>			file_offset = imgp-&gt;ip_arch_offset;</div><div class="line">	<span class="keyword">off_t</span>			macho_size = imgp-&gt;ip_arch_size;</div><div class="line">	<span class="keyword">off_t</span>			file_size = imgp-&gt;ip_vattr-&gt;va_data_size;</div><div class="line">	<span class="keyword">vm_map_t</span>		new_map = *mapp;</div><div class="line">	<span class="keyword">pmap_t</span>			pmap = <span class="number">0</span>;	<span class="comment">/* protected by create_map */</span></div><div class="line">	<span class="keyword">vm_map_t</span>		<span class="built_in">map</span>;</div><div class="line">	<span class="keyword">load_result_t</span>		myresult;</div><div class="line">	<span class="keyword">load_return_t</span>		lret;</div><div class="line">	<span class="keyword">boolean_t</span> create_map = FALSE;</div><div class="line">	<span class="keyword">boolean_t</span> enforce_hard_pagezero = TRUE;</div><div class="line">	<span class="keyword">int</span> spawn = (imgp-&gt;ip_flags &amp; IMGPF_SPAWN);</div><div class="line">	<span class="keyword">task_t</span> task = current_task();</div><div class="line">	<span class="keyword">proc_t</span> p = current_proc();</div><div class="line">	<span class="keyword">mach_vm_offset_t</span>	aslr_offset = <span class="number">0</span>;</div><div class="line">	<span class="keyword">mach_vm_offset_t</span>	dyld_aslr_offset = <span class="number">0</span>;</div><div class="line">	<span class="keyword">kern_return_t</span> 		kret;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (macho_size &gt; file_size) &#123;</div><div class="line">		<span class="keyword">return</span>(LOAD_BADMACHO);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (new_map == VM_MAP_NULL) &#123;</div><div class="line">		create_map = TRUE;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * If we are spawning, we have created backing objects for the process</div><div class="line">	 * already, which include non-lazily creating the task map.  So we</div><div class="line">	 * are going to switch out the task map with one appropriate for the</div><div class="line">	 * bitness of the image being loaded.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> (spawn) &#123;</div><div class="line">		create_map = TRUE;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (create_map) &#123;</div><div class="line">		<span class="keyword">task_t</span> ledger_task;</div><div class="line">		<span class="keyword">if</span> (imgp-&gt;ip_new_thread) &#123;</div><div class="line">			ledger_task = get_threadtask(imgp-&gt;ip_new_thread);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			ledger_task = task;</div><div class="line">		&#125;</div><div class="line">		pmap = pmap_create(get_task_ledger(ledger_task),</div><div class="line">				   (<span class="keyword">vm_map_size_t</span>) <span class="number">0</span>,</div><div class="line">				   ((imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT) != <span class="number">0</span>));</div><div class="line">		pal_switch_pmap(thread, pmap, imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT);</div><div class="line">		<span class="built_in">map</span> = vm_map_create(pmap,</div><div class="line">				<span class="number">0</span>,</div><div class="line">				vm_compute_max_offset(((imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT) == IMGPF_IS_64BIT)),</div><div class="line">				TRUE);</div><div class="line">	&#125; <span class="keyword">else</span></div><div class="line">		<span class="built_in">map</span> = new_map;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span>   (__ARM_ARCH_7K__ &gt;= 2) &amp;&amp; defined(PLATFORM_WatchOS)</span></div><div class="line">	<span class="comment">/* enforce 16KB alignment for watch targets with new ABI */</span></div><div class="line">	vm_map_set_page_shift(<span class="built_in">map</span>, SIXTEENK_PAGE_SHIFT);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* __arm64__ */</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span>	CONFIG_ENFORCE_SIGNED_CODE</span></div><div class="line">	<span class="comment">/* This turns off faulting for executable pages, which allows</span></div><div class="line">	 * to circumvent Code Signing Enforcement. The per process</div><div class="line">	 * flag (CS_ENFORCEMENT) is not set yet, but we can use the</div><div class="line">	 * global flag.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> ( !cs_enforcement(<span class="literal">NULL</span>) &amp;&amp; (header-&gt;flags &amp; MH_ALLOW_STACK_EXECUTION) )</div><div class="line">	        vm_map_disable_NX(<span class="built_in">map</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">	<span class="comment">/* Forcibly disallow execution from data pages on even if the arch</span></div><div class="line">	 * normally permits it. */</div><div class="line">	<span class="comment">////将内存设置为不可执行，用来防止产生溢出漏洞</span></div><div class="line">	<span class="keyword">if</span> ((header-&gt;flags &amp; MH_NO_HEAP_EXECUTION) &amp;&amp; !(imgp-&gt;ip_flags &amp; IMGPF_ALLOW_DATA_EXEC))</div><div class="line">		vm_map_disallow_data_exec(<span class="built_in">map</span>);</div><div class="line">	</div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Compute a random offset for ASLR, and an independent random offset for dyld.</div><div class="line">	 */</div><div class="line">	<span class="comment">//计算ASLR的偏移量</span></div><div class="line">	<span class="keyword">if</span> (!(imgp-&gt;ip_flags &amp; IMGPF_DISABLE_ASLR)) &#123;</div><div class="line">		<span class="keyword">uint64_t</span> max_slide_pages;</div><div class="line"></div><div class="line">		max_slide_pages = vm_map_get_max_aslr_slide_pages(<span class="built_in">map</span>);</div><div class="line"></div><div class="line">		aslr_offset = random();</div><div class="line">		aslr_offset %= max_slide_pages;</div><div class="line">		aslr_offset &lt;&lt;= vm_map_page_shift(<span class="built_in">map</span>);</div><div class="line"></div><div class="line">		dyld_aslr_offset = random();</div><div class="line">		dyld_aslr_offset %= max_slide_pages;</div><div class="line">		dyld_aslr_offset &lt;&lt;= vm_map_page_shift(<span class="built_in">map</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">if</span> (!result)</div><div class="line">		result = &amp;myresult;</div><div class="line"></div><div class="line">	*result = load_result_null;</div><div class="line">	<span class="comment">//解析Mach-O文件</span></div><div class="line">	lret = parse_machfile(vp, <span class="built_in">map</span>, thread, header, file_offset, macho_size,</div><div class="line">	                      <span class="number">0</span>, (<span class="keyword">int64_t</span>)aslr_offset, (<span class="keyword">int64_t</span>)dyld_aslr_offset, result);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (lret != LOAD_SUCCESS) &#123;</div><div class="line">		<span class="keyword">if</span> (create_map) &#123;</div><div class="line">			vm_map_deallocate(<span class="built_in">map</span>);	<span class="comment">/* will lose pmap reference too */</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span>(lret);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> __x86_64__</span></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * On x86, for compatibility, don't enforce the hard page-zero restriction for 32-bit binaries.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> ((imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT) == <span class="number">0</span>) &#123;</div><div class="line">		enforce_hard_pagezero = FALSE;</div><div class="line">	&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Check to see if the page zero is enforced by the map-&gt;min_offset.</div><div class="line">	 */ </div><div class="line">	<span class="keyword">if</span> (enforce_hard_pagezero &amp;&amp;</div><div class="line">	    (vm_map_has_hard_pagezero(<span class="built_in">map</span>, <span class="number">0x1000</span>) == FALSE)) &#123;</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">if</span> (create_map) &#123;</div><div class="line">				vm_map_deallocate(<span class="built_in">map</span>);	<span class="comment">/* will lose pmap reference too */</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> (LOAD_BADMACHO);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (create_map) &#123;</div><div class="line">		<span class="comment">/*</span></div><div class="line">		 * If this is an exec, then we are going to destroy the old</div><div class="line">		 * task, and it's correct to halt it; if it's spawn, the</div><div class="line">		 * task is not yet running, and it makes no sense.</div><div class="line">		 */</div><div class="line">		<span class="keyword">if</span> (!spawn) &#123;</div><div class="line">			<span class="comment">/*</span></div><div class="line">			 * Mark the task as halting and start the other</div><div class="line">			 * threads towards terminating themselves.  Then</div><div class="line">			 * make sure any threads waiting for a process</div><div class="line">			 * transition get informed that we are committed to</div><div class="line">			 * this transition, and then finally complete the</div><div class="line">			 * task halting (wait for threads and then cleanup</div><div class="line">			 * task resources).</div><div class="line">			 *</div><div class="line">			 * <span class="doctag">NOTE:</span> task_start_halt() makes sure that no new</div><div class="line">			 * threads are created in the task during the transition.</div><div class="line">			 * We need to mark the workqueue as exiting before we</div><div class="line">			 * wait for threads to terminate (at the end of which</div><div class="line">			 * we no longer have a prohibition on thread creation).</div><div class="line">			 * </div><div class="line">			 * Finally, clean up any lingering workqueue data structures</div><div class="line">			 * that may have been left behind by the workqueue threads</div><div class="line">			 * as they exited (and then clean up the work queue itself).</div><div class="line">			 */</div><div class="line">			kret = task_start_halt(task);</div><div class="line">			<span class="keyword">if</span> (kret != KERN_SUCCESS) &#123;</div><div class="line">				vm_map_deallocate(<span class="built_in">map</span>);	<span class="comment">/* will lose pmap reference too */</span></div><div class="line">				<span class="keyword">return</span> (LOAD_FAILURE);</div><div class="line">			&#125;</div><div class="line">			proc_transcommit(p, <span class="number">0</span>);</div><div class="line">			workqueue_mark_exiting(p);</div><div class="line">			task_complete_halt(task);</div><div class="line">			workqueue_exit(p);</div><div class="line">			kqueue_dealloc(p-&gt;p_wqkqueue);</div><div class="line">			p-&gt;p_wqkqueue = <span class="literal">NULL</span>;</div><div class="line">		&#125;</div><div class="line">		*mapp = <span class="built_in">map</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span>(LOAD_SUCCESS);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> macho_printf = <span class="number">0</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MACHO_PRINTF(args)				\</span></div><div class="line">	do &#123;						\</div><div class="line">		<span class="meta-keyword">if</span> (macho_printf) &#123;			\</div><div class="line">			printf args;			\</div><div class="line">		&#125;					\</div><div class="line">	&#125; while (0)</div></pre></td></tr></table></figure>
<ul>
<li>主要解析了Mach-O文件，设置内存不可执行，防止了产生溢出漏洞，还设置了ASLR偏移</li>
</ul>
<h3 id="1-5-parse-machfile"><a href="#1-5-parse-machfile" class="headerlink" title="1.5 parse_machfile"></a>1.5 <code>parse_machfile</code></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span></span></div><div class="line">load_return_t</div><div class="line"><span class="title">parse_machfile</span><span class="params">(</span></div><div class="line">	<span class="keyword">struct</span> vnode 		*vp,       </div><div class="line">	<span class="keyword">vm_map_t</span>		<span class="built_in">map</span>,</div><div class="line">	<span class="keyword">thread_t</span>		thread,</div><div class="line">	<span class="keyword">struct</span> mach_header	*header,</div><div class="line">	<span class="keyword">off_t</span>			file_offset,</div><div class="line">	<span class="keyword">off_t</span>			macho_size,</div><div class="line">	<span class="keyword">int</span>			depth,</div><div class="line">	<span class="keyword">int64_t</span>			aslr_offset,</div><div class="line">	<span class="keyword">int64_t</span>			dyld_aslr_offset,</div><div class="line">	<span class="keyword">load_result_t</span>		*result</div><div class="line">)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">uint32_t</span>		ncmds;</div><div class="line">	<span class="keyword">struct</span> load_command	*lcp;</div><div class="line">	<span class="keyword">struct</span> dylinker_command	*dlp = <span class="number">0</span>;</div><div class="line">	<span class="keyword">integer_t</span>		dlarchbits = <span class="number">0</span>;</div><div class="line">	<span class="keyword">void</span> *			control;</div><div class="line">	<span class="keyword">load_return_t</span>		ret = LOAD_SUCCESS;</div><div class="line">	<span class="keyword">caddr_t</span>			addr;</div><div class="line">	<span class="keyword">void</span> *			kl_addr;</div><div class="line">	<span class="keyword">vm_size_t</span>		size,kl_size;</div><div class="line">	<span class="keyword">size_t</span>			offset;</div><div class="line">	<span class="keyword">size_t</span>			oldoffset;	<span class="comment">/* for overflow check */</span></div><div class="line">	<span class="keyword">int</span>			pass;</div><div class="line">	<span class="keyword">proc_t</span>			p = current_proc();		<span class="comment">/* XXXX */</span></div><div class="line">	<span class="keyword">int</span>			error;</div><div class="line">	<span class="keyword">int</span> 			resid = <span class="number">0</span>;</div><div class="line">	<span class="keyword">size_t</span>			mach_header_sz = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mach_header);</div><div class="line">	<span class="keyword">boolean_t</span>		abi64;</div><div class="line">	<span class="keyword">boolean_t</span>		got_code_signatures = FALSE;</div><div class="line">	<span class="keyword">int64_t</span>			slide = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (header-&gt;magic == MH_MAGIC_64 ||</div><div class="line">	    header-&gt;magic == MH_CIGAM_64) &#123;</div><div class="line">	    	mach_header_sz = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mach_header_64);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 *	Break infinite recursion</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> (depth &gt; <span class="number">1</span>) &#123;</div><div class="line">		<span class="keyword">return</span>(LOAD_FAILURE);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	depth++;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 *	Check to see if right machine type.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> (((<span class="keyword">cpu_type_t</span>)(header-&gt;cputype &amp; ~CPU_ARCH_MASK) != (cpu_type() &amp; ~CPU_ARCH_MASK)) ||</div><div class="line">	    !grade_binary(header-&gt;cputype, </div><div class="line">	    	header-&gt;cpusubtype &amp; ~CPU_SUBTYPE_MASK))</div><div class="line">		<span class="keyword">return</span>(LOAD_BADARCH);</div><div class="line">		</div><div class="line">	abi64 = ((header-&gt;cputype &amp; CPU_ARCH_ABI64) == CPU_ARCH_ABI64);</div><div class="line">		</div><div class="line">	<span class="keyword">switch</span> (header-&gt;filetype) &#123;</div><div class="line">	</div><div class="line">	<span class="keyword">case</span> MH_EXECUTE:</div><div class="line">		<span class="keyword">if</span> (depth != <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">return</span> (LOAD_FAILURE);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> MH_DYLINKER:</div><div class="line">		<span class="keyword">if</span> (depth != <span class="number">2</span>) &#123;</div><div class="line">			<span class="keyword">return</span> (LOAD_FAILURE);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">		</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> (LOAD_FAILURE);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 *	Get the pager for the file.</div><div class="line">	 */</div><div class="line">	control = ubc_getobject(vp, UBC_FLAGS_NONE);</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 *	Map portion that must be accessible directly into</div><div class="line">	 *	kernel's map.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> ((<span class="keyword">off_t</span>)(mach_header_sz + header-&gt;sizeofcmds) &gt; macho_size)</div><div class="line">		<span class="keyword">return</span>(LOAD_BADMACHO);</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 *	Round size of Mach-O commands up to page boundry.</div><div class="line">	 */</div><div class="line">	size = round_page(mach_header_sz + header-&gt;sizeofcmds);</div><div class="line">	<span class="keyword">if</span> (size &lt;= <span class="number">0</span>)</div><div class="line">		<span class="keyword">return</span>(LOAD_BADMACHO);</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Map the load commands into kernel memory.</div><div class="line">	 */</div><div class="line">	addr = <span class="number">0</span>;</div><div class="line">	kl_size = size;</div><div class="line">	kl_addr = kalloc(size);</div><div class="line">	addr = (<span class="keyword">caddr_t</span>)kl_addr;</div><div class="line">	<span class="keyword">if</span> (addr == <span class="literal">NULL</span>)</div><div class="line">		<span class="keyword">return</span>(LOAD_NOSPACE);</div><div class="line"></div><div class="line">	error = vn_rdwr(UIO_READ, vp, addr, size, file_offset,</div><div class="line">	    UIO_SYSSPACE, <span class="number">0</span>, kauth_cred_get(), &amp;resid, p);</div><div class="line">	<span class="keyword">if</span> (error) &#123;</div><div class="line">		<span class="keyword">if</span> (kl_addr)</div><div class="line">			kfree(kl_addr, kl_size);</div><div class="line">		<span class="keyword">return</span>(LOAD_IOERROR);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (resid) &#123;</div><div class="line">		<span class="comment">/* We must be able to read in as much as the mach_header indicated */</span></div><div class="line">		<span class="keyword">if</span> (kl_addr)</div><div class="line">			kfree(kl_addr, kl_size);</div><div class="line">		<span class="keyword">return</span>(LOAD_BADMACHO);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 *	For PIE and dyld, slide everything by the ASLR offset.</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> ((header-&gt;flags &amp; MH_PIE) || (header-&gt;filetype == MH_DYLINKER)) &#123;</div><div class="line">		slide = aslr_offset;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	 <span class="comment">/*</span></div><div class="line">	 *  Scan through the commands, processing each one as necessary.</div><div class="line">	 *  We parse in three passes through the headers:</div><div class="line">	 *  0: determine if TEXT and DATA boundary can be page-aligned</div><div class="line">	 *  1: thread state, uuid, code signature</div><div class="line">	 *  2: segments</div><div class="line">	 *  3: dyld, encryption, check entry point</div><div class="line">	 */</div><div class="line">	</div><div class="line">	<span class="keyword">for</span> (pass = <span class="number">0</span>; pass &lt;= <span class="number">3</span>; pass++) &#123;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (pass == <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">/* see if we need to adjust the slide to re-align... */</span></div><div class="line">			<span class="comment">/* no re-alignment needed on X86_64 or ARM32 kernel */</span></div><div class="line">			<span class="keyword">continue</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pass == <span class="number">1</span>) &#123;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">/*</span></div><div class="line">		 * Check that the entry point is contained in an executable segments</div><div class="line">		 */ </div><div class="line">		<span class="keyword">if</span> ((pass == <span class="number">3</span>) &amp;&amp; (!result-&gt;using_lcmain &amp;&amp; result-&gt;validentry == <span class="number">0</span>)) &#123;</div><div class="line">			thread_state_initialize(thread);</div><div class="line">			ret = LOAD_FAILURE;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">/*</span></div><div class="line">		 * Loop through each of the load_commands indicated by the</div><div class="line">		 * Mach-O header; if an absurd value is provided, we just</div><div class="line">		 * run off the end of the reserved section by incrementing</div><div class="line">		 * the offset too far, so we are implicitly fail-safe.</div><div class="line">		 */</div><div class="line">		offset = mach_header_sz;</div><div class="line">		ncmds = header-&gt;ncmds;</div><div class="line"></div><div class="line">		<span class="keyword">while</span> (ncmds--) &#123;</div><div class="line">			<span class="comment">/*</span></div><div class="line">			 *	Get a pointer to the command.</div><div class="line">			 */</div><div class="line">			lcp = (<span class="keyword">struct</span> load_command *)(addr + offset);</div><div class="line">			oldoffset = offset;</div><div class="line">			offset += lcp-&gt;cmdsize;</div><div class="line"></div><div class="line">			<span class="comment">/*</span></div><div class="line">			 * Perform prevalidation of the struct load_command</div><div class="line">			 * before we attempt to use its contents.  Invalid</div><div class="line">			 * values are ones which result in an overflow, or</div><div class="line">			 * which can not possibly be valid commands, or which</div><div class="line">			 * straddle or exist past the reserved section at the</div><div class="line">			 * start of the image.</div><div class="line">			 */</div><div class="line">			<span class="keyword">if</span> (oldoffset &gt; offset ||</div><div class="line">			    lcp-&gt;cmdsize &lt; <span class="keyword">sizeof</span>(<span class="keyword">struct</span> load_command) ||</div><div class="line">			    offset &gt; header-&gt;sizeofcmds + mach_header_sz) &#123;</div><div class="line">				ret = LOAD_BADMACHO;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">/*</span></div><div class="line">			 * Act on struct load_command's for which kernel</div><div class="line">			 * intervention is required.</div><div class="line">			 */</div><div class="line">			<span class="keyword">switch</span>(lcp-&gt;cmd) &#123;</div><div class="line">				<span class="comment">//加载segment的数据并映射到进程的内存空间中</span></div><div class="line">			<span class="keyword">case</span> LC_SEGMENT:</div><div class="line">				<span class="keyword">if</span> (pass == <span class="number">0</span>) &#123;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (pass != <span class="number">2</span>)</div><div class="line">					<span class="keyword">break</span>;</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (abi64) &#123;</div><div class="line">					<span class="comment">/*</span></div><div class="line">					 * Having an LC_SEGMENT command for the</div><div class="line">					 * wrong ABI is invalid &lt;rdar://problem/11021230&gt;</div><div class="line">					 */</div><div class="line">					ret = LOAD_BADMACHO;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				ret = load_segment(lcp,</div><div class="line">				                   header-&gt;filetype,</div><div class="line">				                   control,</div><div class="line">				                   file_offset,</div><div class="line">				                   macho_size,</div><div class="line">				                   vp,</div><div class="line">				                   <span class="built_in">map</span>,</div><div class="line">				                   slide,</div><div class="line">				                   result);</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">case</span> LC_SEGMENT_64:</div><div class="line">				<span class="keyword">if</span> (pass != <span class="number">2</span>)</div><div class="line">					<span class="keyword">break</span>;</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (!abi64) &#123;</div><div class="line">					<span class="comment">/*</span></div><div class="line">					 * Having an LC_SEGMENT_64 command for the</div><div class="line">					 * wrong ABI is invalid &lt;rdar://problem/11021230&gt;</div><div class="line">					 */</div><div class="line">					ret = LOAD_BADMACHO;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				ret = load_segment(lcp,</div><div class="line">				                   header-&gt;filetype,</div><div class="line">				                   control,</div><div class="line">				                   file_offset,</div><div class="line">				                   macho_size,</div><div class="line">				                   vp,</div><div class="line">				                   <span class="built_in">map</span>,</div><div class="line">				                   slide,</div><div class="line">				                   result);</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">				<span class="comment">//开一个Unix线程</span></div><div class="line">			<span class="keyword">case</span> LC_UNIXTHREAD:</div><div class="line">				<span class="keyword">if</span> (pass != <span class="number">1</span>)</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				ret = load_unixthread(</div><div class="line">						 (<span class="keyword">struct</span> thread_command *) lcp,</div><div class="line">						 thread,</div><div class="line">						 slide,</div><div class="line">						 result);</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">case</span> LC_MAIN:</div><div class="line">				<span class="keyword">if</span> (pass != <span class="number">1</span>)</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">if</span> (depth != <span class="number">1</span>)</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				ret = load_main(</div><div class="line">						 (<span class="keyword">struct</span> entry_point_command *) lcp,</div><div class="line">						 thread,</div><div class="line">						 slide,</div><div class="line">						 result);</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">				<span class="comment">//启动dyld</span></div><div class="line">			<span class="keyword">case</span> LC_LOAD_DYLINKER:</div><div class="line">				<span class="keyword">if</span> (pass != <span class="number">3</span>)</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">if</span> ((depth == <span class="number">1</span>) &amp;&amp; (dlp == <span class="number">0</span>)) &#123;</div><div class="line">					dlp = (<span class="keyword">struct</span> dylinker_command *)lcp;</div><div class="line">					dlarchbits = (header-&gt;cputype &amp; CPU_ARCH_MASK);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					ret = LOAD_FAILURE;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">				<span class="comment">//加载UUID</span></div><div class="line">			<span class="keyword">case</span> LC_UUID:</div><div class="line">				<span class="keyword">if</span> (pass == <span class="number">1</span> &amp;&amp; depth == <span class="number">1</span>) &#123;</div><div class="line">					ret = load_uuid((<span class="keyword">struct</span> uuid_command *) lcp,</div><div class="line">							(<span class="keyword">char</span> *)addr + mach_header_sz + header-&gt;sizeofcmds,</div><div class="line">							result);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">case</span> LC_CODE_SIGNATURE:</div><div class="line">				<span class="comment">/* CODE SIGNING */</span></div><div class="line">				<span class="keyword">if</span> (pass != <span class="number">1</span>)</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="comment">/* pager -&gt; uip -&gt;</span></div><div class="line">				   load signatures &amp; store in uip</div><div class="line">				   set VM object "signed_pages"</div><div class="line">				*/</div><div class="line">				ret = load_code_signature(</div><div class="line">					(<span class="keyword">struct</span> linkedit_data_command *) lcp,</div><div class="line">					vp,</div><div class="line">					file_offset,</div><div class="line">					macho_size,</div><div class="line">					header-&gt;cputype,</div><div class="line">					result);</div><div class="line">				<span class="keyword">if</span> (ret != LOAD_SUCCESS) &#123;</div><div class="line">					<span class="built_in">printf</span>(<span class="string">"proc %d: load code signature error %d "</span></div><div class="line">					       <span class="string">"for file \"%s\"\n"</span>,</div><div class="line">					       p-&gt;p_pid, ret, vp-&gt;v_name);</div><div class="line">					<span class="comment">/*</span></div><div class="line">					 * Allow injections to be ignored on devices w/o enforcement enabled</div><div class="line">					 */</div><div class="line">					<span class="keyword">if</span> (!cs_enforcement(<span class="literal">NULL</span>))</div><div class="line">					    ret = LOAD_SUCCESS; <span class="comment">/* ignore error */</span></div><div class="line"></div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					got_code_signatures = TRUE;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (got_code_signatures) &#123;</div><div class="line">					<span class="keyword">unsigned</span> tainted = CS_VALIDATE_TAINTED;</div><div class="line">					<span class="keyword">boolean_t</span> valid = FALSE;</div><div class="line">					<span class="keyword">struct</span> cs_blob *blobs;</div><div class="line">					<span class="keyword">vm_size_t</span> off = <span class="number">0</span>;</div><div class="line"></div><div class="line"></div><div class="line">					<span class="keyword">if</span> (cs_debug &gt; <span class="number">10</span>)</div><div class="line">						<span class="built_in">printf</span>(<span class="string">"validating initial pages of %s\n"</span>, vp-&gt;v_name);</div><div class="line">					blobs = ubc_get_cs_blobs(vp);</div><div class="line">					</div><div class="line">					<span class="keyword">while</span> (off &lt; size &amp;&amp; ret == LOAD_SUCCESS) &#123;</div><div class="line">					     tainted = CS_VALIDATE_TAINTED;</div><div class="line"></div><div class="line">					     valid = cs_validate_page(blobs,</div><div class="line">								      <span class="literal">NULL</span>,</div><div class="line">								      file_offset + off,</div><div class="line">								      addr + off,</div><div class="line">								      &amp;tainted);</div><div class="line">					     <span class="keyword">if</span> (!valid || (tainted &amp; CS_VALIDATE_TAINTED)) &#123;</div><div class="line">						     <span class="keyword">if</span> (cs_debug)</div><div class="line">							     <span class="built_in">printf</span>(<span class="string">"CODE SIGNING: %s[%d]: invalid initial page at offset %lld validated:%d tainted:%d csflags:0x%x\n"</span>, </div><div class="line">								    vp-&gt;v_name, p-&gt;p_pid, (<span class="keyword">long</span> <span class="keyword">long</span>)(file_offset + off), valid, tainted, result-&gt;csflags);</div><div class="line">						     <span class="keyword">if</span> (cs_enforcement(<span class="literal">NULL</span>) ||</div><div class="line">							 (result-&gt;csflags &amp; (CS_HARD|CS_KILL|CS_ENFORCEMENT))) &#123;</div><div class="line">							     ret = LOAD_FAILURE;</div><div class="line">						     &#125;</div><div class="line">						     result-&gt;csflags &amp;= ~CS_VALID;</div><div class="line">					     &#125;</div><div class="line">					     off += PAGE_SIZE;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="keyword">break</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_CODE_DECRYPTION</span></div><div class="line">			<span class="keyword">case</span> LC_ENCRYPTION_INFO:</div><div class="line">			<span class="keyword">case</span> LC_ENCRYPTION_INFO_64:</div><div class="line">				<span class="keyword">if</span> (pass != <span class="number">3</span>)</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				ret = set_code_unprotect(</div><div class="line">					(<span class="keyword">struct</span> encryption_info_command *) lcp,</div><div class="line">					addr, <span class="built_in">map</span>, slide, vp, file_offset,</div><div class="line">					header-&gt;cputype, header-&gt;cpusubtype);</div><div class="line">				<span class="keyword">if</span> (ret != LOAD_SUCCESS) &#123;</div><div class="line">					<span class="built_in">printf</span>(<span class="string">"proc %d: set_code_unprotect() error %d "</span></div><div class="line">					       <span class="string">"for file \"%s\"\n"</span>,</div><div class="line">					       p-&gt;p_pid, ret, vp-&gt;v_name);</div><div class="line">					<span class="comment">/* </span></div><div class="line">					 * Don't let the app run if it's </div><div class="line">					 * encrypted but we failed to set up the</div><div class="line">					 * decrypter. If the keys are missing it will</div><div class="line">					 * return LOAD_DECRYPTFAIL.</div><div class="line">					 */</div><div class="line">					 <span class="keyword">if</span> (ret == LOAD_DECRYPTFAIL) &#123;</div><div class="line">						<span class="comment">/* failed to load due to missing FP keys */</span></div><div class="line">						proc_lock(p);</div><div class="line">						p-&gt;p_lflag |= P_LTERM_DECRYPTFAIL;</div><div class="line">						proc_unlock(p);</div><div class="line">					 &#125;</div><div class="line">					 psignal(p, SIGKILL);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">			<span class="keyword">default</span>:</div><div class="line">				<span class="comment">/* Other commands are ignored by the kernel */</span></div><div class="line">				ret = LOAD_SUCCESS;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (ret != LOAD_SUCCESS)</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (ret != LOAD_SUCCESS)</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (ret == LOAD_SUCCESS) &#123; </div><div class="line">		<span class="keyword">if</span> (! got_code_signatures) &#123;</div><div class="line">			<span class="keyword">if</span> (cs_enforcement(<span class="literal">NULL</span>)) &#123;</div><div class="line">				ret = LOAD_FAILURE;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">                               <span class="comment">/*</span></div><div class="line">                                * No embedded signatures: look for detached by taskgated,</div><div class="line">                                * this is only done on OSX, on embedded platforms we expect everything</div><div class="line">                                * to be have embedded signatures.</div><div class="line">                                */</div><div class="line">				<span class="keyword">struct</span> cs_blob *blob;</div><div class="line"></div><div class="line">				blob = ubc_cs_blob_get(vp, <span class="number">-1</span>, file_offset);</div><div class="line">				<span class="keyword">if</span> (blob != <span class="literal">NULL</span>) &#123;</div><div class="line">					<span class="keyword">unsigned</span> <span class="keyword">int</span> cs_flag_data = blob-&gt;csb_flags;</div><div class="line">					<span class="keyword">if</span>(<span class="number">0</span> != ubc_cs_generation_check(vp)) &#123;</div><div class="line">						<span class="keyword">if</span> (<span class="number">0</span> != ubc_cs_blob_revalidate(vp, blob, <span class="number">0</span>)) &#123;</div><div class="line">							<span class="comment">/* clear out the flag data if revalidation fails */</span></div><div class="line">							cs_flag_data = <span class="number">0</span>;</div><div class="line">							result-&gt;csflags &amp;= ~CS_VALID;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">					<span class="comment">/* get flags to be applied to the process */</span></div><div class="line">					result-&gt;csflags |= cs_flag_data;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div></pre></td></tr></table></figure>
<ul>
<li>根据load_command的不同，加载不同的函数</li>
</ul>
<blockquote>
<p>以上只是比较粗略的了解了Mach-O的加载流程，之后还需理解的更透彻，如有不足的地方还希望可以多多指正^_^<br>参考:</p>
<ul>
<li><a href="http://turingh.github.io/2016/03/30/OSX内核加载mach-o流程分析/#1-5_parse_machfile" target="_blank" rel="external">http://turingh.github.io/2016/03/30/OSX内核加载mach-o流程分析/#1-5_parse_machfile</a></li>
</ul>
</blockquote>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="">Mach-O加载流程</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">凌迟</a></p>
        <p><span>发布时间:</span>2017-01-04, 19:06:49</p>
        <p><span>最后更新:</span>2017-03-04, 19:22:36</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="" title="Mach-O加载流程">http://Hello-Sherlock.github.io/2017/01/04/six-Blog/</a>
            <span class="copy-path" data-clipboard-text="原文: http://Hello-Sherlock.github.io/2017/01/04/six-Blog/　　作者: 凌迟" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="../../../02/12/seven-BLOG/">
                    通过Cve-2016-1757浅谈Mach IPC
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="../../../../2016/12/20/five-Blog/">
                    某记账App内购破解
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-mac-execve"><span class="toc-number">1.</span> <span class="toc-text">1.1__mac_execve()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2exec-activate-image"><span class="toc-number">2.</span> <span class="toc-text">1.2exec_activate_image()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-exec-mach-imgact"><span class="toc-number">3.</span> <span class="toc-text">1.3 exec_mach_imgact</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-load-machfile"><span class="toc-number">4.</span> <span class="toc-text">1.4 load_machfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-parse-machfile"><span class="toc-number">5.</span> <span class="toc-text">1.5 parse_machfile</span></a></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"Mach-O加载流程　| 凌迟　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    
      <div class="duoshuo" id="comments">
    <div id="comment-box" ></div>
    <div class="ds-thread" id="ds-thread" data-thread-key="2017/01/04/six-Blog/" data-title="Mach-O加载流程" data-url="http://Hello-Sherlock.github.io"></div>
    <script>
        var duoshuoQuery = {short_name:"hello-sherlock"};
        var loadComment = function(){
            var d = document, s = d.createElement('script');
            s.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
            s.async = true; s.charset = 'UTF-8';
            (d.head || d.body).appendChild(s);
        }

        
    </script>
    
    <script> loadComment(); </script>

</div>
    




    <div class="scroll" id="post-nav-button">
        
            <a href="../../../02/12/seven-BLOG/" title="上一篇: 通过Cve-2016-1757浅谈Mach IPC">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="../../../../2016/12/20/five-Blog/" title="下一篇: 某记账App内购破解">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="../../../02/12/seven-BLOG/">通过Cve-2016-1757浅谈Mach IPC</a></li><li class="post-list-item"><a class="post-list-link" href="">Mach-O加载流程</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2016/12/20/five-Blog/">某记账App内购破解</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2016/12/15/four-Blog/">OSX内核调试</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2016/12/06/three-Blog/">Mach-O文件格式</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2016/12/01/two-Blog/">通过Debugserver&lldb来调试一个被加了ptrace反调试的app</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2016/11/24/one-Blog/">Introspy对iOS应用黑盒测试</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2016/11/24/hello-world/">第一篇博客</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2017 凌迟
            </div>
            <div class="footer-right">
                 Hello,SherlockHolmes <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

    <script>
        var originTitle = document.title;
        var titleTime;
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                document.title = "喂~" + originTitle;
                clearTimeout(titleTime);
            }
            else {
                document.title = "(*´∇｀*) 嘻嘻~ " + originTitle;
                titleTime = setTimeout(function() {
                    document.title = originTitle;
                }, 2000);
            }
        })
    </script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>