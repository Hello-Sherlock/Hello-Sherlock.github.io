<!DOCTYPE html>
<html lang="zh">
    <head>
    <!-- 
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.0 -->

    <!-- Title -->
    
    <title>
        
            某记账App内购破解 | 
        
        Hello-Sherlock
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Meta & Info -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="凌迟">
    <meta name="description" content="null">
    <meta name="keywords" content="null,iOS">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Hello-Sherlock">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://Hello-Sherlock.github.io">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="某记账App内购破解 | Hello-Sherlock">
    <meta property="og:description" content="null">
    <meta property="og:article:tag" content="iOS"> 

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import CSS -->
    <link rel="stylesheet" href="../../../../css/material.min.css">
    <link rel="stylesheet" href="../../../../css/style.min.css">
    <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }
</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>



    <script src="../../../../js/jquery.min.js"></script>
    <script src="../../../../js/queue.js"></script>

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"../../../../css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    

    

    <!-- Bing Background -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-1分析源代码结构，并定位关键函数"><span class="post-toc-number">1.</span> <span class="post-toc-text">1.1分析源代码结构，并定位关键函数</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-1-1-首先使用dumpdecrypted砸壳"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">1.1.1 首先使用dumpdecrypted砸壳</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-1-2-class-dump获取-h头文件"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">1.1.2 class-dump获取.h头文件</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-1-3cycript打印视图层次"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">1.1.3cycript打印视图层次</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-1-4-debugserver-lldb动态调试确认关键函数"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">1.1.4 debugserver+lldb动态调试确认关键函数</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-2编写tweak"><span class="post-toc-number">2.</span> <span class="post-toc-text">1.2编写tweak</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-0关于防护措施杂谈"><span class="post-toc-number">3.</span> <span class="post-toc-text">2.0关于防护措施杂谈</span></a></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script>
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').css('background-image', 'url(' + '/img/random/material-' + randomNum + '.png' + ')');
</script>

        
    
            <p class="article-headline-p">
                某记账App内购破解
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>凌迟</strong>
        <span>12月 20, 2016</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    
        <button id="article-functions-qrcode-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
            <i class="material-icons" role="presentation">devices other</i>
            <span class="visuallyhidden">devices other</span>
        </button>
        <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-qrcode-button">
            <li class="mdl-menu__item">在其它设备中阅读本文章</li>
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAACzUlEQVR42u3aS3LbQAwFQN//0skBVKbfA+RENdNcsSiRYsMLGJ+vP1ceX9jY2NjY2NjY2Ngfyf6Kj9e7Xp/w3ZXnu16v/wCYvTM2Njb20ezkZ/K7vvs0D1AevuKdsbGxsS9gJ0nl+TxJe5vUuEmE2NjY2NhtGZAH5TlAz8kJGxsbG3uTwPJGT16oPBct2NjY2Nj7plJ73oKfMf+tl4aNjY398ey2qPiE838638bGxsb+YHZ75KXIu4bESbqK3hwbGxv7UHaeGDbUfRLavCc2Njb22ex2paZdrHlb+hkt7mBjY2PfzP6N8iAZ5ebrPm24sbGxsU9lJ//uPz90tuLTjodnZRI2Njb2Pey2uZMv2eybRG2If3G+jY2Njf2R7Dyp5CVK0gDaj4fbcggbGxv7HnY7NsjLldnwIG8kDXtp2NjY2AexkwbQJv3M2kPvSmPY2NjYp7Lz9coNaT8S2BQ22NjY2Gez859sWz+zdclNm+mH69jY2NhHs9vFms2KZNIAygNdNJ6wsbGxj2bv2zftGHg/bEhCho2NjX0De7YW2Tb9Z2Pa9gk//GGwsbGxj2YnZcCmobN/5mzMgI2NjX0Dezay3SS89nw2SCgqMGxsbOwj2O0L7a+0g9vNSBgbGxv7BnYLzguANkG2zaNibIyNjY19KLtNA/uhwqw51Q6esbGxsW9jt8sx+1T33oWeqNTBxsbGvoCdN5L2gWibVrNvYmNjY2PPCo987SZJYLOGFDY2NvY97PbIAUnBs1nByYOOjY2NfTZ7lRJGq5az8LXpM2oqYWNjYx/ETpJWUpa0aa8tP9onY2NjY9/GnqWitjxoF31m7SRsbGxs7HaI267XzJZ+8kFFMRXBxsbGvpKdpKi80d9+Jx9jYGNjY9/Gbge3OXg4mo2Di42NjY09a9bMUl0+JJh989t7sbGxsQ9l33NgY2NjY2NjY2Njf8zxFzGEC20NnVESAAAAAElFTkSuQmCC">
        </ul>
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="../../../../tags/iOS/">iOS</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=某记账App内购破解&url=http://Hello-Sherlock.github.io/&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=某记账App内购破解&url=http://Hello-Sherlock.github.io/&via=凌迟" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://Hello-Sherlock.github.io/" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://Hello-Sherlock.github.io/" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    
        <a class="post_share-link" href="https://www.linkedin.com/shareArticle?mini=true&url=http://Hello-Sherlock.github.io/&title=某记账App内购破解" target="_blank">
            <li class="mdl-menu__item">
                分享到 LinkedIn
            </li>
        </a>
    

    <!-- Share QQ -->
    
        <a class="post_share-link" href="http://connect.qq.com/widget/shareqq/index.html?site=Hello-Sherlock&title=某记账App内购破解&summary=null&pics=http://Hello-Sherlock.github.io/img/favicon.png&url=http://Hello-Sherlock.github.io" target="_blank">
            <li class="mdl-menu__item">
                分享到 QQ
            </li>
        </a>
    

    <!-- Share Telegram -->
    
        <a class="post_share-link" href="https://telegram.me/share/url?url=http://Hello-Sherlock.github.io/&text=某记账App内购破解" target="_blank">
            <li class="mdl-menu__item">
                分享到 Telegram
            </li>
        </a>
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <blockquote>
<p>简介:此app名称为EasyCost，是笔者目前为止用过的用户界面相对友好的一款记账app，奈何用了很久之后才发现有个所谓的高级功能，咦，看到自动账单这个功能，很高级有木有，鉴于最近才转逆向，于是抱着研究的心态尝试破解，也希望对一些同时刚接触逆向的新手朋友一点点启发。</p>
</blockquote>
<a id="more"></a>
<p><img src="http://oh5mz2415.bkt.clouddn.com/IMG_2811.PNG" alt="IMG_2811.PNG"></p>
<h3 id="1-1分析源代码结构，并定位关键函数"><a href="#1-1分析源代码结构，并定位关键函数" class="headerlink" title="1.1分析源代码结构，并定位关键函数"></a>1.1分析源代码结构，并定位关键函数</h3><h4 id="1-1-1-首先使用dumpdecrypted砸壳"><a href="#1-1-1-首先使用dumpdecrypted砸壳" class="headerlink" title="1.1.1 首先使用dumpdecrypted砸壳"></a>1.1.1 首先使用dumpdecrypted砸壳</h4><ul>
<li>关于dumpdecrypted详细介绍在<a href="http://bbs.iosre.com/t/dumpdecrypted-app/22" target="_blank" rel="external">这里</a>就不再赘述了</li>
<li>首先ssh到越狱的手机，单独打开easycost，在终端执行<code>ps -e</code> 就可以看到当前app的进程名 </li>
</ul>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">linguochengde-iPhone:~ root<span class="meta"># ps -e</span></div><div class="line">PID TTY TIME CMD</div><div class="line"></div><div class="line"><span class="number">1</span> ?? <span class="number">0</span>:<span class="number">09.72</span> <span class="meta-keyword">/sbin/</span>launchd</div><div class="line"></div><div class="line"><span class="number">18</span> ?? <span class="number">0</span>:<span class="number">00.03</span> <span class="meta-keyword">/usr/</span>libexec/amfid</div><div class="line"></div><div class="line"><span class="number">27</span> ?? <span class="number">0</span>:<span class="number">11.42</span> <span class="meta-keyword">/usr/</span>sbin/syslogd -bsd_out <span class="number">1</span></div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line"><span class="number">1006</span> ?? <span class="number">0</span>:<span class="number">00.34</span> /System/Library/Frameworks/UIKit.framework/Support/pasteboardd</div><div class="line"></div><div class="line"><span class="number">1102</span> ?? <span class="number">0</span>:<span class="number">02.93</span> <span class="meta-keyword">/var/</span>mobile/Containers/Bundle/Application/<span class="number">7E51</span>DAF5<span class="number">-3</span>FCF<span class="number">-42</span>CF-B4CB-F47CC4078048/easycost.app/easycost</div><div class="line"></div><div class="line"><span class="number">1219</span> ?? <span class="number">0</span>:<span class="number">00.00</span> (bash)</div><div class="line"></div><div class="line"><span class="number">1220</span> ?? <span class="number">0</span>:<span class="number">00.28</span> (gssc)</div><div class="line"></div><div class="line"><span class="number">770</span> ttys000 <span class="number">0</span>:<span class="number">00.06</span> -sh</div><div class="line"></div><div class="line"><span class="number">810</span> ttys000 <span class="number">0</span>:<span class="number">00.30</span> cycript</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="number">1221</span> ttys000 <span class="number">0</span>:<span class="number">00.01</span> ps -e</div></pre></td></tr></table></figure>
<p>因为iOS上只打开了一个AppStore中的app，所以唯一的那个含有<code>/var/mobile/Containers/Bundle/Application/</code>字样的结果就是目标可执行文件的全路径。</p>
<p><code>Cycript -p 1102</code></p>
<h4 id="1-1-2-class-dump获取-h头文件"><a href="#1-1-2-class-dump获取-h头文件" class="headerlink" title="1.1.2 class-dump获取.h头文件"></a>1.1.2 class-dump获取.h头文件</h4><ul>
<li>在砸壳后文件的目录下，我们执行<code>class-dump --arch armv7 -S -s -H 可执行文件 -o 自定义的文件夹路径</code>，获得砸壳后的头文件</li>
</ul>
<h4 id="1-1-3cycript打印视图层次"><a href="#1-1-3cycript打印视图层次" class="headerlink" title="1.1.3cycript打印视图层次"></a>1.1.3cycript打印视图层次</h4><blockquote>
<p>Cycript是由saurik推出的一款脚本语言，更多资详细资料可以查看它的官网<a href="http://www.cycript.org" target="_blank" rel="external">http://www.cycript.org</a> ,可以从MTerminal中执行Cycript，也可以ssh到ios设备中执行Cycript</p>
</blockquote>
<p>我们首先根据之前介绍的方法向目标app注入Cycript</p>
<p> <img src="" alt=""></p>
<p>紧接着我们找到这个付费功能具体实现的界面，也就是在“周期记账”选项所在的界面中，输入</p>
<p><code>UIApp.keyWindow.recursiveDescription().toString()</code>打印当前的视图层次</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/FCEB9BAB-CD0C-43D4-B426-D06C898173B3.png" alt="FCEB9BAB-CD0C-43D4-B426-D06C898173B3.png"></p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/F9450BEC-1327-422A-ABB2-329261226707.png" alt="F9450BEC-1327-422A-ABB2-329261226707.png"></p>
<p>这里看到有好多东西，但是仔细一看，有一个KLSwitch,再看到前面“周期记账”的开关是一个UISwitch，于是我们先把注意力放在这个KLSwitch上面。</p>
<p>我们可以先根据这个KLSwitch，先找到他的controller，由于这里的switch是一个对象，而这个界面是一个view，所以我们可以通过nextResponder追溯到它的controller，然后再通过controller来响应这个switch，看看我们的猜想是否正确。</p>
<p>我们在class-dump中的头文件中搜索CatalogInfoViewController.h</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/9C4A794D-EA81-48A9-9CCC-B35A4732E574.png" alt="9C4A794D-EA81-48A9-9CCC-B35A4732E574.png"></p>
<p>找到这个cycleSwitch，猜想这个cycleSwitch应该比较特殊，可能是我们的目标，于是通过之前打印出来的controller来响应这个cycleSwitch，看看究竟会怎样</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/45C6EDA8-9524-40C6-AA3E-B30F13FF2595.png" alt="45C6EDA8-9524-40C6-AA3E-B30F13FF2595.png"></p>
<p>结果不出意料，在执行了<code>[#0x14d00820 cycleSwitch:YES]</code>之后，提醒购买的弹框弹了出来，这就初步确定了我们的目标函数</p>
<p>并且也确定了<code>CatalogInfoViewController</code>这个controller，在接下来的操作中我们将会用到</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/0968E158-257D-4297-9079-4E791557F421.png" alt="0968E158-257D-4297-9079-4E791557F421.png"></p>
<h4 id="1-1-4-debugserver-lldb动态调试确认关键函数"><a href="#1-1-4-debugserver-lldb动态调试确认关键函数" class="headerlink" title="1.1.4 debugserver+lldb动态调试确认关键函数"></a>1.1.4 debugserver+lldb动态调试确认关键函数</h4><p>接下来该我们该祭起debugserver和lldb了</p>
<blockquote>
<p>debugserver运行在iOS上，顾名思义，它作为服务端，实际执行LLDB（作为客户端）传过来的命令，再把执行结果反馈给LLDB，显示给用户，即所谓的“远程调试”。</p>
</blockquote>
<p><img src="http://oh5mz2415.bkt.clouddn.com/D107C0B6-4633-459D-8B45-9235708A3C43.png" alt="D107C0B6-4633-459D-8B45-9235708A3C43.png"></p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/A5D1E3ED-594C-443C-B2B5-92CE6F6FF86D.png" alt="A5D1E3ED-594C-443C-B2B5-92CE6F6FF86D.png"></p>
<p>然后通过命令<code>image list -o -f</code> 查看它的ASLR偏移 </p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/2B333515-BCE0-4FC8-90A8-669D05F9E078.png" alt="2B333515-BCE0-4FC8-90A8-669D05F9E078.png"></p>
<p>我们可以看出它的ASLR偏移为<code>0x0003c000</code></p>
<p>紧接着我们把之前砸壳的文件拖进hopper或ida，搜索前面得到的<code>CatalogInfoViewController</code> ，大致浏览一遍，可以看到有一个<code>[CatalogInfoViewController cycleSwitch]</code>这和我们之前的猜想不谋而合</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/33975B1D-E93E-4299-BC26-2A7CAB3E91C6.png" alt="33975B1D-E93E-4299-BC26-2A7CAB3E91C6.png"></p>
<p>这时候下面的一个<code>isPurchased</code> （购买）引起了我的注意，我想要看看这个isPurchased到底做了什么事情，究竟是不是我们猜想的那样，于是在函数开始时(0x0004fdf0)打断点,由于之前看到ASLR偏移为0x0003c000，所以要把他们相加才是函数偏移后的地址</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/ECAB072D-B5A4-49C6-AB59-BCA32DB944D0.png" alt="ECAB072D-B5A4-49C6-AB59-BCA32DB944D0.png"></p>
<p>进入到函数中后，一直使用<code>ni</code>命令，直到函数到这里 </p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/A9D9E77F-064B-412F-AC02-0B51AB3C0FC2.png" alt="A9D9E77F-064B-412F-AC02-0B51AB3C0FC2.png"></p>
<p>打印r0,发现参数为nil，我们来尝试着把r0的值改为1，然后我们发现这时候就可以使用我们的所谓“周期记账”的高级功能了，当然这还没完，现在这里只是确定目标函数以及参数，接下来我们就开始最关键也最必不可少的一步，就是用theos来编写tweak </p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/1506AF86-8E46-4436-9969-08F0A8432331.png" alt="1506AF86-8E46-4436-9969-08F0A8432331.png"></p>
<h3 id="1-2编写tweak"><a href="#1-2编写tweak" class="headerlink" title="1.2编写tweak"></a>1.2编写tweak</h3><p>我们首先在导出的头文件中查找isPurchased，找到Purchased.h文件</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/BBC752AF-F902-48FD-8911-290F35A0A589.png" alt="BBC752AF-F902-48FD-8911-290F35A0A589.png"></p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/0294818F-275B-43E2-ABA8-D8CA789D0754.png" alt="0294818F-275B-43E2-ABA8-D8CA789D0754.png"></p>
<p>然后我们看到@property(nonatomic,getter=isPurchased,setter=setPurchased:) BOOL purchased,我们把这个purchased永久返回1，应该就可以完成我们的任务了。</p>
<p>继续，新建工程，编辑makefil</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/QQ20161118-1@2x.png" alt="QQ20161118-1@2x.png"></p>
<p>然后继续编辑tweak</p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/QQ20161118-2@2x.png" alt="QQ20161118-2@2x.png"></p>
<p><img src="http://oh5mz2415.bkt.clouddn.com/QQ20161118-3@2x.png" alt="QQ20161118-3@2x.png"></p>
<p>打包编译安装到越狱手机，就可以看到我们可以使用所谓的高级功能了。</p>
<h3 id="2-0关于防护措施杂谈"><a href="#2-0关于防护措施杂谈" class="headerlink" title="2.0关于防护措施杂谈"></a>2.0关于防护措施杂谈</h3><p>俗话说得好，有攻就有防，ios安全防护措施虽说没有安卓这么多，但也有逐渐发展的趋势，小弟觉得首先一个原因可能是国内代码混淆技术没有普及，而且大多数app也只有核心功能才会被混淆，不然全文混淆的话运行过程中的内存加解密也是很大的开销。</p>
<p>关于防护措施，较为普遍的就是引入动态防护组件，个人觉得x维安全相对做的还不错，就目前来说绝大多数app连基本的反调试功能都没有，引入动态防护组件，可以一定程度上防止动态注入、动态调试，方法名类名混淆等，还有关于llvm的一些东西，如在IR层实现一些混淆逻辑，加入各种跳转各种无用逻辑但又不会影响原有的程序逻辑，具体可以参考<a href="https://github.com/obfuscator-llvm/obfuscator/" target="_blank" rel="external">https://github.com/obfuscator-llvm/obfuscator/</a>，不过挺久没维护了需要自己大动干戈折腾一番，对个人能力要求较高，而且IR层的混淆本身问题较多可能使app存在很多潜在的bug，并且在一定程度上可以被还原，所以只要能做到以上的一些，可以防止新手逆向，在一定程度上已经把很多人挡在了外面。ps：黑灰产朋友应该感谢微信没做防护措施。</p>
<p>除了这些当然还有其他方面的防护措施，随着计算机的发展安全也会越来越被重视，对ios逆向感兴趣推荐@大名狗剩的《ios应用逆向工程》以及论坛bbs.iosre.com，欢迎前来交流。</p>
<p><strong>小结</strong>：本文为这款记账软件制作了去除高级功能限制插件，让我们可以更全面的使用这款app，虽然最后的代码只有几行，但整个分析过程却是一环扣一环，哪怕其中一环出错不注意就会被误导，逆向这款app虽然说挺简单的，但主要思路差不多都是这样，希望能为正在学习并且自己对心仪的app无从下手的朋友提供一些帮助。</p>
<p>有些朋友觉得本文运气成分很大，没错，逆向工程不比app开发，没有官方文档作为参考，最有效的方式就是不断尝试，不断犯错，再不断改进，我们面对的总是一些未知的东西，或许你离成功只差一步，但却因为看不到前方，而走向一条更困难的路，我们在计算机的行业里只有不断探索，才有可能逐渐超越自我，小弟也是初学逆向，对自己说也对路上的朋友说，愿我们在探索的道路上一直勇敢下去。</p>

    

    
</div>


                

                <!-- Post Comments -->
                
                    




                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2017/01/04/six-Blog/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2016/12/15/four-Blog/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="凌迟's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        hisherlock@icloud.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/" target="_self">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="../../../../archives/2017/02/">二月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="../../../../archives/2017/01/">一月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="../../../../archives/2016/12/">十二月 2016<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="../../../../archives/2016/11/">十一月 2016<span class="sidebar_archives-count">2</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    
        <li>
            <a href="/about" title="关于我">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                关于我
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/Hello-Sherlock" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.png);">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;Hello-Sherlock
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->
<script src="../../../../js/lazyload.min.js"></script>
<script src="../../../../js/js.min.js"></script>
<script src="../../../../js/nprogress.js"></script>

<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- Swiftye -->


<!-- Local Search-->


<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->


                </main>
            </div>
        </body>
    
</html>
